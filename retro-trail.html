<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Building Retro</title>
<!-- 2013-05-05 Sun 09:30 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<meta name="author" content="michal"/>
<link rel="stylesheet" type="text/css" href="etc/style.css">

<script type="text/javascript" src="http://orgmode.org/org-info.js">
/**
 *
 * @source: http://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2013  Sebastian Rose
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Building Retro</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. OUTPUT <code>meta.rx</code></a></li>
<li><a href="#sec-2">2. OUTPUT <code>kernel.rx</code></a></li>
<li><a href="#sec-3">3. Building Retro</a></li>
<li><a href="#sec-4">4. <code>[8/11]</code> Stage 1: The Metacompiler</a>
<ul>
<li><a href="#sec-4-1">4.1. Introduction</a></li>
<li><a href="#sec-4-2">4.2. <code>IMAGE-SIZE</code></a></li>
<li><a href="#sec-4-3">4.3. variables</a></li>
<li><a href="#sec-4-4">4.4. allocate ram for new image</a></li>
<li><a href="#sec-4-5">4.5. target memory writer</a></li>
<li><a href="#sec-4-6">4.6. assembler</a>
<ul>
<li><a href="#sec-4-6-1">4.6.1. def vm:</a></li>
<li><a href="#sec-4-6-2">4.6.2. opcode assemblers</a></li>
</ul>
</li>
<li><a href="#sec-4-7">4.7. <code>[8/9]</code> metacompler words</a>
<ul>
<li><a href="#sec-4-7-1">4.7.1. def t-here</a></li>
<li><a href="#sec-4-7-2">4.7.2. def pad</a></li>
<li><a href="#sec-4-7-3">4.7.3. def endKernel</a></li>
<li><a href="#sec-4-7-4">4.7.4. def main:</a></li>
<li><a href="#sec-4-7-5">4.7.5. def label:</a></li>
<li><a href="#sec-4-7-6">4.7.6. def #</a></li>
<li><a href="#sec-4-7-7">4.7.7. def __#</a></li>
<li><a href="#sec-4-7-8">4.7.8. def $,</a></li>
<li><a href="#sec-4-7-9">4.7.9. def shrink</a></li>
</ul>
</li>
<li><a href="#sec-4-8">4.8. Metacompiler</a>
<ul>
<li><a href="#sec-4-8-1">4.8.1. def t: and i:  { t: is done, but add a note about i: }</a></li>
<li><a href="#sec-4-8-2">4.8.2. NOTE: the end-of-function marker</a></li>
<li><a href="#sec-4-8-3">4.8.3. def { =if &lt;if &gt;if !if then }</a></li>
<li><a href="#sec-4-8-4">4.8.4. def <code>jump:</code></a></li>
<li><a href="#sec-4-8-5">4.8.5. def <code>repeat</code> / <code>again</code></a></li>
<li><a href="#sec-4-8-6">4.8.6. tallot</a></li>
<li><a href="#sec-4-8-7">4.8.7. variable factories</a></li>
</ul>
</li>
<li><a href="#sec-4-9">4.9. <code>[3/6]</code> functions to build the initial dictionary</a>
<ul>
<li><a href="#sec-4-9-1">4.9.1. def entry word: data: { are these obsolete given p: w: m: ?  and where is macro ??}</a></li>
<li><a href="#sec-4-9-2">4.9.2. def p: w: m:</a></li>
<li><a href="#sec-4-9-3">4.9.3. def :doc</a></li>
<li><a href="#sec-4-9-4">4.9.4. def patch</a></li>
<li><a href="#sec-4-9-5">4.9.5. def mark</a></li>
<li><a href="#sec-4-9-6">4.9.6. def setClass</a></li>
</ul>
</li>
<li><a href="#sec-4-10">4.10. Image Relocator</a></li>
<li><a href="#sec-4-11">4.11. Avoid keymap issues</a></li>
<li><a href="#sec-4-12">4.12. Setup target memory for new image</a></li>
</ul>
</li>
<li><a href="#sec-5">5. <code>[3/14]</code> Stage 2: The Kernel</a>
<ul>
<li><a href="#sec-5-1">5.1. <code>[0/1]</code> Layout of the Image</a>
<ul>
<li><a href="#sec-5-1-1">5.1.1. <code>{ update this text to reflect the new situation for TIB }</code></a></li>
</ul>
</li>
<li><a href="#sec-5-2">5.2. <code>[2/4]</code> Initial Variables</a>
<ul>
<li><a href="#sec-5-2-1">5.2.1. <code>last</code> .. <code>which</code></a></li>
<li><a href="#sec-5-2-2">5.2.2. |memory fb fw fh cw ch</a></li>
<li><a href="#sec-5-2-3">5.2.3. copytag, version, build, okmsg</a></li>
<li><a href="#sec-5-2-4">5.2.4. call pad { i think this moved up to the top ?? }</a></li>
</ul>
</li>
<li><a href="#sec-5-3">5.3. DEF , <code>{ the heap writer }</code></a></li>
<li><a href="#sec-5-4">5.4. <code>[5/7]</code> classes</a>
<ul>
<li><a href="#sec-5-4-1">5.4.1. DEF withClass</a></li>
<li><a href="#sec-5-4-2">5.4.2. DEF .word</a></li>
<li><a href="#sec-5-4-3">5.4.3. DEF .macro</a></li>
<li><a href="#sec-5-4-4">5.4.4. DEF <code>.data</code></a></li>
<li><a href="#sec-5-4-5">5.4.5. DEF <code>.primitive</code></a></li>
<li><a href="#sec-5-4-6">5.4.6. classes for the words so far</a></li>
<li><a href="#sec-5-4-7">5.4.7. docs for the words so far <code>{ looks like these can be inlined&#x2026;? }</code></a></li>
</ul>
</li>
<li><a href="#sec-5-5">5.5. Primitives : <code>dup</code> .. <code>!+</code></a>
<ul>
<li><a href="#sec-5-5-1">5.5.1. .</a></li>
<li><a href="#sec-5-5-2">5.5.2. stack operations</a></li>
<li><a href="#sec-5-5-3">5.5.3. bitwise operations { also logical operations since true is -1 }</a></li>
<li><a href="#sec-5-5-4">5.5.4. memory operations</a></li>
<li><a href="#sec-5-5-5">5.5.5. arithmetic operations</a></li>
<li><a href="#sec-5-5-6">5.5.6. i/o operations</a></li>
</ul>
</li>
<li><a href="#sec-5-6">5.6. <code>[2/9]</code> Additional stack, variable, and math functions.</a>
<ul>
<li><a href="#sec-5-6-1">5.6.1. wait</a></li>
<li><a href="#sec-5-6-2">5.6.2. over</a></li>
<li><a href="#sec-5-6-3">5.6.3. not</a></li>
<li><a href="#sec-5-6-4">5.6.4. on</a></li>
<li><a href="#sec-5-6-5">5.6.5. off</a></li>
<li><a href="#sec-5-6-6">5.6.6. <code>/</code> and <code>mod</code></a></li>
<li><a href="#sec-5-6-7">5.6.7. negate</a></li>
<li><a href="#sec-5-6-8">5.6.8. do</a></li>
<li><a href="#sec-5-6-9">5.6.9. @+ / !+</a></li>
</ul>
</li>
<li><a href="#sec-5-7">5.7. Core Compiler: <code>here</code> .. <code>pop</code></a>
<ul>
<li><a href="#sec-5-7-1">5.7.1. | core compiler</a></li>
</ul>
</li>
<li><a href="#sec-5-8">5.8. Conditionals and Flow Control : <code>0;</code> .. <code>again</code></a>
<ul>
<li><a href="#sec-5-8-1">5.8.1. | conditionals / flow control</a></li>
</ul>
</li>
<li><a href="#sec-5-9">5.9. Console Output</a>
<ul>
<li><a href="#sec-5-9-1">5.9.1. DEF <code>update</code></a></li>
<li><a href="#sec-5-9-2">5.9.2. def redraw - puts</a></li>
</ul>
</li>
<li><a href="#sec-5-10">5.10. Console Input <code>break</code> / <code>keyXXX</code> .. <code>accept</code></a></li>
<li><a href="#sec-5-11">5.11. | console input</a>
<ul>
<li><a href="#sec-5-11-1">5.11.1. t: redraw (  -  ) update # @, 0; drop, #0 #3 out, ;</a></li>
<li><a href="#sec-5-11-2">5.11.2. t: putc   ( c-  ) 0; #1 #2 out, wait redraw ;</a></li>
<li><a href="#sec-5-11-3">5.11.3. t: cr     (  -  ) #10 putc ;</a></li>
<li><a href="#sec-5-11-4">5.11.4. t: (puts) ( a-a ) repeat @+ 0; putc again ;</a></li>
<li><a href="#sec-5-11-5">5.11.5. t: &lt;puts&gt; ( a-  ) (puts) drop, ;</a></li>
<li><a href="#sec-5-11-6">5.11.6. t: puts   ( a-  ) &lt;puts&gt; ;</a></li>
<li><a href="#sec-5-11-7">5.11.7. t: tib ( -a ) TIB # ;</a></li>
<li><a href="#sec-5-11-8">5.11.8. t: remapKeys ( c-c ) ;</a></li>
<li><a href="#sec-5-11-9">5.11.9. t: ws        ( c-c )</a></li>
<li><a href="#sec-5-11-10">5.11.10. t: &lt;getc&gt; (  -c ) #1 #1 out, wait #1 in, ;</a></li>
<li><a href="#sec-5-11-11">5.11.11. t: getc   (  -c ) repeat &lt;getc&gt; remapKeys dup #0 !if ws ; then drop, again ;</a></li>
<li><a href="#sec-5-11-12">5.11.12. t: putc?  ( n-n ) dup, #8 =if drop, break # @, ; then dup, putc ;</a></li>
<li><a href="#sec-5-11-13">5.11.13. t: eat    ( a-a )</a></li>
<li><a href="#sec-5-11-14">5.11.14. t: guard? ( n-n ) dup, 1+, tib &lt;if drop, tib ; then #8 putc ;</a></li>
<li><a href="#sec-5-11-15">5.11.15. t: (accept) ( a-a )</a></li>
<li><a href="#sec-5-11-16">5.11.16. t: accept ( c- ) break # !, tib eat (accept) #0 swap, !+ drop, ;</a></li>
</ul>
</li>
<li><a href="#sec-5-12">5.12. <code>[7/8]</code> Colon Compiler :  <code>vector</code> .. <code>( .. )</code></a>
<ul>
<li><a href="#sec-5-12-1">5.12.1. VAR vector</a></li>
<li><a href="#sec-5-12-2">5.12.2. DEF { dictionary field accessors }</a></li>
<li><a href="#sec-5-12-3">5.12.3. DEF header</a></li>
<li><a href="#sec-5-12-4">5.12.4. DEF create</a></li>
<li><a href="#sec-5-12-5">5.12.5. DEF <code>:</code> { the "colon compiler" }</a></li>
<li><a href="#sec-5-12-6">5.12.6. DEF <code>[[</code></a></li>
<li><a href="#sec-5-12-7">5.12.7. DEF <code>]]</code></a></li>
<li><a href="#sec-5-12-8">5.12.8. MACRO ( { the comment-ignorer }</a></li>
</ul>
</li>
<li><a href="#sec-5-13">5.13. <code>[0/1]</code> Quotes : <code>quote</code> .. <code>[ .. ]</code></a>
<ul>
<li><a href="#sec-5-13-1">5.13.1. reference diagram</a></li>
<li><a href="#sec-5-13-2">5.13.2. def quote</a></li>
<li><a href="#sec-5-13-3">5.13.3. def [</a></li>
<li><a href="#sec-5-13-4">5.13.4. def ]</a></li>
</ul>
</li>
<li><a href="#sec-5-14">5.14. Combinators</a>
<ul>
<li><a href="#sec-5-14-1">5.14.1. { empty }</a></li>
<li><a href="#sec-5-14-2">5.14.2. t: dip      (  nq-n   ) swap, push, do pop, ;</a></li>
<li><a href="#sec-5-14-3">5.14.3. if / ifTrue / ifFalse</a></li>
<li><a href="#sec-5-14-4">5.14.4. DEF <code>dip</code></a></li>
<li><a href="#sec-5-14-5">5.14.5. DEF <code>sip</code></a></li>
</ul>
</li>
<li><a href="#sec-5-15">5.15. Boolean constants and Relational Operators</a>
<ul>
<li><a href="#sec-5-15-1">5.15.1. true and false</a></li>
<li><a href="#sec-5-15-2">5.15.2. def ==</a></li>
<li><a href="#sec-5-15-3">5.15.3. def !=</a></li>
<li><a href="#sec-5-15-4">5.15.4. def comparisons</a></li>
</ul>
</li>
<li><a href="#sec-5-16">5.16. <code>[4/6]</code> Strings</a>
<ul>
<li><a href="#sec-5-16-1">5.16.1. def <code>compare</code></a></li>
<li><a href="#sec-5-16-2">5.16.2. def <code>getLength</code> / <code>withLength</code></a></li>
<li><a href="#sec-5-16-3">5.16.3. def <code>string</code>, <code>keepString</code></a></li>
<li><a href="#sec-5-16-4">5.16.4. <code>{ keepString commentary - seems to be outdated }</code></a></li>
<li><a href="#sec-5-16-5">5.16.5. def <code>atib</code>, <code>\quot</code></a></li>
<li><a href="#sec-5-16-6">5.16.6. :devector and :is  <code>{ move these! }</code></a></li>
</ul>
</li>
<li><a href="#sec-5-17">5.17. Number Parsing &amp; <del>Display</del>  <code>{what happened to the display?}</code></a>
<ul>
<li><a href="#sec-5-17-1">5.17.1. | number related variables</a></li>
<li><a href="#sec-5-17-2">5.17.2. DEF <code>nums</code></a></li>
<li><a href="#sec-5-17-3">5.17.3. | number parsing and display</a></li>
<li><a href="#sec-5-17-4">5.17.4. DEF toNumber</a></li>
<li><a href="#sec-5-17-5">5.17.5. DEF isNumber?</a></li>
</ul>
</li>
<li><a href="#sec-5-18">5.18. Startup : <code>boot</code> .. <code>run-on-boot</code></a>
<ul>
<li><a href="#sec-5-18-1">5.18.1. | startup</a></li>
</ul>
</li>
<li><a href="#sec-5-19">5.19. Dictionary Search</a>
<ul>
<li><a href="#sec-5-19-1">5.19.1. { helpers for <code>find</code> }</a></li>
<li><a href="#sec-5-19-2">5.19.2. DEF <code>find</code></a></li>
<li><a href="#sec-5-19-3">5.19.3. DEF ='=</a></li>
</ul>
</li>
<li><a href="#sec-5-20">5.20. <code>[1/4]</code> Word Prefixes and "Not Found"</a>
<ul>
<li><a href="#sec-5-20-1">5.20.1. Now to the word prefixes&#x2026;</a></li>
<li><a href="#sec-5-20-2">5.20.2. DEF get</a></li>
<li><a href="#sec-5-20-3">5.20.3. DEF xt:class</a></li>
<li><a href="#sec-5-20-4">5.20.4. DEF try</a></li>
<li><a href="#sec-5-20-5">5.20.5. DEF <code>notFound</code></a></li>
</ul>
</li>
<li><a href="#sec-5-21">5.21. <code>[5/5]</code> Listener</a>
<ul>
<li><a href="#sec-5-21-1">5.21.1. DEF <code>ok</code></a></li>
<li><a href="#sec-5-21-2">5.21.2. DEF <code>build#</code></a></li>
<li><a href="#sec-5-21-3">5.21.3. DEF <code>number</code></a></li>
<li><a href="#sec-5-21-4">5.21.4. DEF <code>process</code></a></li>
<li><a href="#sec-5-21-5">5.21.5. DEF <code>listen</code></a></li>
</ul>
</li>
<li><a href="#sec-5-22">5.22. <code>[0/4]</code> Extra documentation for the initial dictionary.</a>
<ul>
<li><a href="#sec-5-22-1">5.22.1. &lt;try and regroup these things, just for the documentation here&gt;</a></li>
<li><a href="#sec-5-22-2">5.22.2. &lt;ungrouped&gt;</a></li>
<li><a href="#sec-5-22-3">5.22.3. <code>version</code> , <code>build</code></a></li>
<li><a href="#sec-5-22-4">5.22.4. <code>vector</code> <code>tabAsWhitespace</code></a></li>
</ul>
</li>
<li><a href="#sec-5-23">5.23. Finish Metacompiled Part</a></li>
</ul>
</li>
<li><a href="#sec-6">6. <code>[7/35]</code> Stage 3: Extend The Language</a>
<ul>
<li><a href="#sec-6-1">6.1. <code>=================</code></a></li>
<li><a href="#sec-6-2">6.2. stack words</a></li>
<li><a href="#sec-6-3">6.3. Then the scope functions:</a></li>
<li><a href="#sec-6-4">6.4. vectored execution</a></li>
<li><a href="#sec-6-5">6.5. { refile these }</a></li>
<li><a href="#sec-6-6">6.6. dictionary words</a></li>
<li><a href="#sec-6-7">6.7. reclass</a></li>
<li><a href="#sec-6-8">6.8. initial prefixes</a></li>
<li><a href="#sec-6-9">6.9. classes { .primitive was moved to the kernel  }</a></li>
<li><a href="#sec-6-10">6.10. remapping</a>
<ul>
<li><a href="#sec-6-10-1">6.10.1. { .primitive again }</a></li>
<li><a href="#sec-6-10-2">6.10.2. :  p: ( "- ) &amp;.primitive reclass: ;</a></li>
<li><a href="#sec-6-10-3">6.10.3. And a couple of things to ".compiler" for safety.:</a></li>
</ul>
</li>
<li><a href="#sec-6-11">6.11. compiler macros</a>
<ul>
<li><a href="#sec-6-11-1">6.11.1. <code>`</code> (backtick)</a></li>
<li><a href="#sec-6-11-2">6.11.2. <code>jump:</code></a></li>
</ul>
</li>
<li><a href="#sec-6-12">6.12. ( Additional Combinators <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-6-13">6.13. preserve stack comment looks wrong here.</a>
<ul>
<li><a href="#sec-6-13-1">6.13.1. | Now for more combinators.</a></li>
</ul>
</li>
<li><a href="#sec-6-14">6.14. ( Memory Blocks <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-14-1">6.14.1. | memory blocks</a></li>
</ul>
</li>
<li><a href="#sec-6-15">6.15. ( Conditionals <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-15-1">6.15.1. | conditionals</a></li>
</ul>
</li>
<li><a href="#sec-6-16">6.16. ( Data Structures <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-16-1">6.16.1. data structures</a></li>
</ul>
</li>
<li><a href="#sec-6-17">6.17. ( Numbers and Math <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-17-1">6.17.1. numeric bases</a></li>
</ul>
</li>
<li><a href="#sec-6-18">6.18. ( Output <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-18-1">6.18.1. | output</a></li>
</ul>
</li>
<li><a href="#sec-6-19">6.19. ( Parsing prefixes <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-19-1">6.19.1. | prefix parsing</a></li>
<li><a href="#sec-6-19-2">6.19.2. | prefix parsing</a></li>
</ul>
</li>
<li><a href="#sec-6-20">6.20. ( Chained Vocabularies <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-20-1">6.20.1. dicts</a></li>
<li><a href="#sec-6-20-2">6.20.2. | vocabularies</a></li>
</ul>
</li>
<li><a href="#sec-6-21">6.21. ( Extend 'find' and 'xt-&gt;d' to search chains before global <code>~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-6-22">6.22. ( Extend Prefix Handler <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-6-23">6.23. ( Core Strings <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-6-24">6.24. ( Formatted String Display <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-24-1">6.24.1. | formatted strings</a></li>
</ul>
</li>
<li><a href="#sec-6-25">6.25. ( Debugging <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-25-1">6.25.1. depth</a></li>
<li><a href="#sec-6-25-2">6.25.2. def reset</a></li>
<li><a href="#sec-6-25-3">6.25.3. def .s</a></li>
<li><a href="#sec-6-25-4">6.25.4. def words</a></li>
</ul>
</li>
<li><a href="#sec-6-26">6.26. ( Keymap <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-6-27">6.27. ( Misc. Words <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a>
<ul>
<li><a href="#sec-6-27-1">6.27.1. | Just about done&#x2026;</a></li>
</ul>
</li>
<li><a href="#sec-6-28">6.28. ( Internal Functions <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
</ul>
</li>
<li><a href="#sec-7">7. <code>[0/10]</code> Appendix: Core Libraries</a>
<ul>
<li><a href="#sec-7-1">7.1. | Math Operations</a>
<ul>
<li><a href="#sec-7-1-1">7.1.1. :  seeds?   ( -  ) @w @z and ;</a></li>
<li><a href="#sec-7-1-2">7.1.2. :  seed     ( -  ) time [ 62903 and !w ] [ 78578 and !z ] bi ;</a></li>
<li><a href="#sec-7-1-3">7.1.3. :  ?seed    ( -  ) repeat seeds? 0 &lt;&gt; if; seed again ;</a></li>
<li><a href="#sec-7-1-4">7.1.4. :  (random) ( -x )</a></li>
<li><a href="#sec-7-1-5">7.1.5. :  random     (  -x ) ?seed (random) abs ;</a></li>
</ul>
</li>
<li><a href="#sec-7-2">7.2. ( Generic Buffer <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-7-3">7.3. | Generic Buffer</a>
<ul>
<li><a href="#sec-7-3-1">7.3.1. :  terminate (  -  ) 0 @ptr ! ;</a></li>
<li><a href="#sec-7-3-2">7.3.2. :  start     (  -a ) @buffer  ;</a></li>
<li><a href="#sec-7-3-3">7.3.3. :  end       (  -a ) @ptr     ;</a></li>
<li><a href="#sec-7-3-4">7.3.4. :  add       ( c-  ) end ! ptr ++ terminate ;</a></li>
<li><a href="#sec-7-3-5">7.3.5. :  get       (  -c ) ptr &#x2013; end @ terminate ;</a></li>
<li><a href="#sec-7-3-6">7.3.6. :  empty     (  -  ) start !ptr   terminate ;</a></li>
<li><a href="#sec-7-3-7">7.3.7. :  size      (  -n ) end start -   ;</a></li>
<li><a href="#sec-7-3-8">7.3.8. :  set       ( a-  ) !buffer empty ;</a></li>
</ul>
</li>
<li><a href="#sec-7-4">7.4. ( Text Strings <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-7-5">7.5. | Text Strings</a>
<ul>
<li><a href="#sec-7-5-1">7.5.1. :  buffer (  -a ) here 8192 + ;</a></li>
<li><a href="#sec-7-5-2">7.5.2. :  trim   ( \(-\) )</a></li>
<li><a href="#sec-7-5-3">7.5.3. :  place  ( $$n- ) [ copy 0 ] sip here + ! ;</a></li>
<li><a href="#sec-7-5-4">7.5.4. :  prep   (  $$- ) swap !haystack [ getLength !len ] [ !needle ] bi 0 !flag ;</a></li>
<li><a href="#sec-7-5-5">7.5.5. :  move   (    - ) @haystack here @len place haystack ++ ;</a></li>
<li><a href="#sec-7-5-6">7.5.6. :  cmp    (    - )</a></li>
<li><a href="#sec-7-5-7">7.5.7. :  search   ( $$-f )</a></li>
<li><a href="#sec-7-5-8">7.5.8. :  findChar ( $c-a )</a></li>
<li><a href="#sec-7-5-9">7.5.9. :  getSubset ( \(nn-\) )</a></li>
<li><a href="#sec-7-5-10">7.5.10. :  trimLeft  ( \(-\) ) [ @+ [ 32 = ] [ 0 &lt;&gt; ] bi = ] while 1- ;</a></li>
<li><a href="#sec-7-5-11">7.5.11. :  trimRight ( \(-\) )</a></li>
<li><a href="#sec-7-5-12">7.5.12. :  prepend ( $$-$ )</a></li>
<li><a href="#sec-7-5-13">7.5.13. :  append ( $$-$ ) swap prepend ;</a></li>
<li><a href="#sec-7-5-14">7.5.14. :  toLower ( \(-\) )</a></li>
<li><a href="#sec-7-5-15">7.5.15. :  toUpper ( \(-\) )</a></li>
<li><a href="#sec-7-5-16">7.5.16. :  reverse ( \(-\) )</a></li>
<li><a href="#sec-7-5-17">7.5.17. :  split ( $n-$$ )</a></li>
<li><a href="#sec-7-5-18">7.5.18. :  splitAtChar ( $c-$$ )</a></li>
<li><a href="#sec-7-5-19">7.5.19. :  splitAtChar: ( $"-$$ )</a></li>
</ul>
</li>
<li><a href="#sec-7-6">7.6. ( Access Words Within Chains Directly <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-7-7">7.7. | Access Words Within Chains Directly</a>
<ul>
<li><a href="#sec-7-7-1">7.7.1. :  cut withLength over + 1- 0 swap ! ;</a></li>
<li><a href="#sec-7-7-2">7.7.2. :  needs ( "- )</a></li>
</ul>
</li>
<li><a href="#sec-7-8">7.8. | Files</a>
<ul>
<li><a href="#sec-7-8-1">7.8.1. :  io     (  n-f )  4 out wait 4 in ;</a></li>
<li><a href="#sec-7-8-2">7.8.2. :  done   ( nn-  )  2drop active off ;</a></li>
<li><a href="#sec-7-8-3">7.8.3. :  open   (  $m-h ) -1 io ;</a></li>
<li><a href="#sec-7-8-4">7.8.4. :  read   (   h-f ) -2 io ;</a></li>
<li><a href="#sec-7-8-5">7.8.5. :  write  (  ch-f ) -3 io ;</a></li>
<li><a href="#sec-7-8-6">7.8.6. :  close  (   h-f ) -4 io ;</a></li>
<li><a href="#sec-7-8-7">7.8.7. :  pos    (   h-n ) -5 io ;</a></li>
<li><a href="#sec-7-8-8">7.8.8. :  seek   (  nh-f ) -6 io ;</a></li>
<li><a href="#sec-7-8-9">7.8.9. :  size   (   h-n ) -7 io ;</a></li>
<li><a href="#sec-7-8-10">7.8.10. :  delete (   $-n ) -8 io ;</a></li>
<li><a href="#sec-7-8-11">7.8.11. :  slurp  (  a$-n )</a></li>
<li><a href="#sec-7-8-12">7.8.12. :  spew   (  an$-n )</a></li>
<li><a href="#sec-7-8-13">7.8.13. :  readLine ( h-a )</a></li>
<li><a href="#sec-7-8-14">7.8.14. :  writeLine ( $h- )</a></li>
</ul>
</li>
<li><a href="#sec-7-9">7.9. ( types' <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
<li><a href="#sec-7-10">7.10. | types'</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Appendix: Cleanup, save, and power off</a>
<ul>
<li><a href="#sec-8-1">8.1. -</a></li>
<li><a href="#sec-8-2">8.2. ( cleanup and save <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</a></li>
</ul>
</li>
<li><a href="#sec-9">9. END</a></li>
<li><a href="#sec-10">10. tasklist</a>
<ul>
<li><a href="#sec-10-1">10.1. make <code>okmsg</code> assignable, in case you just want to change the string.</a>
<ul>
<li><a href="#sec-10-1-1">10.1.1. perhaps this means using strings with known lengths</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-11">11. NOTE . the new w: scheme for building the dictionaries</a></li>
</ul>
</div>
</div>
<p>
<i>NOTE: This commentary was written by <a href="http://rx-core.org/dev/corpse">crc</a> for the initial 11.0 release of Retro. Some things in the implementation have changed since then. Even so, this should help with understanding most of the internals.</i>
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> OUTPUT <code>meta.rx</code></h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Retro ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #66f;">( Copyright [c] 2008 - 2012, Charles Childers                                 )</span>
<span style="color: #66f;">( Copyright [c] 2009 - 2010, Luke Parrish                                     )</span>
<span style="color: #66f;">( Copyright [c] 2010,        Marc Simpson                                     )</span>
<span style="color: #66f;">( Copyright [c] 2010,        Jay Skeer                                        )</span>
<span style="color: #66f;">( ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> OUTPUT <code>kernel.rx</code></h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Retro ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #66f;">( Copyright [c] 2008 - 2012, Charles Childers                                 )</span>
<span style="color: #66f;">( Copyright [c] 2009 - 2010, Luke Parrish                                     )</span>
<span style="color: #66f;">( Copyright [c] 2010,        Marc Simpson                                     )</span>
<span style="color: #66f;">( Copyright [c] 2010,        Jay Skeer                                        )</span>
<span style="color: #66f;">( Copyright [c] 2012,        Michal J Wallace                                 )</span>
<span style="color: #66f;">( ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Building Retro</h2>
<div class="outline-text-2" id="text-3">
<p>
The process of building a new retroImage is a straightforward, though not trivial, process. It involves several stages, and some tricks. This is a commentary on the code, which should help make the process easier to understand.
</p>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> <code>[8/11]</code> Stage 1: The Metacompiler</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> <span class="done DONE">DONE</span> Introduction</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The first of the three stages of Retro is the metacompiler. This comprises the assembler and secondary compiler, and is used to create a new image. There are some tricky things:
</p>

<ol class="org-ol">
<li>The target memory is allocated
</li>
<li>But all pointers compiled in it need to be adjusted to be relative to zero, so it'll continue working after replacing the old image
</li>
<li>We can't know the locations of the class handler until we are finished laying down a fair portion of the new kernel
</li>
<li>When we move the image to overwrite the old one, we can't rely on any code locations in either image
</li>
</ol>

<p>
So let's begin.
</p>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> <span class="done DONE">DONE</span> <code>IMAGE-SIZE</code></h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #32cd32;">36</span> <span style="color: #32cd32;">1024</span> <span style="color: #00ffff;">*</span> <span style="color: #c63; font-weight: bold;">constant</span> IMAGE-SIZE
</pre>
</div>

<p>
This just specifies how much memory to set aside for the initial kernel built by the metacompiler. If you need to increase, it's safer to increase in small increments and rebuild rather than trying a big jump. (Large increases can cause the new image to overwrite the <code>bootNew</code> routine, which is an easy way to generate a badly corrupted image.)
</p>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> <span class="done DONE">DONE</span> variables</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">variables|</span> target origin 'WORD 'MACRO 'DATA 'PRIM link chain latest <span style="color: #c63; font-weight: bold;">|</span>
</pre>
</div>

<p>
A list of variables used by the metacompiler.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left"/>

<col class="left"/>
</colgroup>
<tbody>
<tr>
<td class="left">target</td>
<td class="left">Holds a pointer to the next free address in the target memory. This is similar to "heap"</td>
</tr>

<tr>
<td class="left">origin</td>
<td class="left">Holds a pointer to the start of the target memory</td>
</tr>

<tr>
<td class="left">'WORD</td>
<td class="left">Holds a pointer to the .word class</td>
</tr>

<tr>
<td class="left">'MACRO</td>
<td class="left">Holds a pointer to the .macro class</td>
</tr>

<tr>
<td class="left">'DATA</td>
<td class="left">Holds a pointer to the .data class</td>
</tr>

<tr>
<td class="left">link</td>
<td class="left">Holds pointer to prior entry (for initial dictionary)</td>
</tr>

<tr>
<td class="left">chain</td>
<td class="left">Holds pointer to variable that will become "last"</td>
</tr>

<tr>
<td class="left">latest</td>
<td class="left">Holds pointer to most recently defined entry</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> <span class="done DONE">DONE</span> allocate ram for new image</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #00ffff;">here</span> <span style="color: #00ffff;">[</span> !target <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> !origin <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> IMAGE-SIZE <span style="color: #00ffff;">allot</span>
</pre>
</div>

<p>
Starting at <code>here</code>, allocate space for the new image, set <code>target</code> and <code>origin</code> to point to it.
</p>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> <span class="done DONE">DONE</span> target memory writer</h3>
<div class="outline-text-3" id="text-4-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> m,  <span style="color: #66f;">( n-  )</span> @target <span style="color: #00ffff;">!+</span> !target <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
This is like "," but it writes the value to the target memory instead of the standard heap. Each time it's called, "target" is increased by one.
</p>
</div>
</div>
<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> <span class="done DONE">DONE</span> assembler</h3>
<div class="outline-text-3" id="text-4-6">
</div><div id="outline-container-sec-4-6-1" class="outline-4">
<h4 id="sec-4-6-1"><span class="section-number-4">4.6.1</span> <span class="done DONE">DONE</span> def vm:</h4>
<div class="outline-text-4" id="text-4-6-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #66f;">( n"- )</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">.data</span> <span style="color: #c63; font-weight: bold;">`</span> m, <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
This is used to build functions that lay down opcodes into the target memory space. Functionally, the following forms would be equivilent:
</p>

<pre class="example">
  0 vm: nop,

:  nop, 0 m, ;
</pre>

<p>
The use of <code>vm:</code> helps keep things a bit more readable though, so it is preferred to do it this way.
</p>
</div>
</div>

<div id="outline-container-sec-4-6-2" class="outline-4">
<h4 id="sec-4-6-2"><span class="section-number-4">4.6.2</span> <span class="done DONE">DONE</span> opcode assemblers</h4>
<div class="outline-text-4" id="text-4-6-2">
<div class="org-src-container">

<pre class="src src-retro"> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">nop,</span>          <span style="color: #32cd32;">1</span> <span style="color: #c63; font-weight: bold;">vm:</span> lit,          <span style="color: #32cd32;">2</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">dup,</span>
 <span style="color: #32cd32;">3</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">drop,</span>         <span style="color: #32cd32;">4</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">swap,</span>         <span style="color: #32cd32;">5</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">push,</span>
 <span style="color: #32cd32;">6</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">pop,</span>          <span style="color: #32cd32;">7</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">loop,</span>         <span style="color: #32cd32;">8</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">jump,</span>
 <span style="color: #32cd32;">9</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">;,</span>           <span style="color: #32cd32;">10</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">&gt;jump,</span>       <span style="color: #32cd32;">11</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">&lt;jump,</span>
<span style="color: #32cd32;">12</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">!jump,</span>       <span style="color: #32cd32;">13</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">=jump,</span>       <span style="color: #32cd32;">14</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">@,</span>
<span style="color: #32cd32;">15</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">!,</span>           <span style="color: #32cd32;">16</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">+,</span>           <span style="color: #32cd32;">17</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">-,</span>
<span style="color: #32cd32;">18</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">*,</span>           <span style="color: #32cd32;">19</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">/mod,</span>        <span style="color: #32cd32;">20</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">and,</span>
<span style="color: #32cd32;">21</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">or,</span>          <span style="color: #32cd32;">22</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">xor,</span>         <span style="color: #32cd32;">23</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">&lt;&lt;,</span>
<span style="color: #32cd32;">24</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">&gt;&gt;,</span>          <span style="color: #32cd32;">25</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #ffd700; font-weight: bold;">0;</span>           <span style="color: #32cd32;">26</span> <span style="color: #c63; font-weight: bold;">vm:</span> 1+,
<span style="color: #32cd32;">27</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">1-,</span>          <span style="color: #32cd32;">28</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">in,</span>          <span style="color: #32cd32;">29</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">out,</span>
<span style="color: #32cd32;">30</span> <span style="color: #c63; font-weight: bold;">vm:</span> <span style="color: #00ff00;">wait,</span>
</pre>
</div>

<p>
Create functions for laying down each opcode. This is pretty easy to grasp. The number is the opcode number (in decimal), and the names all end with a comma to distinguish them from higher-level functions.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> <code>[8/9]</code> metacompler words</h3>
<div class="outline-text-3" id="text-4-7">
</div><div id="outline-container-sec-4-7-1" class="outline-4">
<h4 id="sec-4-7-1"><span class="section-number-4">4.7.1</span> <span class="done DONE">DONE</span> def t-here</h4>
<div class="outline-text-4" id="text-4-7-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> t-here      <span style="color: #66f;">(  -n )</span> @target @origin <span style="color: #00ffff;">-</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Like <code>here</code>, but returns a pointer in the target buffer. The pointer is set relative to <code>origin</code>, not the physical start of the target buffer.
</p>
</div>
</div>
<div id="outline-container-sec-4-7-2" class="outline-4">
<h4 id="sec-4-7-2"><span class="section-number-4">4.7.2</span> <span class="done DONE">DONE</span> def pad</h4>
<div class="outline-text-4" id="text-4-7-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> pad         <span style="color: #66f;">(  -  )</span> <span style="color: #32cd32;">32</span> @origin <span style="color: #00ffff;">+</span> !target <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Used to ensure that function addresses are greater than the number of opcodes.
</p>
</div>
</div>
<div id="outline-container-sec-4-7-3" class="outline-4">
<h4 id="sec-4-7-3"><span class="section-number-4">4.7.3</span> <span class="done DONE">DONE</span> def endKernel</h4>
<div class="outline-text-4" id="text-4-7-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> endKernel   <span style="color: #66f;">(  -  )</span>
  t-here <span style="color: #00ff00;">"\nKernel ends @ %d\n"</span> puts
  IMAGE-SIZE t-here <span style="color: #00ffff;">-</span> <span style="color: #00ff00;">"%d cells free"</span> puts
  depth <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #00ffff;">[</span> <span style="color: #00ff00;">"\nError in stack depth!: "</span> puts .s <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
This is called at the end of the initial kernel. It does some sanity checks on the stack depth and displays some statistics on the size of the kernel.
</p>
</div>
</div>
<div id="outline-container-sec-4-7-4" class="outline-4">
<h4 id="sec-4-7-4"><span class="section-number-4">4.7.4</span> <span class="done DONE">DONE</span> def main:</h4>
<div class="outline-text-4" id="text-4-7-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">main:</span>       <span style="color: #66f;">(  -  )</span> t-here <span style="color: #00ffff;">[</span> <span style="color: #00ff00;">"\nMAIN @ %d"</span> puts <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> @origin <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
This is called to mark the main entry point in the image. It replaces the jump at the image start with a jump to the code that follows it.
</p>
</div>
</div>
<div id="outline-container-sec-4-7-5" class="outline-4">
<h4 id="sec-4-7-5"><span class="section-number-4">4.7.5</span> <span class="done DONE">DONE</span> def label:</h4>
<div class="outline-text-4" id="text-4-7-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">label:</span>      <span style="color: #66f;">( "-  )</span> t-here <span style="color: #c63; font-weight: bold;">constant</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Create a symbolic name pointing to something in the target space, with the pointer being relative to <code>origin</code>.
</p>
</div>
</div>
<div id="outline-container-sec-4-7-6" class="outline-4">
<h4 id="sec-4-7-6"><span class="section-number-4">4.7.6</span> <span class="done DONE">DONE</span> def #</h4>
<div class="outline-text-4" id="text-4-7-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> #           <span style="color: #66f;">( n-  )</span> lit, m, <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
This is used to compile a value as a literal. In normal definitons you'd just do:
</p>

<pre class="example">
:  foo 1 2 + ;
</pre>

<p>
However, the classes are not aware of the target image. So we manually tell Retro to compile them.
</p>

<pre class="example">
:  foo 1 # 2 # + ;
</pre>

<p>
This continues with the next function:
</p>
</div>
</div>
<div id="outline-container-sec-4-7-7" class="outline-4">
<h4 id="sec-4-7-7"><span class="section-number-4">4.7.7</span> <span class="done DONE">DONE</span> def __#</h4>
<div class="outline-text-4" id="text-4-7-7">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> __#         <span style="color: #66f;">( $-  )</span> lit, toNumber m, <span style="color: #c63; font-weight: bold;">;</span> parsing
</pre>
</div>

<p>
This is a parsing prefix; it serves as a shortcut for numbers. Instead of doing:
</p>

<pre class="example">
1 # 2 #
</pre>

<p>
We can do:
</p>

<pre class="example">
#1 #2
</pre>

<p>
Which I find a bit cleaner.
</p>
</div>
</div>
<div id="outline-container-sec-4-7-8" class="outline-4">
<h4 id="sec-4-7-8"><span class="section-number-4">4.7.8</span> <span class="done DONE">DONE</span> def $,</h4>
<div class="outline-text-4" id="text-4-7-8">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> $,          <span style="color: #66f;">( $-  )</span> <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">@+</span> m, <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #32cd32;">0</span> m, <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Copy a string from the current image into the target memory space.
</p>

<p>
The above finishes off what I consider the core of the assembler. The code then moves on to extend this into a target compiler and machine forth dialect.
</p>
</div>
</div>
<div id="outline-container-sec-4-7-9" class="outline-4">
<h4 id="sec-4-7-9"><span class="section-number-4">4.7.9</span> <span class="todo TODO">TODO</span> def shrink</h4>
<div class="outline-text-4" id="text-4-7-9">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> shrink      <span style="color: #66f;">(  -  )</span> t-here <span style="color: #00ff00;">"\nShrinking kernel to %d cells\n"</span> puts
                      t-here @origin <span style="color: #32cd32;">6</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> t-here @origin <span style="color: #32cd32;">3</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><span class="section-number-3">4.8</span> <span class="todo TODO">TODO</span> Metacompiler</h3>
<div class="outline-text-3" id="text-4-8">
</div><div id="outline-container-sec-4-8-1" class="outline-4">
<h4 id="sec-4-8-1"><span class="section-number-4">4.8.1</span> <span class="todo TODO">TODO</span> def t: and i:  { t: is done, but add a note about i: }</h4>
<div class="outline-text-4" id="text-4-8-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> &lt;self-compile&gt;  &amp;m, reclass <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #66f;">( "- )</span> <span style="color: #c63; font-weight: bold;">label:</span> &lt;self-compile&gt; <span style="color: #00ff00;">nop,</span> <span style="color: #00ff00;">nop,</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">i:</span> <span style="color: #66f;">( "- )</span> <span style="color: #c63; font-weight: bold;">label:</span> &lt;self-compile&gt; <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>

<p>
Since <code>:</code> creates a dictionary header in the current image, we can't use it to create functions in the target. We define <code>t:</code> (for "target :") to create a label, compile two nop instructions, and then change the label's class to call
"m,"
</p>

<p>
Since the Retro VM is direct threaded, this basically makes a function in the target compile a call to itself when referenced. The following forms would be functionally identical:
</p>

<pre class="example">
( without t: or # )
label: foo  lit, 1 m, lit, 2 m, ;, ;,
label: bar ' foo m, ;, ;,

( with t: and # )
t: foo #1 #2 ;, ;,
t: bar foo ;, ;,
</pre>

<p>
As can be seen, the second is much more compact and readable.
</p>
</div>
</div>
<div id="outline-container-sec-4-8-2" class="outline-4">
<h4 id="sec-4-8-2"><span class="section-number-4">4.8.2</span> NOTE: the end-of-function marker</h4>
<div class="outline-text-4" id="text-4-8-2">
<p>
Note the double ;, at the end of the functions. Retro 11 expects colon definitions to end in a double return. This could be stripped out to save space, but some of the debugging tools (such as dissect' and autopsy.rx) require this to locate the end of a function in memory.
</p>

<p>
Later on a modified ";" is defined to do this for us.
</p>
</div>
</div>
<div id="outline-container-sec-4-8-3" class="outline-4">
<h4 id="sec-4-8-3"><span class="section-number-4">4.8.3</span> <span class="todo TODO">TODO</span> def { =if &lt;if &gt;if !if then }</h4>
<div class="outline-text-4" id="text-4-8-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> cond <span style="color: #66f;">( -a )</span> @target <span style="color: #32cd32;">0</span> m, <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">=if</span>  <span style="color: #66f;">( -a )</span> <span style="color: #00ff00;">!jump,</span> cond <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">&lt;if</span>  <span style="color: #66f;">( -a )</span> <span style="color: #00ff00;">&gt;jump,</span> cond <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">&gt;if</span>  <span style="color: #66f;">( -a )</span> <span style="color: #00ff00;">&lt;jump,</span> cond <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">!if</span>  <span style="color: #66f;">( -a )</span> <span style="color: #00ff00;">=jump,</span> cond <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #66f;">( a- )</span> t-here <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>

<p>
Primitive conditionals mapping to the VM conditional jumps. Since the initial kernel does not support quotes, this is used to allow for any required comparision or flow control.
</p>
</div>
</div>
<div id="outline-container-sec-4-8-4" class="outline-4">
<h4 id="sec-4-8-4"><span class="section-number-4">4.8.4</span> def <code>jump:</code></h4>
<div class="outline-text-4" id="text-4-8-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">jump:</span>  <span style="color: #66f;">( "-  )</span> <span style="color: #00ff00;">jump,</span> <span style="color: #c63; font-weight: bold;">'</span> m, <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Compile a jump instruction into the target memory. This is used in a
couple of places to keep the address stack shallow, and to improve
performance slightly.
</p>
</div>
</div>
<div id="outline-container-sec-4-8-5" class="outline-4">
<h4 id="sec-4-8-5"><span class="section-number-4">4.8.5</span> <span class="done DONE">DONE</span> def <code>repeat</code> / <code>again</code></h4>
<div class="outline-text-4" id="text-4-8-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #66f;">(  -a )</span> t-here <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">again</span>  <span style="color: #66f;">( a-  )</span> <span style="color: #00ff00;">jump,</span> m, <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
We redefine repeat/again to work in the target memory instead of the current image.
</p>
</div>
</div>
<div id="outline-container-sec-4-8-6" class="outline-4">
<h4 id="sec-4-8-6"><span class="section-number-4">4.8.6</span> <span class="todo TODO">TODO</span> tallot</h4>
<div class="outline-text-4" id="text-4-8-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> tallot  <span style="color: #66f;">( n- )</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> m, <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-8-7" class="outline-4">
<h4 id="sec-4-8-7"><span class="section-number-4">4.8.7</span> <span class="done DONE">DONE</span> variable factories</h4>
<div class="outline-text-4" id="text-4-8-7">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">variable:</span> <span style="color: #66f;">( n"- )</span> <span style="color: #c63; font-weight: bold;">label:</span> m, <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">variable</span>  <span style="color: #66f;">(  "- )</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">variable:</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">elements</span>  <span style="color: #66f;">( n"- )</span> &amp;variable <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Create labels pointing to data in the target image. These correspond to the identically named functions in the current image.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9"><span class="section-number-3">4.9</span> <code>[3/6]</code> functions to build the initial dictionary</h3>
<div class="outline-text-3" id="text-4-9">
</div><div id="outline-container-sec-4-9-1" class="outline-4">
<h4 id="sec-4-9-1"><span class="section-number-4">4.9.1</span> <span class="todo TODO">TODO</span> def entry word: data: { are these obsolete given p: w: m: ?  and where is macro ??}</h4>
<div class="outline-text-4" id="text-4-9-1">
<p>
A big round of functions used to create the initial dictionary in the new
kernel. Taking these one at a time:
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> entry     <span style="color: #66f;">( a"- )</span> t-here <span style="color: #00ffff;">dup</span> !latest @link m, !link m, m, <span style="color: #32cd32;">0</span> m, getToken $, <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Given a pointer, a class, and a string with the name, create a new header. Generally this should not be used directly; instead use "word:", "macro:", and "data:"
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">word:</span>     <span style="color: #66f;">( a"- )</span> @'WORD  entry <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Given a pointer, parse for a name and create a header with a class of ".word"
</p>

<p>
{ macro ??? }
</p>

<p>
Given a pointer, parse for a name and create a header with a class of ".macro"
</p>


<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">data:</span>     <span style="color: #66f;">( a"- )</span> @'DATA  entry <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Given a pointer, parse for a name and create a header with a class of ".data"
</p>
</div>
</div>
<div id="outline-container-sec-4-9-2" class="outline-4">
<h4 id="sec-4-9-2"><span class="section-number-4">4.9.2</span> <span class="todo TODO">TODO</span> def p: w: m:</h4>
<div class="outline-text-4" id="text-4-9-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">w:</span>        <span style="color: #66f;">( ""- )</span>
  t-here <span style="color: #00ffff;">dup</span> !latest @link m, !link @'WORD m, t-here <span style="color: #32cd32;">0</span> m, <span style="color: #32cd32;">0</span> m, getToken $, t-here <span style="color: #00ffff;">swap</span> @origin <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">p:</span>        <span style="color: #66f;">( ""- )</span>
  t-here <span style="color: #00ffff;">dup</span> !latest @link m, !link @'PRIM m, t-here <span style="color: #32cd32;">0</span> m, <span style="color: #32cd32;">0</span> m, getToken $, t-here <span style="color: #00ffff;">swap</span> @origin <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">;</span>

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">m:</span>        <span style="color: #66f;">( ""- )</span>
  t-here <span style="color: #00ffff;">dup</span> !latest @link m, !link @'MACRO m, t-here <span style="color: #32cd32;">0</span> m, <span style="color: #32cd32;">0</span> m, getToken $, t-here <span style="color: #00ffff;">swap</span> @origin <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-9-3" class="outline-4">
<h4 id="sec-4-9-3"><span class="section-number-4">4.9.3</span> <span class="todo TODO">TODO</span> def :doc</h4>
<div class="outline-text-4" id="text-4-9-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> :doc
  t-here <span style="color: #00ffff;">[</span> $, <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> @latest @origin <span style="color: #00ffff;">+</span> <span style="color: #32cd32;">3</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-9-4" class="outline-4">
<h4 id="sec-4-9-4"><span class="section-number-4">4.9.4</span> <span class="done DONE">DONE</span> def patch</h4>
<div class="outline-text-4" id="text-4-9-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> patch     <span style="color: #66f;">(   - )</span> @link <span style="color: #00ffff;">[</span> @chain <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ff00;">"\nLast header at %d"</span> puts <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
You should call "patch" at the end of the kernel source to seal the initial dictionary. Once that's done, relocation should be possible.
</p>
</div>
</div>
<div id="outline-container-sec-4-9-5" class="outline-4">
<h4 id="sec-4-9-5"><span class="section-number-4">4.9.5</span> <span class="done DONE">DONE</span> def mark</h4>
<div class="outline-text-4" id="text-4-9-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> mark      <span style="color: #66f;">(   - )</span> @target !chain <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Mark the cell at t-here as the variable that will corespond with "last". This variable is set later by&#x2026;
</p>
</div>
</div>
<div id="outline-container-sec-4-9-6" class="outline-4">
<h4 id="sec-4-9-6"><span class="section-number-4">4.9.6</span> <span class="done DONE">DONE</span> def setClass</h4>
<div class="outline-text-4" id="text-4-9-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> setClass  <span style="color: #66f;">( aa- )</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
Now we run into a problem. We can create headers, but the class locations aren't easily knowable. We get around this by using <code>setClass</code> to assign the ='WORD=  ='MACRO=  and ='DATA= variables to the class handlers we create.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10"><span class="section-number-3">4.10</span> <span class="done DONE">DONE</span> Image Relocator</h3>
<div class="outline-text-3" id="text-4-10">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">for</span>      <span style="color: #66f;">( n-   )</span>  <span style="color: #00ffff;">here</span> <span style="color: #32cd32;">5</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">next</span>     <span style="color: #66f;">(  -   )</span>  <span style="color: #32cd32;">6</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">7</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">@+</span>       <span style="color: #66f;">( a-ac )</span>  <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">@</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">!+</span>       <span style="color: #66f;">( ca-a )</span>  <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">push</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">pop</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">copy</span>     <span style="color: #66f;">( aan- )</span>  <span style="color: #ffd700; font-weight: bold;">for</span> <span style="color: #00ffff;">push</span> <span style="color: #00ffff;">@+</span> <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">!+</span> <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> wait     <span style="color: #66f;">( - )</span>     <span style="color: #32cd32;">0</span> <span style="color: #32cd32;">0</span> out <span style="color: #00ffff;">[[</span> <span style="color: #32cd32;">30</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">]]</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">save</span>     <span style="color: #66f;">( - )</span>     <span style="color: #32cd32;">1</span> <span style="color: #32cd32;">4</span> out <span style="color: #32cd32;">0</span> <span style="color: #32cd32;">0</span> out wait <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> relocate <span style="color: #66f;">( - )</span>     origin <span style="color: #00ffff;">@</span> <span style="color: #32cd32;">0</span> IMAGE-SIZE <span style="color: #00ffff;">copy</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> bootNew  <span style="color: #66f;">( - )</span>     relocate <span style="color: #c63; font-weight: bold;">save</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">push</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>

<p>
This bit is hairy. Once the target image is created, we need to replace the original image with the new one. This involves reading it cell by cell, and writing it to the main memory, starting at address zero. Pretty straightforward.
</p>

<p>
However there is a catch. Since the new image will (generally) differ from the old one, <i>this code can not call anything in the old or new images</i>.
</p>

<p>
So, to make this work, I define all needed factors using only primitives and macros that inline raw Ngaro bytecode. The mechanics here are murky, but I've not found a better solution yet.
</p>

<p>
Once "bootNew" finishes relocating the kernel it saves the new image file and uses a trick ("0 push ;") to jump to the new image. Assuming that there are no serious bugs, the new image should be ready to extend.
</p>

<p>
If anything does go wrong you may have to manually kill the VM and restore the image from a clean backup.
</p>
</div>
</div>
<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11"><span class="section-number-3">4.11</span> <span class="todo TODO">TODO</span> Avoid keymap issues</h3>
<div class="outline-text-3" id="text-4-11">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">devector</span> keymap:handler
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12"><span class="section-number-3">4.12</span> <span class="done DONE">DONE</span> Setup target memory for new image</h3>
<div class="outline-text-3" id="text-4-12">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #66f;">( - )</span> <span style="color: #00ff00;">;,</span> <span style="color: #00ff00;">;,</span> <span style="color: #ffd700; font-weight: bold;">;;</span> <span style="color: #00ffff;">[[</span>
</pre>
</div>

<p>
Ok, now this one is the last definition in the metacompiler. We redefine ";" to lay down two return instructions (";,"), and then end the definition and exit the compiler manually (using ";; [[").
</p>

<p>
<b>TIP:</b> If you are pressed for space, you can save a fair amount of memory by removing the second ";," here.
</p>

<p>
One final bit:
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #00ff00;">jump,</span> <span style="color: #32cd32;">0</span> m,
reset
</pre>
</div>

<p>
Compile a jump instruction, with a target of zero. This will be modified later, by "main:". And finally, "reset" to ensure the data stack is in a clean state.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> <code>[3/14]</code> Stage 2: The Kernel</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> <code>[0/1]</code> Layout of the Image</h3>
<div class="outline-text-3" id="text-5-1">
</div><div id="outline-container-sec-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"><span class="section-number-4">5.1.1</span> <span class="todo TODO">TODO</span> <code>{ update this text to reflect the new situation for TIB }</code></h4>
<div class="outline-text-4" id="text-5-1-1">
<div class="org-src-container">

<pre class="src src-retro">IMAGE-SIZE  <span style="color: #c63; font-weight: bold;">constant</span> CORE
CORE <span style="color: #32cd32;">0000</span> <span style="color: #00ffff;">+</span> <span style="color: #c63; font-weight: bold;">constant</span> HEAP
</pre>
</div>

<p>
IMAGE-SIZE  constant CORE
CORE 0000 + constant TIB
TIB   512 + constant HEAP
</p>

<p>
Create a few constants, which determine the basic memory layout. It looks like:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left"/>

<col class="left"/>
</colgroup>
<tbody>
<tr>
<td class="left">0</td>
<td class="left">Start of memory. The kernel goes here</td>
</tr>

<tr>
<td class="left">0 + IMAGE-SIZE</td>
<td class="left">End of kernel, start of TIB (text input buffer)</td>
</tr>

<tr>
<td class="left">TIB + 512</td>
<td class="left">Start of heap. This is set to TIB + 512 by default</td>
</tr>
</tbody>
</table>

<p>
If you need to save memory, reducing the TIB is a quick and easy way to do so.  I'd leave it at least 81 characters long, but making it a bit longer than the longest strings you'll be creating is a good idea.
</p>

<p>
WARNING:
</p>

<p>
If you make TIB too small, you can overwrite non-kernel code as you type long strings. If you overwrite memory, you may need to exit and reload, or even restore the image from a backup in some cases.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> <code>[2/4]</code> Initial Variables</h3>
<div class="outline-text-3" id="text-5-2">
<p>
At this point the metacompiler functions are created, there is space set aside
for a new image, and things are ready to proceed. So on to the kernel.
</p>
</div>
<div id="outline-container-sec-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> <span class="done DONE">DONE</span> <code>last</code> .. <code>which</code></h4>
<div class="outline-text-4" id="text-5-2-1">
<div class="org-src-container">

<pre class="src src-retro">mark <span style="color: #c63; font-weight: bold;">variable</span> last    <span style="color: #66f;">( Pointer to the most recent dictionary header          )</span>
HEAP <span style="color: #c63; font-weight: bold;">variable:</span> <span style="color: #00ffff;">heap</span>   <span style="color: #66f;">( Starting address of the data/code heap                )</span>
<span style="color: #c63; font-weight: bold;">variable</span> compiler     <span style="color: #66f;">( Is the compiler on or off?                            )</span>
<span style="color: #c63; font-weight: bold;">variable</span> which        <span style="color: #66f;">( Pointer to dictionary header of the most recently     )</span>
                      <span style="color: #66f;">( looked up word                                        )</span>
</pre>
</div>

<p>
These should be pretty easy to grasp. Note the use of <code>mark</code> to flag the <code>last</code> variable, which will be updated after the initial dictionary is created.
</p>
</div>
</div>
<div id="outline-container-sec-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> <span class="todo TODO">TODO</span> |memory fb fw fh cw ch</h4>
<div class="outline-text-4" id="text-5-2-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #32cd32;">6</span> <span style="color: #c63; font-weight: bold;">elements</span> memory fb fw fh cw ch
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-2-3" class="outline-4">
<h4 id="sec-5-2-3"><span class="section-number-4">5.2.3</span> <span class="done DONE">DONE</span> copytag, version, build, okmsg</h4>
<div class="outline-text-4" id="text-5-2-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">label:</span> copytag   <span style="color: #00ff00;">"Retro"</span> $,
<span style="color: #c63; font-weight: bold;">label:</span> version   <span style="color: #00ff00;">"11.5"</span> $,
<span style="color: #c63; font-weight: bold;">label:</span> build     <span style="color: #00ff00;">"2012.12.10"</span> $,
<span style="color: #c63; font-weight: bold;">label:</span> okmsg     <span style="color: #00ff00;">"ok  "</span> $,
</pre>
</div>

<p>
Some strings. "copytag" and "version" and "build" are displayed when Retro starts, while "okmsg" serves as the prompt for the listener.
</p>
</div>
</div>
<div id="outline-container-sec-5-2-4" class="outline-4">
<h4 id="sec-5-2-4"><span class="section-number-4">5.2.4</span> <span class="todo TODO">TODO</span> call pad { i think this moved up to the top ?? }</h4>
<div class="outline-text-4" id="text-5-2-4">
<p>
Ngaro assumes that addresses of functions will be greater than the number of opcodes. The "pad" function injects a bunch of NOP's to make sure that things are setup correctly.
</p>

<p>
The padding isn't always needed, but seems to help keep the rebuilds more stable if you are making changes to the kernel. (Specifically, it's there to ensure that no functions are located at addresses reserved for Ngaro bytecodes.)
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> <span class="todo TODO">TODO</span> DEF , <code>{ the heap writer }</code></h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">,</span>           <span style="color: #66f;">( n-  )</span> <span style="color: #00ffff;">heap</span> # <span style="color: #00ff00;">@,</span> <span style="color: #00ff00;">dup,</span> 1+, <span style="color: #00ff00;">push,</span> <span style="color: #00ff00;">!,</span> <span style="color: #00ff00;">pop,</span> <span style="color: #00ffff;">heap</span> # <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> <code>[5/7]</code> classes</h3>
<div class="outline-text-3" id="text-5-4">
</div><div id="outline-container-sec-5-4-1" class="outline-4">
<h4 id="sec-5-4-1"><span class="section-number-4">5.4.1</span> <span class="done DONE">DONE</span> DEF withClass</h4>
<div class="outline-text-4" id="text-5-4-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">t:</span> withClass   <span style="color: #66f;">( ac- )</span> <span style="color: #00ff00;">1-,</span> <span style="color: #00ff00;">push,</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
This is identical (by default) to <code>do</code>, but serves as a hook for gaining more control over how classes are handled
</p>
</div>
</div>
<div id="outline-container-sec-5-4-2" class="outline-4">
<h4 id="sec-5-4-2"><span class="section-number-4">5.4.2</span> <span class="done DONE">DONE</span> DEF .word</h4>
<div class="outline-text-4" id="text-5-4-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">.word</span>       <span style="color: #66f;">(  a- )</span> compiler # <span style="color: #00ff00;">@,</span> <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> withClass
</pre>
</div>

<p>
The class handler for normal functions. If interpreting, execute the xt of the function. If the compiler is active, lay down a call to the xt instead.
</p>
</div>
</div>
<div id="outline-container-sec-5-4-3" class="outline-4">
<h4 id="sec-5-4-3"><span class="section-number-4">5.4.3</span> <span class="done DONE">DONE</span> DEF .macro</h4>
<div class="outline-text-4" id="text-5-4-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">.macro</span>      <span style="color: #66f;">(  a- )</span> <span style="color: #c63; font-weight: bold;">jump:</span> withClass
</pre>
</div>

<p>
The core class for compiler macros. Basically "immediate" functions; this always calls the xt.
</p>
</div>
</div>
<div id="outline-container-sec-5-4-4" class="outline-4">
<h4 id="sec-5-4-4"><a id=".data" name=".data"></a><span class="section-number-4">5.4.4</span> <span class="done DONE">DONE</span> DEF <code>.data</code></h4>
<div class="outline-text-4" id="text-5-4-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">.data</span>       <span style="color: #66f;">(  a- )</span> compiler # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">1</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
</pre>
</div>

<p>
The class handler for data structures. It either leaves the xt on the stack (if interpreting), or compiles it as a literal.
</p>
</div>
</div>
<div id="outline-container-sec-5-4-5" class="outline-4">
<h4 id="sec-5-4-5"><span class="section-number-4">5.4.5</span> <span class="done DONE">DONE</span> DEF <code>.primitive</code></h4>
<div class="outline-text-4" id="text-5-4-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">t:</span> <span style="color: #c63; font-weight: bold;">.primitive</span>  <span style="color: #66f;">(  a- )</span>
    <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">@,</span> <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> compiler # <span style="color: #00ff00;">@,</span> <span style="color: #32cd32;">-1</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #32cd32;">2</span> # <span style="color: #00ff00;">+,</span> <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> <span style="color: #c63; font-weight: bold;">.word</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-4-6" class="outline-4">
<h4 id="sec-5-4-6"><span class="section-number-4">5.4.6</span> <span class="todo TODO">TODO</span> classes for the words so far</h4>
<div class="outline-text-4" id="text-5-4-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.macro</span>     'MACRO setClass
<span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.data</span>      'DATA  setClass
<span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.primitive</span> 'PRIM  setClass
</pre>
</div>

<p>
This bit assigns the classes to the variables that the metacompiler will later use when creating the initial dictionary. Without this, we'd have no easy way to reference the classes in the new kernel.
</p>
</div>
</div>
<div id="outline-container-sec-5-4-7" class="outline-4">
<h4 id="sec-5-4-7"><span class="section-number-4">5.4.7</span> <span class="todo TODO">TODO</span> docs for the words so far <code>{ looks like these can be inlined&#x2026;? }</code></h4>
<div class="outline-text-4" id="text-5-4-7">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">word:</span> <span style="color: #c63; font-weight: bold;">,</span>
"( n- ) Place TOS **here** <span style="color: #00ffff;">and</span> increment **heap** by <span style="color: #32cd32;">1</span> " :doc

<span style="color: #c63; font-weight: bold;">'</span> withClass    <span style="color: #c63; font-weight: bold;">word:</span> withClass
<span style="color: #00ff00;">"( ac- ) Execute a function via the specified class handler"</span> :doc

<span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.word</span>          <span style="color: #c63; font-weight: bold;">word:</span> <span style="color: #c63; font-weight: bold;">.word</span>
<span style="color: #00ff00;">"( a- ) Class for normal functions"</span> :doc

<span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.macro</span>       <span style="color: #c63; font-weight: bold;">word:</span> <span style="color: #c63; font-weight: bold;">.macro</span>
<span style="color: #00ff00;">"( a- ) Class for immediate functions"</span> :doc

<span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.data</span>          <span style="color: #c63; font-weight: bold;">word:</span> <span style="color: #c63; font-weight: bold;">.data</span>
<span style="color: #00ff00;">"( a- ) Class for data (variables, literals, etc) "</span> :doc

<span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.primitive</span>   <span style="color: #c63; font-weight: bold;">word:</span> <span style="color: #c63; font-weight: bold;">.primitive</span>
<span style="color: #00ff00;">"( a- ) Class for functions corresponding to VM opcodes; used for simple optimizations"</span> :doc
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> <span class="todo TODO">TODO</span> Primitives : <code>dup</code> .. <code>!+</code></h3>
<div class="outline-text-3" id="text-5-5">
</div><div id="outline-container-sec-5-5-1" class="outline-4">
<h4 id="sec-5-5-1"><span class="section-number-4">5.5.1</span> .</h4>
<div class="outline-text-4" id="text-5-5-1">
<p>
These are functions that map directly to Ngaro instructions. We will use the instructions directly in most cases (to save some overhead), but this serves to allow normal definitions to use them if desired.
</p>
</div>
</div>
<div id="outline-container-sec-5-5-2" class="outline-4">
<h4 id="sec-5-5-2"><span class="section-number-4">5.5.2</span> stack operations</h4>
<div class="outline-text-4" id="text-5-5-2">
</div><ol class="org-ol"><li>dup<br/><div class="outline-text-5" id="text-5-5-2-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ff00;">dup,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( n-nn ) Duplicate TOS"</span> :doc
</pre>
</div>
</div>
</li>

<li>swap<br/><div class="outline-text-5" id="text-5-5-2-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ff00;">swap,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-yx ) Exchange positions of TOS and NOS"</span> :doc
</pre>
</div>
</div>
</li>
<li>drop<br/><div class="outline-text-5" id="text-5-5-2-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( n- ) Drop TOS from the stack"</span> :doc
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-5-3" class="outline-4">
<h4 id="sec-5-5-3"><span class="section-number-4">5.5.3</span> bitwise operations { also logical operations since true is -1 }</h4>
<div class="outline-text-4" id="text-5-5-3">
</div><ol class="org-ol"><li>and<br/><div class="outline-text-5" id="text-5-5-3-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">and</span> <span style="color: #00ffff;">and</span> <span style="color: #00ff00;">and,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Bitwise AND"</span> :doc
</pre>
</div>
</div>
</li>

<li>or<br/><div class="outline-text-5" id="text-5-5-3-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">or</span> <span style="color: #00ffff;">or</span> <span style="color: #00ff00;">or,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Bitwise OR"</span> :doc
</pre>
</div>
</div>
</li>

<li>xor<br/><div class="outline-text-5" id="text-5-5-3-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">xor</span> <span style="color: #00ffff;">xor</span> <span style="color: #00ff00;">xor,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Bitwise XOR"</span> :doc
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-5-4" class="outline-4">
<h4 id="sec-5-5-4"><span class="section-number-4">5.5.4</span> memory operations</h4>
<div class="outline-text-4" id="text-5-5-4">
</div><ol class="org-ol"><li>@<br/><div class="outline-text-5" id="text-5-5-4-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">@</span> <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-n ) Fetch a value from a memory location"</span> :doc
</pre>
</div>
</div>
</li>

<li>!<br/><div class="outline-text-5" id="text-5-5-4-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">!</span> <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( na- ) Store a value to a memory location"</span> :doc
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-5-5" class="outline-4">
<h4 id="sec-5-5-5"><span class="section-number-4">5.5.5</span> arithmetic operations</h4>
<div class="outline-text-4" id="text-5-5-5">
</div><ol class="org-ol"><li>+<br/><div class="outline-text-5" id="text-5-5-5-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">+</span> <span style="color: #00ff00;">+,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Add two values (x+y)"</span> :doc
</pre>
</div>
</div>
</li>

<li>-<br/><div class="outline-text-5" id="text-5-5-5-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">-</span> <span style="color: #00ffff;">-</span> <span style="color: #00ff00;">-,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Subtract two values (x-y)"</span> :doc
</pre>
</div>
</div>
</li>

<li>*<br/><div class="outline-text-5" id="text-5-5-5-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">*</span> <span style="color: #00ffff;">*</span> <span style="color: #00ff00;">*,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Multiply two values (x*y)"</span> :doc
</pre>
</div>
</div>
</li>

<li>/mod<br/><div class="outline-text-5" id="text-5-5-5-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">/mod</span> <span style="color: #00ffff;">/mod</span> <span style="color: #00ff00;">/mod,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-rq ) Divide and Remainder. This performs symmetric division"</span> :doc
</pre>
</div>
</div>
</li>

<li>&lt;&lt; { shift left, or multiply by 2 }<br/><div class="outline-text-5" id="text-5-5-5-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">&lt;&lt;</span> <span style="color: #00ffff;">&lt;&lt;</span> <span style="color: #00ff00;">&lt;&lt;,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Shift bits left (x&lt;&lt;y)"</span> :doc
</pre>
</div>
</div>
</li>

<li>&gt;&gt; { shift right, or divide by 2 }<br/><div class="outline-text-5" id="text-5-5-5-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">&gt;&gt;</span> <span style="color: #00ffff;">&gt;&gt;</span> <span style="color: #00ff00;">&gt;&gt;,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-n ) Shift bits right (x&gt;&gt;y)"</span> :doc
</pre>
</div>
</div>
</li>

<li>1-<br/><div class="outline-text-5" id="text-5-5-5-7">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">1-</span>  <span style="color: #00ffff;">1-</span>  <span style="color: #00ff00;">1-,</span> <span style="color: #c63; font-weight: bold;">;</span>
"( n-n ) Decrement TOS by <span style="color: #32cd32;">1</span> " :doc
</pre>
</div>
</div>
</li>

<li>1+<br/><div class="outline-text-5" id="text-5-5-5-8">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> <span style="color: #00ffff;">1+</span>  <span style="color: #00ffff;">1+</span>  1+, <span style="color: #c63; font-weight: bold;">;</span>
"( n-n ) Increment TOS by <span style="color: #32cd32;">1</span> " :doc
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-5-6" class="outline-4">
<h4 id="sec-5-5-6"><span class="section-number-4">5.5.6</span> i/o operations</h4>
<div class="outline-text-4" id="text-5-5-6">
</div><ol class="org-ol"><li>out<br/><div class="outline-text-5" id="text-5-5-6-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> out out <span style="color: #00ff00;">out,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( np- ) Write a value to an I/O port"</span> :doc
</pre>
</div>
</div>
</li>

<li>in<br/><div class="outline-text-5" id="text-5-5-6-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">p:</span> in in <span style="color: #00ff00;">in,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( p-n ) Read a value from an I/O port"</span> :doc
</pre>
</div>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> <code>[2/9]</code> Additional stack, variable, and math functions.</h3>
<div class="outline-text-3" id="text-5-6">
</div><div id="outline-container-sec-5-6-1" class="outline-4">
<h4 id="sec-5-6-1"><span class="section-number-4">5.6.1</span> <span class="done DONE">DONE</span> wait</h4>
<div class="outline-text-4" id="text-5-6-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> wait wait <span style="color: #32cd32;">0</span> # <span style="color: #32cd32;">0</span> # <span style="color: #00ff00;">out,</span> <span style="color: #00ff00;">wait,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Wait for an I/O event"</span> :doc
</pre>
</div>

<p>
The "wait," instruction needs a bit of extra help to actually trigger an I/O event. This provides it.
</p>
</div>
</div>
<div id="outline-container-sec-5-6-2" class="outline-4">
<h4 id="sec-5-6-2"><span class="section-number-4">5.6.2</span> <span class="todo TODO">TODO</span> over</h4>
<div class="outline-text-4" id="text-5-6-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">over</span> <span style="color: #00ff00;">push,</span> <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">pop,</span> <span style="color: #00ff00;">swap,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-xyx ) Place a copy of NOS over TOS"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-6-3" class="outline-4">
<h4 id="sec-5-6-3"><span class="section-number-4">5.6.3</span> <span class="todo TODO">TODO</span> not</h4>
<div class="outline-text-4" id="text-5-6-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">not</span> <span style="color: #00ffff;">not</span> <span style="color: #32cd32;">-1</span> # <span style="color: #00ff00;">xor,</span> <span style="color: #c63; font-weight: bold;">;</span>
"( x-y ) Same as <span style="color: #32cd32;">-1</span> xor; invert TOS <span style="color: #00ffff;">and</span> subtract 1" :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-6-4" class="outline-4">
<h4 id="sec-5-6-4"><span class="section-number-4">5.6.4</span> <span class="todo TODO">TODO</span> on</h4>
<div class="outline-text-4" id="text-5-6-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">on</span> <span style="color: #00ffff;">on</span> <span style="color: #32cd32;">-1</span> # <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>
"( a- ) Set a <span style="color: #c63; font-weight: bold;">variable</span> to <span style="color: #32cd32;">-1</span> (true)" :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-6-5" class="outline-4">
<h4 id="sec-5-6-5"><span class="section-number-4">5.6.5</span> <span class="todo TODO">TODO</span> off</h4>
<div class="outline-text-4" id="text-5-6-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">off</span> <span style="color: #00ffff;">off</span> <span style="color: #32cd32;">0</span> # <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>
"( a- ) Set a <span style="color: #c63; font-weight: bold;">variable</span> to  <span style="color: #32cd32;">0</span> (false)" :doc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-6" class="outline-4">
<h4 id="sec-5-6-6"><span class="section-number-4">5.6.6</span> <span class="todo TODO">TODO</span> <code>/</code> and <code>mod</code></h4>
<div class="outline-text-4" id="text-5-6-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">/</span> <span style="color: #00ffff;">/</span> <span style="color: #00ff00;">/mod,</span> <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-q ) Divide two numbers (x/y)"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">mod</span> <span style="color: #00ffff;">mod</span> <span style="color: #00ff00;">/mod,</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-r ) Modulus of two numbers (x%y)"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-6-7" class="outline-4">
<h4 id="sec-5-6-7"><span class="section-number-4">5.6.7</span> <span class="todo TODO">TODO</span> negate</h4>
<div class="outline-text-4" id="text-5-6-7">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> negate negate <span style="color: #32cd32;">-1</span> # <span style="color: #00ff00;">*,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( x-y ) Invert sign of TOS"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-6-8" class="outline-4">
<h4 id="sec-5-6-8"><span class="section-number-4">5.6.8</span> <span class="done DONE">DONE</span> do</h4>
<div class="outline-text-4" id="text-5-6-8">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ff00;">1-,</span> <span style="color: #00ff00;">push,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a- ) Call a function by address"</span> :doc
</pre>
</div>

<p>
This is used to invoke a function. The =1-,= is used to account for the way the
VM increments the instruction pointer.
</p>
</div>
</div>
<div id="outline-container-sec-5-6-9" class="outline-4">
<h4 id="sec-5-6-9"><span class="section-number-4">5.6.9</span> <span class="todo TODO">TODO</span> @+ / !+</h4>
<div class="outline-text-4" id="text-5-6-9">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">@+</span> <span style="color: #00ffff;">@+</span> <span style="color: #00ff00;">dup,</span> 1+, <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-ac ) Fetch a value from an address, return the next address and the value"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ff00;">dup,</span> 1+, <span style="color: #00ff00;">push,</span> <span style="color: #00ff00;">!,</span> <span style="color: #00ff00;">pop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ca-a ) Store a value to an address, return next address"</span> :doc
</pre>
</div>

<p>
Rather handy functions for "fetch from and return next" and "store to and return next". This allows easy access to linear arrays or strings:
</p>

<pre class="example">
( an example of using @+ )
create array 1 , 2 , 3 ,
array @+ putn @+ putn @+ putn drop
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> <span class="todo TODO">TODO</span> Core Compiler: <code>here</code> .. <code>pop</code></h3>
<div class="outline-text-3" id="text-5-7">
<p>
Continuing on, we now have the core of the actual colon compiler:
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">here</span> <span style="color: #00ffff;">here</span> <span style="color: #00ffff;">heap</span> # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -a ) Next free address in **heap**"</span> :doc

<span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #ffd700; font-weight: bold;">;;</span> <span style="color: #ffd700; font-weight: bold;">;;</span> <span style="color: #32cd32;">9</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Compile an exit into a function, but do not stop compilation"</span> :doc

<span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #c63; font-weight: bold;">;</span> t-;  <span style="color: #ffd700; font-weight: bold;">;;</span> <span style="color: #ffd700; font-weight: bold;">;;</span> compiler # <span style="color: #00ffff;">off</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Compile an exit into a function and stop the compiler"</span> :doc

<span style="color: #c63; font-weight: bold;">i:</span> ($,) <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">@+</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ a-a ] internal helper function for inlining strings )</span>

<span style="color: #c63; font-weight: bold;">i:</span> $ ($,) <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ a- ] internal helper function for inlining strings )</span>

<span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #00ffff;">push</span> <span style="color: #00ffff;">push</span> <span style="color: #32cd32;">5</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( n- ) Push a value to the address stack"</span> :doc

<span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #00ffff;">pop</span>  <span style="color: #00ffff;">pop</span>  <span style="color: #32cd32;">6</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -n ) Pop a value off the address stack"</span> :doc
</pre>
</div>
</div>

<div id="outline-container-sec-5-7-1" class="outline-4">
<h4 id="sec-5-7-1"><span class="section-number-4">5.7.1</span> | core compiler</h4>
<div class="outline-text-4" id="text-5-7-1">
</div><ol class="org-ol"><li>t: here     (  -a )  heap # @, ;<br/></li>
<li>t: ,        ( n-  )  here !+ heap # !, ;<br/><div class="outline-text-5" id="text-5-7-1-2">
<p>
Note the use of "!+" in ",". This is a clean way of implementing this
functionality.
</p>
</div>
</li>
<li>t: ;;       (  -  )  #9 , ;<br/></li>
<li>t: t-;      (  -  )  ;; ;; compiler # off ;<br/><div class="outline-text-5" id="text-5-7-1-4">
<p>
For terminating definitions. These are exposed as ";;" and ";", respectively.
We allow the "t-" prefix to avoid confusion with the ";" provided by the
metacompiler.
</p>

<p>
TIP:
</p>

<p>
If you are pressed for space, you can save a fair amount of memory by
removing the second ";;" here.
</p>

<p>
And back to the code:
</p>
</div>
</li>
<li>t: ($,)     ( a-a )  repeat @+ 0; , again ;<br/></li>
<li>t: $        ( a-  )  ($,) drop, #0 , ;<br/><div class="outline-text-5" id="text-5-7-1-6">
<p>
This is used to compile a string into memory. We'll see how it is used
when we get to ":".
</p>

<p>
Since we lack any counted loops, the "($,)" has been factored out into a
separate definition.
</p>
</div>
</li>
<li>t: push     ( n-  )  #5 , ;<br/></li>
<li>t: pop      (  -n )  #6 , ;<br/><div class="outline-text-5" id="text-5-7-1-8">
<p>
These are exposed as macros; they lay down push, and pop, instructions when
executed.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8"><span class="section-number-3">5.8</span> <span class="todo TODO">TODO</span> Conditionals and Flow Control : <code>0;</code> .. <code>again</code></h3>
<div class="outline-text-3" id="text-5-8">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #ffd700; font-weight: bold;">0;</span> t-0; <span style="color: #32cd32;">25</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( n-n || n- ) If TOS is not zero, do nothing. If TOS is zero, drop TOS and exit the function"</span> :doc

<span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> t-repeat <span style="color: #00ffff;">here</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( R: - C: -a ) Start an unconditional loop"</span> :doc

<span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #ffd700; font-weight: bold;">again</span> t-again  <span style="color: #32cd32;">8</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( R: -  C: a- ) Jump to the code following the most recent **repeat**"</span> :doc
</pre>
</div>
</div>
<div id="outline-container-sec-5-8-1" class="outline-4">
<h4 id="sec-5-8-1"><span class="section-number-4">5.8.1</span> | conditionals / flow control</h4>
<div class="outline-text-4" id="text-5-8-1">
</div><ol class="org-ol"><li>t: t-0;     ( n-n   ||   n- )  #25 , ;<br/></li>
<li>t: t-repeat ( R: -    C: -a )  here ;<br/></li>
<li>t: t-again  ( R: -    C: a- )  #8 , , ;<br/><div class="outline-text-5" id="text-5-8-1-3">
<p>
Primitive flow control and conditionals. At this point we have to use
these, as there's no quotes in the initial kernel.
</p>

<p>
Note the continued use of "t-" as a prefix to avoid confusion with the
functions in the metacompiler.
</p>

<p>
Most of these will be hidden at the end of the core.rx source.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-5-9" class="outline-3">
<h3 id="sec-5-9"><span class="section-number-3">5.9</span> <span class="todo TODO">TODO</span> Console Output</h3>
<div class="outline-text-3" id="text-5-9">
</div><div id="outline-container-sec-5-9-1" class="outline-4">
<h4 id="sec-5-9-1"><span class="section-number-4">5.9.1</span> <span class="done DONE">DONE</span> DEF <code>update</code></h4>
<div class="outline-text-4" id="text-5-9-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #32cd32;">-1</span> <span style="color: #c63; font-weight: bold;">variable:</span> update
</pre>
</div>

<p>
This variable is used to control whether or not the display is updated. On
some VM implementations, you can improve performance by turning it "off" before
writing large amounts of text to the screen, then "on" when done.
</p>
</div>
</div>
<div id="outline-container-sec-5-9-2" class="outline-4">
<h4 id="sec-5-9-2"><span class="section-number-4">5.9.2</span> <span class="todo TODO">TODO</span> def redraw - puts</h4>
<div class="outline-text-4" id="text-5-9-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> redraw redraw update # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">0</span> # <span style="color: #32cd32;">3</span> # <span style="color: #00ff00;">out,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Update the display. Can be disabled temporarily by **update**"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> putc putc <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #32cd32;">1</span> # <span style="color: #32cd32;">2</span> # <span style="color: #00ff00;">out,</span> wait redraw <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( c- ) Display a character"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> cr cr <span style="color: #32cd32;">10</span> # putc <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Display a newline character"</span> :doc

<span style="color: #c63; font-weight: bold;">i:</span> (puts) <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">@+</span> <span style="color: #ffd700; font-weight: bold;">0;</span> putc <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ a-a ] helper for **puts** )</span>

<span style="color: #c63; font-weight: bold;">w:</span> &lt;puts&gt; &lt;puts&gt; (puts) <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $- ) Helper; default way to display strings"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> puts puts &lt;puts&gt; <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $- ) Display a string"</span> :doc
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5-10" class="outline-3">
<h3 id="sec-5-10"><span class="section-number-3">5.10</span> <span class="todo TODO">TODO</span> Console Input <code>break</code> / <code>keyXXX</code> .. <code>accept</code></h3>
<div class="outline-text-3" id="text-5-10">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">variable</span>  break                       <span style="color: #66f;">( Holds the delimiter for 'accept'   )</span>

<span style="color: #32cd32;">-1</span> <span style="color: #c63; font-weight: bold;">variable:</span> remapping                   <span style="color: #66f;">( Allow extended whitespace?         )</span>

<span style="color: #32cd32;">-1</span> <span style="color: #c63; font-weight: bold;">variable:</span> eatLeading?                 <span style="color: #66f;">( Eat leading delimiters?            )</span>

<span style="color: #32cd32;">-1</span> <span style="color: #c63; font-weight: bold;">variable:</span> tabAsWhitespace

 <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">variable:</span> keymap
keymap <span style="color: #c63; font-weight: bold;">data:</span> keymap
<span style="color: #00ff00;">"( -a ) Variable, determines whether or not to use the keymap"</span> :doc

 <span style="color: #32cd32;">9</span> <span style="color: #c63; font-weight: bold;">variable:</span> keymap:PREFIX
keymap:PREFIX <span style="color: #c63; font-weight: bold;">data:</span> keymap:PREFIX
<span style="color: #00ff00;">"( -a ) Variable, holds prefix for triggering keymap lookups. Default is #9 (tab)"</span> :doc

 <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">variable:</span> keymap:TABLE
<span style="color: #32cd32;">256</span> tallot
keymap:TABLE <span style="color: #c63; font-weight: bold;">data:</span> keymap:TABLE
<span style="color: #00ff00;">"( -a ) Variable, jump table for keymap handlers"</span> :doc


<span style="color: #c63; font-weight: bold;">w:</span> STRING-LENGTH STRING-LENGTH  <span style="color: #32cd32;">256</span> # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -n ) Return the max length for a string"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> STRING-BUFFERS STRING-BUFFERS <span style="color: #32cd32;">12</span> # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -n ) Return number of temporary string buffers"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">tib</span> <span style="color: #00ffff;">tib</span> memory # <span style="color: #00ff00;">@,</span> STRING-LENGTH <span style="color: #00ffff;">-</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"(  -a ) Returns address of text input buffer"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> remapKeys remapKeys <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( c-c ) Remap one ASCII value to another"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> remap:whitespace remap:whitespace
   <span style="color: #00ff00;">dup,</span>  <span style="color: #32cd32;">127</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">drop,</span>  <span style="color: #32cd32;">8</span> # <span style="color: #ffd700; font-weight: bold;">then</span>
   <span style="color: #00ff00;">dup,</span>   <span style="color: #32cd32;">13</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">10</span> # <span style="color: #ffd700; font-weight: bold;">then</span>
   remapping # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span>
   <span style="color: #00ff00;">dup,</span>   <span style="color: #32cd32;">10</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">32</span> # <span style="color: #ffd700; font-weight: bold;">then</span>
   tabAsWhitespace # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span> <span style="color: #00ff00;">dup,</span> <span style="color: #32cd32;">9</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">32</span> # <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( c-c ) helper for remapping whitespace"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> getc:unfiltered getc:unfiltered <span style="color: #32cd32;">1</span> # <span style="color: #32cd32;">1</span> # <span style="color: #00ff00;">out,</span> wait <span style="color: #32cd32;">1</span> # <span style="color: #00ff00;">in,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -c ) Read a keypress and return the ASCII value on the stack"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> getc:with/remap getc:with/remap
  <span style="color: #ffd700; font-weight: bold;">repeat</span> getc:unfiltered remapKeys <span style="color: #00ff00;">dup,</span> <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> remap:whitespace <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -c ) Read a keypress and return the ASCII value on the stack.\nThis differs from **getc:unfiltered** in that the key value is processed\nby **remapKeys** before being returned.\nUnlike **getc** it does not attempt to support the keymaps."</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> keymap:handler keymap:handler
  <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( c-c ) handle keymaps"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> getc getc
  <span style="color: #ffd700; font-weight: bold;">repeat</span> getc:unfiltered keymap:handler remapKeys <span style="color: #00ff00;">dup,</span> <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> remap:whitespace <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -c ) Read a keypress and return the ASCII value on the stack.\nBoth remapping and keymaps are handled by this."</span> :doc

<span style="color: #c63; font-weight: bold;">i:</span> putc? <span style="color: #00ff00;">dup,</span> <span style="color: #32cd32;">8</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">drop,</span> break # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">dup,</span> putc <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ c-c ] helper to display characters and backspaces properly )</span>

<span style="color: #c63; font-weight: bold;">i:</span> eat    <span style="color: #66f;">( a-a )</span>
   eatLeading? # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span>
   <span style="color: #ffd700; font-weight: bold;">repeat</span> getc putc? <span style="color: #00ff00;">dup,</span> break # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">!if</span> <span style="color: #00ff00;">swap,</span> <span style="color: #00ffff;">!+</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ a-a ] helper function to eat leading delimiters )</span>

<span style="color: #c63; font-weight: bold;">i:</span> guard? <span style="color: #00ff00;">dup,</span> 1+, <span style="color: #00ffff;">tib</span> <span style="color: #ffd700; font-weight: bold;">&lt;if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #00ffff;">tib</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #32cd32;">8</span> # putc <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ n-n ] helper to prevent backspacing to before start of buffer )</span>

<span style="color: #c63; font-weight: bold;">i:</span> (accept)
   <span style="color: #ffd700; font-weight: bold;">repeat</span>
     getc
     <span style="color: #00ff00;">dup,</span> <span style="color: #32cd32;">8</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #00ff00;">1-,</span> guard? <span style="color: #c63; font-weight: bold;">jump:</span> (accept) <span style="color: #ffd700; font-weight: bold;">then</span>
     <span style="color: #00ff00;">dup,</span> putc
     <span style="color: #00ff00;">dup,</span> break # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span>
     <span style="color: #00ff00;">swap,</span> <span style="color: #00ffff;">!+</span>
   <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ a-a ] internal implementation of **accept** )</span>

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">accept</span> <span style="color: #00ffff;">accept</span> break # <span style="color: #00ff00;">!,</span> <span style="color: #00ffff;">tib</span> eat (accept) <span style="color: #32cd32;">0</span> # <span style="color: #00ff00;">swap,</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( c- ) Read a string, ending with the specified character. The string is returned in **tib**"</span> :doc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-11" class="outline-3">
<h3 id="sec-5-11"><span class="section-number-3">5.11</span> <span class="todo TODO">TODO</span> | console input</h3>
<div class="outline-text-3" id="text-5-11">
</div><div id="outline-container-sec-5-11-1" class="outline-4">
<h4 id="sec-5-11-1"><span class="section-number-4">5.11.1</span> t: redraw (  -  ) update # @, 0; drop, #0 #3 out, ;</h4>
<div class="outline-text-4" id="text-5-11-1">
<p>
Attempt to flush the output buffers.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-2" class="outline-4">
<h4 id="sec-5-11-2"><span class="section-number-4">5.11.2</span> t: putc   ( c-  ) 0; #1 #2 out, wait redraw ;</h4>
<div class="outline-text-4" id="text-5-11-2">
<p>
Display an ASCII (or possibly unicode) character.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-3" class="outline-4">
<h4 id="sec-5-11-3"><span class="section-number-4">5.11.3</span> t: cr     (  -  ) #10 putc ;</h4>
<div class="outline-text-4" id="text-5-11-3">
<p>
Move the text cursor to the start of the next line.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-4" class="outline-4">
<h4 id="sec-5-11-4"><span class="section-number-4">5.11.4</span> t: (puts) ( a-a ) repeat @+ 0; putc again ;</h4>
</div>
<div id="outline-container-sec-5-11-5" class="outline-4">
<h4 id="sec-5-11-5"><span class="section-number-4">5.11.5</span> t: &lt;puts&gt; ( a-  ) (puts) drop, ;</h4>
</div>
<div id="outline-container-sec-5-11-6" class="outline-4">
<h4 id="sec-5-11-6"><span class="section-number-4">5.11.6</span> t: puts   ( a-  ) &lt;puts&gt; ;</h4>
<div class="outline-text-4" id="text-5-11-6">
<p>
These are used to display a string. "(puts)" is not exposed to the global
dictionary, but the others are. "&lt;puts&gt;" is replaced in stage 3 with code
allowing for formatted output. Generally, user code should only call "puts".
</p>

<p>
variable break                           ( Holds the delimiter for 'accept' )
-1 variable: remapping                   ( Allow extended whitespace?       )
-1 variable: eatLeading?                 ( Eat leading delimiters?          )
-1 variable: tabAsWhitespace
</p>

<p>
These should be understandable by the comments.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-7" class="outline-4">
<h4 id="sec-5-11-7"><span class="section-number-4">5.11.7</span> t: tib ( -a ) TIB # ;</h4>
<div class="outline-text-4" id="text-5-11-7">
<p>
Return a pointer to the text input buffer. This allows for temporary (or long
term) moving of the TIB to allow for longer strings.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-8" class="outline-4">
<h4 id="sec-5-11-8"><span class="section-number-4">5.11.8</span> t: remapKeys ( c-c ) ;</h4>
<div class="outline-text-4" id="text-5-11-8">
<p>
A hook to allow runtime remapping of one character to another during input.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-9" class="outline-4">
<h4 id="sec-5-11-9"><span class="section-number-4">5.11.9</span> t: ws        ( c-c )</h4>
<div class="outline-text-4" id="text-5-11-9">
<p>
dup, #127 =if drop,  #8 then
dup,  #13 =if drop, #10 then
remapping # @, 0; drop,
dup, #10 =if drop, #32 then
tabAsWhitespace # @, #0 !if dup,  #9 =if drop, #32 then then ;
</p>

<p>
Remapping of whitespace. Generally, this will take care of backspaces on OS X,
cr/lf pairs under Windows, and optionally turn tabs into spaces.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-10" class="outline-4">
<h4 id="sec-5-11-10"><span class="section-number-4">5.11.10</span> t: &lt;getc&gt; (  -c ) #1 #1 out, wait #1 in, ;</h4>
</div>
<div id="outline-container-sec-5-11-11" class="outline-4">
<h4 id="sec-5-11-11"><span class="section-number-4">5.11.11</span> t: getc   (  -c ) repeat &lt;getc&gt; remapKeys dup #0 !if ws ; then drop, again ;</h4>
<div class="outline-text-4" id="text-5-11-11">
<p>
Read a key from the keyboard. This is exposed as "getc", and calls "remapKeys"
and "ws" to remap things before returning them on the stack.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-12" class="outline-4">
<h4 id="sec-5-11-12"><span class="section-number-4">5.11.12</span> t: putc?  ( n-n ) dup, #8 =if drop, break # @, ; then dup, putc ;</h4>
<div class="outline-text-4" id="text-5-11-12">
<p>
Display a character if not backspace.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-13" class="outline-4">
<h4 id="sec-5-11-13"><span class="section-number-4">5.11.13</span> t: eat    ( a-a )</h4>
<div class="outline-text-4" id="text-5-11-13">
<p>
eatLeading? # @, 0; drop
repeat getc putc? dup, break # @, !if swap, !+ ; then drop, again ;
</p>

<p>
If we want to discard leading delimiters, this will ignore input until it
encounters a non-delimiter character.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-14" class="outline-4">
<h4 id="sec-5-11-14"><span class="section-number-4">5.11.14</span> t: guard? ( n-n ) dup, 1+, tib &lt;if drop, tib ; then #8 putc ;</h4>
<div class="outline-text-4" id="text-5-11-14">
<p>
This is used to prevent backspaces from going before the start of the TIB.
</p>
</div>
</div>
<div id="outline-container-sec-5-11-15" class="outline-4">
<h4 id="sec-5-11-15"><span class="section-number-4">5.11.15</span> t: (accept) ( a-a )</h4>
<div class="outline-text-4" id="text-5-11-15">
<p>
repeat
  getc
  dup, #8 =if drop, 1-, guard? jump: (accept) then
  dup, putc
  dup, break # @, =if drop, ; then
  swap, !+
again ;
</p>
</div>
</div>

<div id="outline-container-sec-5-11-16" class="outline-4">
<h4 id="sec-5-11-16"><span class="section-number-4">5.11.16</span> t: accept ( c- ) break # !, tib eat (accept) #0 swap, !+ drop, ;</h4>
<div class="outline-text-4" id="text-5-11-16">
<p>
Read input into the TIB, ending when the delimiter is encountered.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-12" class="outline-3">
<h3 id="sec-5-12"><span class="section-number-3">5.12</span> <code>[7/8]</code> Colon Compiler :  <code>vector</code> .. <code>( .. )</code></h3>
<div class="outline-text-3" id="text-5-12">
</div><div id="outline-container-sec-5-12-1" class="outline-4">
<h4 id="sec-5-12-1"><span class="section-number-4">5.12.1</span> <span class="done DONE">DONE</span> VAR vector</h4>
<div class="outline-text-4" id="text-5-12-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #32cd32;">-1</span> <span style="color: #c63; font-weight: bold;">variable:</span> vector
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-12-2" class="outline-4">
<h4 id="sec-5-12-2"><span class="section-number-4">5.12.2</span> <span class="done DONE">DONE</span> DEF { dictionary field accessors }</h4>
<div class="outline-text-4" id="text-5-12-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> d-&gt;class d-&gt;class  1+, <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-a ) Given a dictionary header, return the address of the class handler. Use **@** to get the actual pointer."</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> d-&gt;xt d-&gt;xt 1+, 1+, <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-a ) Given a dictionary header, return the address of the function start (*xt*). Use **@** to get the actual pointer."</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> d-&gt;doc d-&gt;doc <span style="color: #32cd32;">3</span> # <span style="color: #00ff00;">+,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-a ) Given a dictionary header, return the address of a documentation string. Use **@** to get the actual pointer."</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> d-&gt;name d-&gt;name  <span style="color: #32cd32;">4</span> # <span style="color: #00ff00;">+,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-a ) Given a dictionary header, return the address of the name. This is the actual start of the  name."</span> :doc
</pre>
</div>

<p>
These are dictionary field accessors. Our dictionary is a linked list, with
a structure of:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="right"/>

<col class="left"/>
</colgroup>
<tbody>
<tr>
<td class="right">0</td>
<td class="left">link to previous</td>
</tr>

<tr>
<td class="right">1</td>
<td class="left">class handler</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">xt</td>
</tr>

<tr>
<td class="right">3+</td>
<td class="left">name of function</td>
</tr>
</tbody>
</table>

<p>
The accessors give us a clean, and portable, way to access the various fields.
</p>
</div>
</div>
<div id="outline-container-sec-5-12-3" class="outline-4">
<h4 id="sec-5-12-3"><span class="section-number-4">5.12.3</span> <span class="done DONE">DONE</span> DEF header</h4>
<div class="outline-text-4" id="text-5-12-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> header header  <span style="color: #00ff00;">push,</span> <span style="color: #00ffff;">here</span>        <span style="color: #66f;">( Entry Start      )</span>
                     last # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">,</span>       <span style="color: #66f;">( Link to previous )</span>
                     last # <span style="color: #00ff00;">!,</span>         <span style="color: #66f;">( Set as newest    )</span>
                     <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.data</span> # <span style="color: #c63; font-weight: bold;">,</span>       <span style="color: #66f;">( Class = .data    )</span>
                     <span style="color: #00ffff;">here</span> <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">,</span>        <span style="color: #66f;">( XT               )</span>
                     <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">,</span>             ( Pointer to docstr)
                     <span style="color: #00ff00;">pop,</span> $            <span style="color: #66f;">( Name             )</span>
                     <span style="color: #00ffff;">here</span> <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>   <span style="color: #66f;">( Patch XT to HERE )</span>
<span style="color: #00ff00;">"( $- ) Given a name, create a new header with a class of **.data**"</span> :doc
</pre>
</div>

<p>
Given a string, this creates a header pointing the xt to the cell following
the header, and assigning a class of ".data" to it. This is used by:
</p>
</div>
</div>
<div id="outline-container-sec-5-12-4" class="outline-4">
<h4 id="sec-5-12-4"><span class="section-number-4">5.12.4</span> <span class="done DONE">DONE</span> DEF create</h4>
<div class="outline-text-4" id="text-5-12-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #32cd32;">32</span> # <span style="color: #00ffff;">accept</span> <span style="color: #00ffff;">tib</span> header <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) Parse for a name and call **header**"</span> :doc
</pre>
</div>

<p>
"create" which parses for a name, then creates the header. Note here that
"accept" does not return a pointer to the tib; that is up to you to obtain
if needed.
</p>
</div>
</div>

<div id="outline-container-sec-5-12-5" class="outline-4">
<h4 id="sec-5-12-5"><span class="section-number-4">5.12.5</span> <span class="todo TODO">TODO</span> DEF <code>:</code> { the "colon compiler" }</h4>
<div class="outline-text-4" id="text-5-12-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> vector?  vector # <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">:</span>   <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.word</span> # last # <span style="color: #00ff00;">@,</span> d-&gt;class <span style="color: #00ff00;">!,</span> <span style="color: #00ffff;">]]</span> vector? <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) Calls **create**, changes class to **.word**, and turns **compiler** on."</span> :doc
</pre>
</div>

<p>
t: (:)      (  -  )  last # @, d-&gt;class !, compiler # on #0 , #0 , ;
t: :        ( "-  )  create ' .word # (:) ;
</p>


<p>
The colon compiler in all it's glory. "create" a header, assign it a class of
".word", lay down two nop's (for revectoring purposes), and set the compiler
to "on".
</p>

<p>
At this point we no longer need the old ":" from the old image, so we can
reuse the name here, rather than start it off with a "t-" prefix.
</p>
</div>
</div>
<div id="outline-container-sec-5-12-6" class="outline-4">
<h4 id="sec-5-12-6"><span class="section-number-4">5.12.6</span> <span class="done DONE">DONE</span> DEF <code>[[</code></h4>
<div class="outline-text-4" id="text-5-12-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #00ffff;">[[</span> <span style="color: #00ffff;">[[</span> compiler # <span style="color: #00ffff;">off</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Turn compiler off"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-12-7" class="outline-4">
<h4 id="sec-5-12-7"><span class="section-number-4">5.12.7</span> <span class="done DONE">DONE</span> DEF <code>]]</code></h4>
<div class="outline-text-4" id="text-5-12-7">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">]]</span> <span style="color: #00ffff;">]]</span> compiler # <span style="color: #00ffff;">on</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Turn compiler on"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-12-8" class="outline-4">
<h4 id="sec-5-12-8"><span class="section-number-4">5.12.8</span> <span class="done DONE">DONE</span> MACRO ( { the comment-ignorer }</h4>
<div class="outline-text-4" id="text-5-12-8">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">m:</span> ( t-(  ') # <span style="color: #00ffff;">accept</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) Parse for ) and ignore everything it reads"</span> :doc
</pre>
</div>

<p>
Allow for comments. Eats everything up to a ")", and then exits.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5-13" class="outline-3">
<h3 id="sec-5-13"><span class="section-number-3">5.13</span> <code>[0/1]</code> Quotes : <code>quote</code> .. <code>[ .. ]</code></h3>
<div class="outline-text-3" id="text-5-13">
</div><div id="outline-container-sec-5-13-1" class="outline-4">
<h4 id="sec-5-13-1"><span class="section-number-4">5.13.1</span> <span class="todo TODO">TODO</span> reference diagram</h4>
<div class="outline-text-4" id="text-5-13-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Quotes ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #66f;">( reference diagram:                                           )</span>
<span style="color: #66f;">(                                                              )</span>
<span style="color: #66f;">(  step       generated code.                                  )</span>
<span style="color: #66f;">(  -------    ----------------                                 )</span>
<span style="color: #66f;">(  [          &lt;quote&gt; 0000                                     )</span>
<span style="color: #66f;">(  [ 5        &lt;quote&gt; 0000 &lt;lit&gt; 0005                          )</span>
<span style="color: #66f;">(  [ 5 ]      &lt;quote&gt; ADDR &lt;lit&gt; 0005 &lt;ret&gt;                    )</span>
<span style="color: #66f;">(                                                              )</span>
<span style="color: #66f;">( ADDR will be same as "here" immediately after compilation    )</span>
<span style="color: #66f;">(                                                              )</span>
<span style="color: #66f;">( &lt;quote&gt; is the xt for "quote" - 711 as of retro 11.5 . This  )</span>
<span style="color: #66f;">( changes with kernel/meta.rx but the number should always be  )</span>
<span style="color: #66f;">( the same as both:  ' quote     and:  d' quote @d-&gt;xt         )</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-13-2" class="outline-4">
<h4 id="sec-5-13-2"><span class="section-number-4">5.13.2</span> def quote</h4>
<div class="outline-text-4" id="text-5-13-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> quote quote <span style="color: #66f;">( -a  )</span> <span style="color: #66f;">( -- runtime -------------------------------- )</span>
  <span style="color: #00ff00;">pop,</span> <span style="color: #00ffff;">1+</span>        <span style="color: #66f;">(   -a  | grab the return address, add 1, and )</span>
  <span style="color: #00ff00;">dup,</span>           <span style="color: #66f;">(  a-aa | dup, giving two pointers to ADDR    )</span>
  <span style="color: #00ff00;">@,</span>             <span style="color: #66f;">( aa-aA | dereference one for actual target   )</span>
  <span style="color: #00ff00;">1-,</span>            <span style="color: #66f;">( aa-aA | subtract 1 because ip++ in ngaro vm )</span>
  <span style="color: #00ff00;">push,</span>          <span style="color: #66f;">( aA-a  | push result to do a calculated jump )</span>
  1+, <span style="color: #c63; font-weight: bold;">;</span>          <span style="color: #66f;">(  a-a  | point to start of code, jump to end )</span>
<span style="color: #00ff00;">"( -a ) Helper function for quotations"</span> :doc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-13-3" class="outline-4">
<h4 id="sec-5-13-3"><span class="section-number-4">5.13.3</span> def [</h4>
<div class="outline-text-4" id="text-5-13-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #66f;">( -a )</span>      <span style="color: #66f;">( -- compile-time---------------------------- )</span>
  <span style="color: #c63; font-weight: bold;">'</span> quote # <span style="color: #c63; font-weight: bold;">,</span>    <span style="color: #66f;">(   -   | compile a call to quote             )</span>
  <span style="color: #00ffff;">here</span>           <span style="color: #66f;">(   -a  | remember where to put ADDR          )</span>
  <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">,</span>          <span style="color: #66f;">(  a-a  | leave a cell to hold it later       )</span>
  compiler # <span style="color: #00ff00;">@,</span>  <span style="color: #66f;">(  a-af | store current compiler state        )</span>
  compiler # <span style="color: #00ffff;">on</span>  <span style="color: #66f;">( af-af | turn the compiler on                )</span>
  <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Start a quote (code block)"</span> :doc
</pre>
</div>
</div>
<ol class="org-ol"><li><span class="todo TODO">TODO</span> t: [        (    -naa ) compiler # @, #8 , here #0 , here compiler # on ;<br/></li></ol>
</div>

<div id="outline-container-sec-5-13-4" class="outline-4">
<h4 id="sec-5-13-4"><span class="section-number-4">5.13.4</span> def ]</h4>
<div class="outline-text-4" id="text-5-13-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">m:</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">]</span> <span style="color: #66f;">( af- )</span> <span style="color: #66f;">( a = placeholder for quote jump, f = old compile state  )</span>
   <span style="color: #ffd700; font-weight: bold;">;;</span>            <span style="color: #66f;">( af-af | compile a return from quoted code   )</span>
   compiler # <span style="color: #00ff00;">!,</span> <span style="color: #66f;">( af-a  | restore compiler state              )</span>
   <span style="color: #00ffff;">here</span>          <span style="color: #66f;">(  a-aA | now we know what ADDR should be     )</span>
   <span style="color: #00ffff;">over</span> <span style="color: #00ff00;">!,</span>       <span style="color: #66f;">( aA-a  | so go replace the 00                )</span>
   compiler # <span style="color: #00ff00;">@,</span> <span style="color: #66f;">(  a-af | recall current compile state        )</span>
   <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">=if</span>       <span style="color: #66f;">( af-a  | are we outside of the compiler?     )</span>
                 <span style="color: #66f;">( -- runtime -------------------------------- )</span>
     1+, <span style="color: #c63; font-weight: bold;">;</span>       <span style="color: #66f;">(  a-a  | for interactive, keep ptr to start  )</span>
                 <span style="color: #66f;">( -- compile-time---------------------------- )</span>
   <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span>  <span style="color: #66f;">(  a-   | inside compile mode, just discard.  )</span>
                 <span style="color: #66f;">(       | the call to 'quote will restore it  )</span>
                 <span style="color: #66f;">(       | when the containing function runs   )</span>
<span style="color: #00ff00;">"( -a ) End a quote (code block)"</span> :doc
</pre>
</div>
</div>
<ol class="org-ol"><li><span class="todo TODO">TODO</span> t: ]        ( naa-q   ) push, ;; here swap, !, compiler # !, pop, .data ;<br/><div class="outline-text-5" id="text-5-13-4-1">
<p>
Quotes are anonymous blocks of code. We create them using "[" and "]". The
way they work is this:
</p>

<p>
[ does:
</p>

<ol class="org-ol">
<li>get a copy of the current compiler state
</li>
<li>compile a jump to 0, leaving a pointer to the jump target on the stack
</li>
<li>leave a pointer to the actual code start (after the jump) on the stack
</li>
<li>turn the compiler on
</li>
</ol>

<p>
] does:
</p>

<ol class="org-ol">
<li>move the pointer to the code in the quote out of the way
</li>
<li>compile an exit (";;")
</li>
<li>patch the jump ("here swap !")
</li>
<li>restore the compiler to the saved state ("compiler !")
</li>
<li>restore the pointer to the code in the quote, and call ".data"
</li>
</ol>

<p>
And now on to the base set of combinators&#x2026;
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-5-14" class="outline-3">
<h3 id="sec-5-14"><span class="section-number-3">5.14</span> <span class="todo TODO">TODO</span> Combinators</h3>
<div class="outline-text-3" id="text-5-14">
</div><div id="outline-container-sec-5-14-1" class="outline-4">
<h4 id="sec-5-14-1"><span class="section-number-4">5.14.1</span> { empty }&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-14-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> empty <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ - ] internal helper corresponding to an empty quote )</span>
</pre>
</div>

<p>
This serves as an empty quote, for use in cases where we may not have an
actual action (e.g., "ifTrue", and "ifFalse")
</p>
</div>
</div>
<div id="outline-container-sec-5-14-2" class="outline-4">
<h4 id="sec-5-14-2"><span class="section-number-4">5.14.2</span> t: dip      (  nq-n   ) swap, push, do pop, ;</h4>
<div class="outline-text-4" id="text-5-14-2">
<p>
The "dip" combinator replaces direct use of "push" and "pop" in many cases.
E.g.,
</p>

<p>
( without dip )
1 2 push 3 + pop
</p>

<p>
( with dip )
1 2 [ 3 + ] dip
</p>

<p>
Moving on:
</p>
</div>
</div>
<div id="outline-container-sec-5-14-3" class="outline-4">
<h4 id="sec-5-14-3"><span class="section-number-4">5.14.3</span> if / ifTrue / ifFalse</h4>
<div class="outline-text-4" id="text-5-14-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ff00;">push,</span> <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">pop,</span> <span style="color: #00ff00;">swap,</span> <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( fqq- ) Execute first quote if flag is true, second  if false"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span>   <span style="color: #c63; font-weight: bold;">'</span> empty # <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( fq- ) Execute quote if flag is true"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #ffd700; font-weight: bold;">ifFalse</span> <span style="color: #ffd700; font-weight: bold;">ifFalse</span> <span style="color: #c63; font-weight: bold;">'</span> empty # <span style="color: #00ff00;">swap,</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( fq- ) Execute quote if flag is false"</span> :doc
</pre>
</div>

<p>
Higher level conditional flow control. These execute quotes based on a flag
left by a conditional function. (The conditional functions will be defined
soon)
</p>
</div>
</div>
<div id="outline-container-sec-5-14-4" class="outline-4">
<h4 id="sec-5-14-4"><span class="section-number-4">5.14.4</span> DEF <code>dip</code></h4>
<div class="outline-text-4" id="text-5-14-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">push,</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ff00;">pop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( nq-n ) Call a quote while temporarily hiding the top item on the stack"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-14-5" class="outline-4">
<h4 id="sec-5-14-5"><span class="section-number-4">5.14.5</span> DEF <code>sip</code></h4>
<div class="outline-text-4" id="text-5-14-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">sip</span> <span style="color: #00ffff;">sip</span> <span style="color: #00ffff;">over</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">do</span> # <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( nq-n ) Call a quote with an item on the stack, restoring that item after the quote returns"</span> :doc
</pre>
</div>

<p>
This replaces a <code>dup push &#x2026; pop</code> sequence:
</p>

<pre class="example">
( without sip )
1 dup push 3 + pop

( with sip )
1 [ 3 + ] sip
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-15" class="outline-3">
<h3 id="sec-5-15"><span class="section-number-3">5.15</span> <span class="todo TODO">TODO</span> Boolean constants and Relational Operators</h3>
<div class="outline-text-3" id="text-5-15">
</div><div id="outline-container-sec-5-15-1" class="outline-4">
<h4 id="sec-5-15-1"><span class="section-number-4">5.15.1</span> true and false&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-15-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> false <span style="color: #66f;">(  -n  )</span>  <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ -f ] helper, returns 0 for false )</span>

<span style="color: #c63; font-weight: bold;">i:</span> true  <span style="color: #66f;">(  -n  )</span> <span style="color: #32cd32;">-1</span> # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ -f ] helper, returns -1 for true )</span>
</pre>
</div>

<p>
And now for the promised conditionals:
</p>
</div>
</div>
<div id="outline-container-sec-5-15-2" class="outline-4">
<h4 id="sec-5-15-2"><span class="section-number-4">5.15.2</span> def ==</h4>
<div class="outline-text-4" id="text-5-15-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">=</span>  <span style="color: #00ffff;">=</span>  <span style="color: #66f;">( xy-f  )</span> <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #c63; font-weight: bold;">jump:</span> true  <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> false
<span style="color: #00ff00;">"( xy-f ) Compare two values for equality. Use **==** instead"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> == == <span style="color: #00ffff;">=</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-f ) Compare two values for equality."</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-15-3" class="outline-4">
<h4 id="sec-5-15-3"><span class="section-number-4">5.15.3</span> def !=</h4>
<div class="outline-text-4" id="text-5-15-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">&lt;&gt;</span> <span style="color: #00ffff;">&lt;&gt;</span>  <span style="color: #66f;">( xy-f  )</span> <span style="color: #ffd700; font-weight: bold;">!if</span> <span style="color: #c63; font-weight: bold;">jump:</span> true  <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> false
<span style="color: #00ff00;">"( xy-f ) Compare two values for inequality. Use **!=** instead."</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> != != <span style="color: #00ffff;">&lt;&gt;</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( xy-f ) Compare two values for inequality."</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-15-4" class="outline-4">
<h4 id="sec-5-15-4"><span class="section-number-4">5.15.4</span> def comparisons</h4>
<div class="outline-text-4" id="text-5-15-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #00ffff;">&gt;=</span>  <span style="color: #66f;">( xy-f  )</span> <span style="color: #ffd700; font-weight: bold;">&gt;if</span> <span style="color: #c63; font-weight: bold;">jump:</span> true  <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> false
<span style="color: #00ff00;">"( xy-f ) Compare for greater than or equal to"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">&lt;=</span> <span style="color: #00ffff;">&lt;=</span>  <span style="color: #66f;">( xy-f  )</span> <span style="color: #ffd700; font-weight: bold;">&lt;if</span> <span style="color: #c63; font-weight: bold;">jump:</span> true  <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> false
<span style="color: #00ff00;">"( xy-f ) Compare for less than or equal to"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #00ffff;">&lt;</span>    <span style="color: #66f;">( xy-f  )</span> <span style="color: #ffd700; font-weight: bold;">&gt;if</span> <span style="color: #c63; font-weight: bold;">jump:</span> false <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> true
<span style="color: #00ff00;">"( xy-f ) Compare two values for less than"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #00ffff;">&gt;</span>    <span style="color: #66f;">( xy-f  )</span> <span style="color: #ffd700; font-weight: bold;">&lt;if</span> <span style="color: #c63; font-weight: bold;">jump:</span> false <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> true
<span style="color: #00ff00;">"( xy-f ) Compare two values for greater than"</span> :doc
</pre>
</div>

<p>
All pretty simple, and with names that should be familiar. Note that these
are built using the VM instructions via the functions in the metacompiler.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5-16" class="outline-3">
<h3 id="sec-5-16"><span class="section-number-3">5.16</span> <code>[4/6]</code> Strings</h3>
<div class="outline-text-3" id="text-5-16">
</div><div id="outline-container-sec-5-16-1" class="outline-4">
<h4 id="sec-5-16-1"><span class="section-number-4">5.16.1</span> <span class="done DONE">DONE</span> def <code>compare</code></h4>
<div class="outline-text-4" id="text-5-16-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">compare</span> <span style="color: #00ffff;">compare</span>
   <span style="color: #ffd700; font-weight: bold;">repeat</span>
     <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">@,</span> <span style="color: #00ff00;">push,</span> 1+, <span style="color: #00ff00;">swap,</span>
     <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">@,</span> <span style="color: #00ff00;">push,</span> 1+, <span style="color: #00ff00;">pop,</span> <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">pop,</span>
     <span style="color: #ffd700; font-weight: bold;">!if</span> <span style="color: #00ff00;">drop,</span> <span style="color: #00ff00;">drop,</span> <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">xor,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span>
   <span style="color: #32cd32;">0</span> # <span style="color: #32cd32;">12</span> m, m,
   <span style="color: #00ff00;">drop,</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">-1</span> # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $$-f ) Compare two strings for equality"</span> :doc

<span style="color: #66f;">( [ a-a ] internal helper for getting string length )</span>
</pre>
</div>

<p>
Compare two strings. Yes, this is hairy. But it is much faster than a higher
level implementation, and as one of the most heavily used functions in Retro,
this pays off.
</p>
</div>
</div>
<div id="outline-container-sec-5-16-2" class="outline-4">
<h4 id="sec-5-16-2"><span class="section-number-4">5.16.2</span> <span class="done DONE">DONE</span> def <code>getLength</code> / <code>withLength</code></h4>
<div class="outline-text-4" id="text-5-16-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> count <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">@+</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">getLength</span> <span style="color: #00ffff;">getLength</span>   <span style="color: #66f;">( a-n )</span> <span style="color: #00ff00;">dup,</span> count <span style="color: #00ff00;">1-,</span> <span style="color: #00ff00;">swap,</span> <span style="color: #00ff00;">-,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-n ) Return the length of a string"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">withLength</span>  <span style="color: #66f;">( a-an )</span> <span style="color: #00ff00;">dup,</span> <span style="color: #00ffff;">getLength</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-an ) Same as **dup getLength**"</span> :doc
</pre>
</div>

<p>
Obtain the length of a string. <code>count</code> is not exposed, but the others are.
Note here that <code>withLength</code> is the same as <code>dup getLength</code>; it was factored
out to help reduce stack noise elesewhere.
</p>
</div>
</div>
<div id="outline-container-sec-5-16-3" class="outline-4">
<h4 id="sec-5-16-3"><span class="section-number-4">5.16.3</span> <span class="done DONE">DONE</span> def <code>string</code>, <code>keepString</code></h4>
<div class="outline-text-4" id="text-5-16-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> string string      <span style="color: #66f;">( -   )</span> <span style="color: #00ff00;">pop,</span> count <span style="color: #00ff00;">1-,</span> <span style="color: #00ff00;">push,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) helper for strings"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ffff;">keepString</span> <span style="color: #00ffff;">keepString</span>  <span style="color: #66f;">( a-a )</span> <span style="color: #c63; font-weight: bold;">'</span> string # <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">here</span> <span style="color: #00ff00;">swap,</span> $ <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a-a ) Move the string to a permanent location"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-16-4" class="outline-4">
<h4 id="sec-5-16-4"><span class="section-number-4">5.16.4</span> <span class="todo TODO">TODO</span> <code>{ keepString commentary - seems to be outdated }</code></h4>
<div class="outline-text-4" id="text-5-16-4">
<p>
t: keepString  ( a-a ) withLength #3 +, here +, #8 , , here swap, $ ;
</p>

<p>
Another tricky one. Get the length of a string, compile a jump to the address
that would follow the string, and inline it after the jump.
</p>

<p>
4 elements #value num negate? flag
10 variable: base
label: numbers "0123456789ABCDEF" $,
</p>

<p>
These are used in parsing (and later, in display) of numbers. The "base" holds
the current numeric base, and "numbers" is a string of characters that are
valid for parsing as numbers.
</p>
</div>
</div>
<div id="outline-container-sec-5-16-5" class="outline-4">
<h4 id="sec-5-16-5"><span class="section-number-4">5.16.5</span> <span class="done DONE">DONE</span> def <code>atib</code>, <code>\quot</code></h4>
<div class="outline-text-4" id="text-5-16-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> atib atib memory # <span style="color: #00ff00;">@,</span> STRING-LENGTH <span style="color: #32cd32;">2</span> # <span style="color: #00ffff;">*</span> <span style="color: #00ffff;">-</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"(  -a ) Returns address of alternate text input buffer"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #00ff00;">" t-"</span> <span style="color: #c63; font-weight: bold;">'</span> atib # <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #00ffff;">tib</span> # <span style="color: #c63; font-weight: bold;">:is</span> '" # <span style="color: #00ffff;">accept</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #00ffff;">tib</span> # <span style="color: #c63; font-weight: bold;">:devector</span> atib <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``-$ ) temporary function to create strings until __`` is defined"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-16-6" class="outline-4">
<h4 id="sec-5-16-6"><span class="section-number-4">5.16.6</span> <span class="todo TODO">TODO</span> :devector and :is  <code>{ move these! }</code></h4>
<div class="outline-text-4" id="text-5-16-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #c63; font-weight: bold;">:devector</span> <span style="color: #c63; font-weight: bold;">:devector</span> <span style="color: #66f;">( a-  )</span> <span style="color: #32cd32;">0</span> # <span style="color: #00ff00;">swap,</span> <span style="color: #00ffff;">!+</span> <span style="color: #32cd32;">0</span> # <span style="color: #00ffff;">swap</span> <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a- ) Restore a function to its original state"</span> :doc

<span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #c63; font-weight: bold;">:is</span> <span style="color: #c63; font-weight: bold;">:is</span>      <span style="color: #66f;">( aa- )</span> <span style="color: #32cd32;">8</span> # <span style="color: #00ff00;">swap,</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( aa- ) Alter a function to point to a new function"</span> :doc
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5-17" class="outline-3">
<h3 id="sec-5-17"><span class="section-number-3">5.17</span> <span class="todo TODO">TODO</span> Number Parsing &amp; <del>Display</del>  <code>{what happened to the display?}</code></h3>
<div class="outline-text-3" id="text-5-17">
</div><div id="outline-container-sec-5-17-1" class="outline-4">
<h4 id="sec-5-17-1"><span class="section-number-4">5.17.1</span> | number related variables</h4>
<div class="outline-text-4" id="text-5-17-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #32cd32;">4</span> <span style="color: #c63; font-weight: bold;">elements</span> #value num negate? flag

<span style="color: #32cd32;">10</span> <span style="color: #c63; font-weight: bold;">variable:</span> base

<span style="color: #c63; font-weight: bold;">label:</span> numbers <span style="color: #00ff00;">"0123456789ABCDEF"</span> $,
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-17-2" class="outline-4">
<h4 id="sec-5-17-2"><span class="section-number-4">5.17.2</span> DEF <code>nums</code></h4>
<div class="outline-text-4" id="text-5-17-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> numbers nums     <span style="color: #66f;">( -a )</span> numbers # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"(  -a ) Function returning address of string containing all valid numeric characters"</span> :doc
</pre>
</div>
<p>
Return the "numbers" string. This an be revectored to allow for adding more
bases later.
</p>
</div>
</div>

<div id="outline-container-sec-5-17-3" class="outline-4">
<h4 id="sec-5-17-3"><span class="section-number-4">5.17.3</span> | number parsing and display</h4>
<div class="outline-text-4" id="text-5-17-3">
</div><ol class="org-ol"><li>{ @base digits valid? digit? toDigit isNegative convert }&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span><br/><div class="outline-text-5" id="text-5-17-3-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> @base    <span style="color: #66f;">( -n )</span> base # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( [ -n ] helper function, returns value stored in **base** )</span>

<span style="color: #c63; font-weight: bold;">i:</span> (digits) nums <span style="color: #00ff00;">+,</span> <span style="color: #00ff00;">@,</span> <span style="color: #00ffff;">over</span> <span style="color: #ffd700; font-weight: bold;">=if</span> num # <span style="color: #00ffff;">on</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>

<span style="color: #c63; font-weight: bold;">i:</span> digits   <span style="color: #00ff00;">1-,</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">push,</span> (digits) <span style="color: #00ff00;">pop,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">1-,</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>

<span style="color: #c63; font-weight: bold;">i:</span> valid?   @base <span style="color: #00ff00;">dup,</span> <span style="color: #32cd32;">16</span> # <span style="color: #ffd700; font-weight: bold;">&lt;if</span> digits <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>

<span style="color: #c63; font-weight: bold;">i:</span> digit?   num # <span style="color: #00ffff;">off</span> valid? <span style="color: #00ff00;">drop,</span> num # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>

<span style="color: #c63; font-weight: bold;">i:</span> toDigit  <span style="color: #66f;">( c-n )</span> '0 # <span style="color: #00ff00;">-,</span> @base <span style="color: #32cd32;">16</span> # <span style="color: #ffd700; font-weight: bold;">=if</span> <span style="color: #00ff00;">dup,</span> <span style="color: #32cd32;">16</span> # <span style="color: #ffd700; font-weight: bold;">&gt;if</span> <span style="color: #32cd32;">7</span> # <span style="color: #00ff00;">-,</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
Various helpers.
</p>
</div>
</li>
<li>{ isNegative? }&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span><br/><div class="outline-text-5" id="text-5-17-3-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> isNegative? <span style="color: #66f;">( a-a )</span>
   <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">@,</span> '- # <span style="color: #ffd700; font-weight: bold;">=if</span> negate? # <span style="color: #00ffff;">on</span> 1+, <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #32cd32;">1</span> # negate? # <span style="color: #00ff00;">!,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
If a number is negative, set the "negate?" variable to -1, otherwise set it
to 1. After conversion, we multiply by this to change the sign as needed.
</p>
</div>
</li></ol>
</div>
<div id="outline-container-sec-5-17-4" class="outline-4">
<h4 id="sec-5-17-4"><span class="section-number-4">5.17.4</span> DEF toNumber</h4>
<div class="outline-text-4" id="text-5-17-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> (convert)
   <span style="color: #ffd700; font-weight: bold;">repeat</span>
     <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> toDigit #value # <span style="color: #00ff00;">@,</span> @base <span style="color: #00ff00;">*,</span> <span style="color: #00ff00;">+,</span> #value # <span style="color: #00ff00;">!,</span> 1+,
   <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>

<span style="color: #c63; font-weight: bold;">w:</span> toNumber toNumber <span style="color: #66f;">( $-n )</span>
   isNegative? <span style="color: #32cd32;">0</span> # #value # <span style="color: #00ff00;">!,</span> (convert) <span style="color: #00ff00;">drop,</span> #value # <span style="color: #00ff00;">@,</span> negate? # <span style="color: #00ff00;">@,</span> <span style="color: #00ff00;">*,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $-n ) Convert a string to a number"</span> :doc
</pre>
</div>
</div>
<ol class="org-ol"><li>t: toNumber ( $-n )<br/><div class="outline-text-5" id="text-5-17-4-1">
<p>
isNegative? #0 #value # !, (convert) drop, #value # @, negate? # @, *, ;
</p>

<p>
Convert a string to a number.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-17-5" class="outline-4">
<h4 id="sec-5-17-5"><span class="section-number-4">5.17.5</span> DEF isNumber?</h4>
<div class="outline-text-4" id="text-5-17-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> (isnumber)
   <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">@,</span> <span style="color: #ffd700; font-weight: bold;">0;</span> digit? flag # <span style="color: #00ff00;">@,</span> <span style="color: #00ff00;">and,</span> flag # <span style="color: #00ff00;">!,</span> 1+, <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>

<span style="color: #c63; font-weight: bold;">w:</span> isNumber? isNumber? <span style="color: #66f;">( $-f )</span> isNegative? flag # <span style="color: #00ffff;">on</span> (isnumber) <span style="color: #00ff00;">drop,</span> flag # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $-f ) See if a string is a valid number in the current **base**"</span> :doc
</pre>
</div>

<p>
Check to see if a string is a valid number.
</p>

<p>
6 elements memory fb fw fh cw ch
</p>

<p>
Variables that hold information about the memory size and displays(s) being
provided.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-18" class="outline-3">
<h3 id="sec-5-18"><span class="section-number-3">5.18</span> <span class="todo TODO">TODO</span> Startup : <code>boot</code> .. <code>run-on-boot</code></h3>
<div class="outline-text-3" id="text-5-18">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> boot boot         <span style="color: #66f;">(  -  )</span>
   copytag # puts <span style="color: #32cd32;">32</span> # putc version # puts cr <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Called when the image first loads; use for custom startup routines"</span> :doc

<span style="color: #c63; font-weight: bold;">i:</span> query        <span style="color: #66f;">( n-n )</span> <span style="color: #32cd32;">5</span> # <span style="color: #00ff00;">out,</span> wait <span style="color: #32cd32;">5</span> # <span style="color: #00ff00;">in,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>

<span style="color: #c63; font-weight: bold;">i:</span> run-on-boot  <span style="color: #66f;">(  -  )</span>
   <span style="color: #32cd32;">-1</span>  # query memory # <span style="color: #00ff00;">!,</span>  <span style="color: #66f;">( Memory Size     )</span>
   <span style="color: #32cd32;">-2</span>  # query fb #     <span style="color: #00ff00;">!,</span>  <span style="color: #66f;">( Canvas Present? )</span>
   <span style="color: #32cd32;">-3</span>  # query fw #     <span style="color: #00ff00;">!,</span>  <span style="color: #66f;">( Canvas Width    )</span>
   <span style="color: #32cd32;">-4</span>  # query fh #     <span style="color: #00ff00;">!,</span>  <span style="color: #66f;">( Canvas Height   )</span>
   <span style="color: #32cd32;">-11</span> # query cw #     <span style="color: #00ff00;">!,</span>  <span style="color: #66f;">( Console Width   )</span>
   <span style="color: #32cd32;">-12</span> # query ch #     <span style="color: #00ff00;">!,</span>  <span style="color: #66f;">( Console Height  )</span>
   boot <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>
</div>

<div id="outline-container-sec-5-18-1" class="outline-4">
<h4 id="sec-5-18-1"><span class="section-number-4">5.18.1</span> | startup</h4>
<div class="outline-text-4" id="text-5-18-1">
</div><ol class="org-ol"><li>t: boot         (  -  )<br/><div class="outline-text-5" id="text-5-18-1-1">
<p>
copytag # puts #32 putc version # puts
</p>
<p>
#32 putc #40 putc build # puts #41 putc cr ;
</p>

<p>
This is called on startup. By default it displays a little info about
Retro, but can be revectored to do other tasks.
</p>
</div>
</li>
<li>t: query        ( n-n ) #5 out, wait, #5 in, ;<br/></li>
<li>t: run-on-boot  (  -  )<br/><div class="outline-text-5" id="text-5-18-1-3">
<p>
#-1 query memory # !,  ( Memory Size     )
</p>
<p>
#-2 query fb #     !,  ( Canvas Present? )
</p>
<p>
#-3 query fw #     !,  ( Canvas Width    )
</p>
<p>
#-4 query fh #     !,  ( Canvas Height   )
</p>
<p>
#-11 query cw #    !,  ( Console Width   )
</p>
<p>
#-12 query ch #    !,  ( Console Height  )
boot ;
</p>

<p>
Each time the VM starts, this requeries the VM to update the variables. It
is not exposed to the dictionary.
</p>

<p>
Now we move on to searching the dictionary. This is pretty simple:
</p>

<ol class="org-ol">
<li>take the most recent entry, see if the name field matches the string
provided
</li>
<li>if so, set "which" to the dictionary header start, and return the header
and a true flag
</li>
<li>If not found, get the next header and repeat
</li>
<li>If not found at all, return a bogus pointer and a false flag

<p>
2 elements name found
</p>
</li>
</ol>

<p>
Variables used by the searching, other than "which".
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-5-19" class="outline-3">
<h3 id="sec-5-19"><span class="section-number-3">5.19</span> <span class="done DONE">DONE</span> Dictionary Search</h3>
<div class="outline-text-3" id="text-5-19">
</div><div id="outline-container-sec-5-19-1" class="outline-4">
<h4 id="sec-5-19-1"><span class="section-number-4">5.19.1</span> { helpers for <code>find</code> }</h4>
<div class="outline-text-4" id="text-5-19-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #32cd32;">2</span> <span style="color: #c63; font-weight: bold;">elements</span> name found

<span style="color: #c63; font-weight: bold;">i:</span> prepare  <span style="color: #66f;">( a-a  )</span> found # <span style="color: #00ffff;">off</span> name # <span style="color: #00ff00;">!,</span> last # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
This resets the variables.
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> done     <span style="color: #66f;">(  -af )</span> which # <span style="color: #00ff00;">@,</span> found # <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
This returns a pointer to a header and the flag.
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> match?   <span style="color: #66f;">( $-$f )</span> <span style="color: #00ff00;">dup,</span> d-&gt;name name # <span style="color: #00ff00;">@,</span> <span style="color: #00ffff;">compare</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
Compare the requested string with the name field of a header.
</p>


<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> &lt;search&gt; <span style="color: #66f;">( $-   )</span>
   <span style="color: #ffd700; font-weight: bold;">repeat</span> match? <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> which # <span style="color: #00ff00;">!,</span> found # <span style="color: #00ffff;">on</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ffff;">@</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>
<p>
Loop through, looking for a match.
</p>
</div>
</div>
<div id="outline-container-sec-5-19-2" class="outline-4">
<h4 id="sec-5-19-2"><span class="section-number-4">5.19.2</span> DEF <code>find</code></h4>
<div class="outline-text-4" id="text-5-19-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #c63; font-weight: bold;">find</span>     <span style="color: #66f;">( $-af )</span> prepare &lt;search&gt; done <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $-af ) Search for a name in the dictionary. Returns  a dictionary header and a flag"</span> :doc
</pre>
</div>

<p>
Wrap it all up. This is exposed to the dictionary.
</p>
</div>
</div>
<div id="outline-container-sec-5-19-3" class="outline-4">
<h4 id="sec-5-19-3"><span class="section-number-4">5.19.3</span> DEF ='=</h4>
<div class="outline-text-4" id="text-5-19-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #ff6347;">t-'</span>      <span style="color: #66f;">( "-a  )</span> <span style="color: #32cd32;">32</span> # <span style="color: #00ffff;">accept</span> <span style="color: #00ffff;">tib</span> <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> d-&gt;xt <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``-a ) Interpret time: return the address ('xt') of a name"</span> :doc
</pre>
</div>

<p>
Read a name from the input, and return either a zero, or the contents of
the xt field that corresponds to the name. This is exposed as ' in the
dictionary.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5-20" class="outline-3">
<h3 id="sec-5-20"><span class="section-number-3">5.20</span> <code>[1/4]</code> Word Prefixes and "Not Found"</h3>
<div class="outline-text-3" id="text-5-20">
</div><div id="outline-container-sec-5-20-1" class="outline-4">
<h4 id="sec-5-20-1"><span class="section-number-4">5.20.1</span> Now to the word prefixes&#x2026;</h4>
<div class="outline-text-4" id="text-5-20-1">
<p>
label: <span class="underline">_</span>   "<span class="underline">_</span>" $,
</p>

<p>
This sets up a small string providing a template for the prefix names. In
Retro, all prefixes are named with two leading underscores. This template
will be modified by the remaining prefix code.
</p>
</div>
</div>

<div id="outline-container-sec-5-20-2" class="outline-4">
<h4 id="sec-5-20-2"><span class="section-number-4">5.20.2</span> <span class="todo TODO">TODO</span> DEF get&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-20-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">label:</span> ___   <span style="color: #00ff00;">"___"</span> $,
<span style="color: #c63; font-weight: bold;">i:</span> get      <span style="color: #66f;">( $-$  )</span> <span style="color: #00ff00;">dup,</span> <span style="color: #00ff00;">@,</span> ___ # <span style="color: #32cd32;">2</span> # <span style="color: #00ff00;">+,</span> <span style="color: #00ff00;">!,</span> 1+, <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
Given a string, take the first character, modify the prefix template, and
return the string sans the first character.
</p>
</div>
</div>
<div id="outline-container-sec-5-20-3" class="outline-4">
<h4 id="sec-5-20-3"><span class="section-number-4">5.20.3</span> <span class="todo TODO">TODO</span> DEF xt:class&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-20-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> xt:class <span style="color: #66f;">( d-aa )</span> <span style="color: #00ff00;">dup,</span> d-&gt;xt <span style="color: #00ff00;">@,</span> <span style="color: #00ff00;">swap,</span> d-&gt;class <span style="color: #00ff00;">@,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>
<p>
Given a dictionary header, return an xt and class.
</p>
</div>
</div>

<div id="outline-container-sec-5-20-4" class="outline-4">
<h4 id="sec-5-20-4"><span class="section-number-4">5.20.4</span> <span class="todo TODO">TODO</span> DEF try&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-20-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> try      <span style="color: #66f;">(  -   )</span>
   <span style="color: #00ffff;">tib</span> get <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #32cd32;">0</span> #
   <span style="color: #ffd700; font-weight: bold;">!if</span> d-&gt;xt <span style="color: #00ff00;">@,</span> ___ # <span style="color: #c63; font-weight: bold;">find</span>
      <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> xt:class withClass <span style="color: #32cd32;">0</span> # <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span>
   <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ff00;">drop,</span> <span style="color: #32cd32;">-1</span> # <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
See if the token starts with a prefix. If so, invoke the prefix and return 0.
If not, return -1.
</p>
</div>
</div>
<div id="outline-container-sec-5-20-5" class="outline-4">
<h4 id="sec-5-20-5"><a id="notFound" name="notFound"></a><span class="section-number-4">5.20.5</span> <span class="done DONE">DONE</span> DEF <code>notFound</code></h4>
<div class="outline-text-4" id="text-5-20-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> &lt;notFound&gt; &lt;notFound&gt; <span style="color: #66f;">( -f )</span> <span style="color: #00ffff;">tib</span> <span style="color: #00ffff;">getLength</span> <span style="color: #32cd32;">2</span> # <span style="color: #ffd700; font-weight: bold;">&gt;if</span> try <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">;</span>
"( -f ) Called by **notFound**; hook <span style="color: #ffd700; font-weight: bold;">for</span> custom error handling. Used by the prefix system. Returns  a flag of <span style="color: #32cd32;">0</span> <span style="color: #ffd700; font-weight: bold;">if</span> the error <span style="color: #c63; font-weight: bold;">is</span> cleared, <span style="color: #00ffff;">or</span> <span style="color: #32cd32;">-1</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ffff;">not</span> " :doc

<span style="color: #c63; font-weight: bold;">w:</span> notFound notFound   <span style="color: #66f;">( -  )</span> &lt;notFound&gt; <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span> cr <span style="color: #00ffff;">tib</span> puts <span style="color: #32cd32;">32</span> # putc '? # putc cr <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Called when a name is not found. Calls **&lt;notFound&gt;** and displays an error message  if necessary"</span> :doc
</pre>
</div>

<p>
These are called when a token is not found in the dictionary. They display
an error message. Also, they invoke the prefix handlers first. <i>Later</i> the
<code>&lt;notFound&gt;</code> portion is extended to allow for an additional type of prefix:
parsing prefixes.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5-21" class="outline-3">
<h3 id="sec-5-21"><span class="section-number-3">5.21</span> <code>[5/5]</code> Listener</h3>
<div class="outline-text-3" id="text-5-21">
<p>
Now on to the listener itself&#x2026;
</p>
</div>

<div id="outline-container-sec-5-21-1" class="outline-4">
<h4 id="sec-5-21-1"><span class="section-number-4">5.21.1</span> <span class="done DONE">DONE</span> DEF <code>ok</code></h4>
<div class="outline-text-4" id="text-5-21-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> ok ok      <span style="color: #66f;">(   - )</span> compiler # <span style="color: #00ff00;">@,</span> <span style="color: #00ffff;">not</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ff00;">drop,</span> cr okmsg # puts <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Displays the ``ok`` prompt"</span> :doc
</pre>
</div>

<p>
If the compiler is off, this displays the prompt in <code>okmsg</code>. This procedure can be revectored later if you want different behavior.
</p>
</div>
</div>
<div id="outline-container-sec-5-21-2" class="outline-4">
<h4 id="sec-5-21-2"><a id="build" name="build"></a><span class="section-number-4">5.21.2</span> <span class="done DONE">DONE</span> DEF <code>build#</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-21-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> build#  <span style="color: #66f;">(   - )</span> <span style="color: #00ffff;">tib</span> toNumber <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.data</span> # <span style="color: #c63; font-weight: bold;">jump:</span> withClass
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
Convert the string in TIB to a number, then invoke <a href="#sec-5-4-4">the <code>.data</code> class</a> via
<code>withClass</code>.
</p>
</div>
</div>
<div id="outline-container-sec-5-21-3" class="outline-4">
<h4 id="sec-5-21-3"><span class="section-number-4">5.21.3</span> <span class="done DONE">DONE</span> DEF <code>number</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-21-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> number  <span style="color: #66f;">(   - )</span> <span style="color: #00ffff;">tib</span> isNumber? <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> <span style="color: #c63; font-weight: bold;">jump:</span> build# <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #c63; font-weight: bold;">jump:</span> notFound
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
Check the string in TIB. If it's a number, then <code>build#</code>, otherwise run
<a href="#sec-5-20-5">5.20.5</a>.
</p>
</div>
</div>
<div id="outline-container-sec-5-21-4" class="outline-4">
<h4 id="sec-5-21-4"><span class="section-number-4">5.21.4</span> <span class="done DONE">DONE</span> DEF <code>process</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="internal">internal</span></span></h4>
<div class="outline-text-4" id="text-5-21-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">i:</span> process <span style="color: #66f;">( af- )</span> <span style="color: #32cd32;">0</span> # <span style="color: #ffd700; font-weight: bold;">!if</span> xt:class <span style="color: #c63; font-weight: bold;">jump:</span> withClass <span style="color: #ffd700; font-weight: bold;">then</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">jump:</span> number
<span style="color: #66f;">( NEEDS-DESCRIPTION )</span>
</pre>
</div>

<p>
If a string in TIB corresponds to a known word, fetch its class, and execute it via <code>withClass</code>. Otherwise, execute <code>number</code>.
</p>
</div>
</div>
<div id="outline-container-sec-5-21-5" class="outline-4">
<h4 id="sec-5-21-5"><span class="section-number-4">5.21.5</span> <span class="done DONE">DONE</span> DEF <code>listen</code></h4>
<div class="outline-text-4" id="text-5-21-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">w:</span> listen listen  <span style="color: #66f;">(   - )</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> ok <span style="color: #32cd32;">32</span> # <span style="color: #00ffff;">accept</span> <span style="color: #00ffff;">tib</span> <span style="color: #c63; font-weight: bold;">find</span> process <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
   <span style="color: #00ff00;">"( - ) Top level interpreter. Reads and process input."</span> :doc
</pre>
</div>

<p>
The listener itself. Display the prompt, read a whitespace delimited token,
search the dictionary for it, and call "process" to handle it. Then repeat,
forever. (Or until "bye" is called)
</p>
</div>
</div>
</div>
<div id="outline-container-sec-5-22" class="outline-3">
<h3 id="sec-5-22"><span class="section-number-3">5.22</span> <code>[0/4]</code> Extra documentation for the initial dictionary.</h3>
<div class="outline-text-3" id="text-5-22">
</div><div id="outline-container-sec-5-22-1" class="outline-4">
<h4 id="sec-5-22-1"><span class="section-number-4">5.22.1</span> <span class="todo TODO">TODO</span> &lt;try and regroup these things, just for the documentation here&gt;&#xa0;&#xa0;&#xa0;<span class="tag"><span class="mjw">mjw</span></span></h4>
<div class="outline-text-4" id="text-5-22-1">
<p>
I <i>think</i> these are variables declared early on in the process, before the dictionary structure is set up and working. Not 100% sure. Perhaps they can be moved inline?
</p>
</div>
</div>

<div id="outline-container-sec-5-22-2" class="outline-4">
<h4 id="sec-5-22-2"><a id="kpe3xmt0zzf0" name="kpe3xmt0zzf0"></a><span class="section-number-4">5.22.2</span> <span class="todo TODO">TODO</span> &lt;ungrouped&gt;</h4>
<div class="outline-text-4" id="text-5-22-2">

<div class="org-src-container">

<pre class="src src-retro">last         <span style="color: #c63; font-weight: bold;">data:</span> last
<span style="color: #00ff00;">"( -a ) Variable; pointer to most recent dictionary  header"</span> :doc

compiler     <span style="color: #c63; font-weight: bold;">data:</span> compiler
<span style="color: #00ff00;">"( -a ) Variable; holds compiler state"</span> :doc

fb           <span style="color: #c63; font-weight: bold;">data:</span> fb
<span style="color: #00ff00;">"( -a ) Variable; Is canvas present?"</span> :doc

fw           <span style="color: #c63; font-weight: bold;">data:</span> fw
<span style="color: #00ff00;">"( -a ) Variable; Framebuffer width"</span> :doc

fh           <span style="color: #c63; font-weight: bold;">data:</span> fh
<span style="color: #00ff00;">"( -a ) Variable; Framebuffer height"</span> :doc

memory       <span style="color: #c63; font-weight: bold;">data:</span> memory
<span style="color: #00ff00;">"( -a ) Variable; Holds amount of memory provided by the VM"</span> :doc

cw           <span style="color: #c63; font-weight: bold;">data:</span> cw
<span style="color: #00ff00;">"( -a ) Variable; Console width"</span> :doc

ch           <span style="color: #c63; font-weight: bold;">data:</span> ch
<span style="color: #00ff00;">"( -a ) Variable; Console height"</span> :doc

<span style="color: #00ffff;">heap</span>         <span style="color: #c63; font-weight: bold;">data:</span> <span style="color: #00ffff;">heap</span>
<span style="color: #00ff00;">"( -a ) Variable; Pointer to current free location in heap"</span> :doc

which        <span style="color: #c63; font-weight: bold;">data:</span> which
<span style="color: #00ff00;">"( -a ) Variable; Holds pointer to most recently looked up header"</span> :doc

remapping    <span style="color: #c63; font-weight: bold;">data:</span> remapping
<span style="color: #00ff00;">"( -a ) Variable; indicates whether CR, LF, and TAB should be treated as whitespace"</span> :doc

eatLeading?  <span style="color: #c63; font-weight: bold;">data:</span> eatLeading?
<span style="color: #00ff00;">"( -a ) Variable; indicates whether **accept** should ignore leading delimiters"</span> :doc

base         <span style="color: #c63; font-weight: bold;">data:</span> base
<span style="color: #00ff00;">"( -a ) Variable; holds current base for numeric conversion and display"</span> :doc

update       <span style="color: #c63; font-weight: bold;">data:</span> update
<span style="color: #00ff00;">"( -a ) Variable; flag indicating whether or not **redraw** should update the display"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-22-3" class="outline-4">
<h4 id="sec-5-22-3"><span class="section-number-4">5.22.3</span> <span class="todo TODO">TODO</span> <code>version</code> , <code>build</code></h4>
<div class="outline-text-4" id="text-5-22-3">
<div class="org-src-container">

<pre class="src src-retro">version      <span style="color: #c63; font-weight: bold;">data:</span> version
<span style="color: #00ff00;">"( -$ ) String holding version information"</span> :doc

build        <span style="color: #c63; font-weight: bold;">data:</span> build
<span style="color: #00ff00;">"( -$ ) String holding a build identifier"</span> :doc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-22-4" class="outline-4">
<h4 id="sec-5-22-4"><span class="section-number-4">5.22.4</span> <span class="todo TODO">TODO</span> <code>vector</code> <code>tabAsWhitespace</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="settings">settings</span></span></h4>
<div class="outline-text-4" id="text-5-22-4">
<div class="org-src-container">

<pre class="src src-retro">vector       <span style="color: #c63; font-weight: bold;">data:</span> vector
<span style="color: #00ff00;">"( -a ) Variable; compile function as a vector"</span> :doc

tabAsWhitespace <span style="color: #c63; font-weight: bold;">data:</span> tabAsWhitespace
<span style="color: #00ff00;">"( -a ) Variable; treat tab as whitespace?"</span> :doc
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5-23" class="outline-3">
<h3 id="sec-5-23"><span class="section-number-3">5.23</span> <span class="done DONE">DONE</span> Finish Metacompiled Part</h3>
<div class="outline-text-3" id="text-5-23">
<p>
Well, that's done. Not too hard, thanks to the dictionary building stuff
from the metacompiler. When the new image is started by "bootNew", the list
above is <b>all</b> that you have access to. Complete enough to allow for a lot
to be done, but still small enough to be easily managed.
</p>

<div class="org-src-container">

<pre class="src src-retro">patch
</pre>
</div>

<p>
This seals off the initial dictionary. It updates the variable flagged by
<code>mark</code> (which becomes <code>last</code>) to point to the final entry created, leaving us
with a useable dictionary.
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">main:</span> run-on-boot <span style="color: #c63; font-weight: bold;">jump:</span> listen
</pre>
</div>

<p>
The last actual bit of code in stage 2: the main entry point. This calles
<code>run-on-boot</code> to update the memory and display variables, and then jumps
to the listener.
</p>


<div class="org-src-container">

<pre class="src src-retro">endKernel shrink bootNew
</pre>
</div>

<p>
Display some statistics on the new kernel for diagnostic purposes.
</p>

<p>
<code>bootNew</code> will copy the target memory over the old image, and then jump to it.
Once <code>bootNew</code> is called, there is no going back. The old image is replaced by
the new one, so be sure to keep a backup handy in case changes break things.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> <code>[7/35]</code> Stage 3: Extend The Language</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> <code>=================</code></h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #66f;">( Ok, at this point the new image should be in control so we have a normal,   )</span>
<span style="color: #66f;">( though brutally minimal Retro system from here on.                          )</span>
<span style="color: #66f;">( ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>

<span style="color: #c63; font-weight: bold;">:</span> :doc <span style="color: #00ffff;">keepString</span> last <span style="color: #00ffff;">@</span> d-&gt;doc <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( $- )</span> attach documentation string to latest defined function" :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> <span class="done DONE">DONE</span> stack words</h3>
<div class="outline-text-3" id="text-6-2">
<p>
As noted by the comment above, at this point we have only the basic set of
functions and variables available. We start by defining more stack and variable
operations.
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Stack Words ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">nip</span>   <span style="color: #66f;">(  xy-y    )</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xy-y )</span> Drop the NOS from the stack" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">rot</span>   <span style="color: #66f;">( xyz-yzx  )</span> <span style="color: #00ffff;">push</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">swap</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xyz-yzx )</span> Rotate the top three values <span style="color: #00ffff;">on</span> the stack" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">tuck</span>  <span style="color: #66f;">(  xy-yxy  )</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">over</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xy-yxy )</span> Put a <span style="color: #00ffff;">copy</span> of TOS under NOS" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">+!</span>    <span style="color: #66f;">(  na-     )</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">push</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( na- )</span> Add <span style="color: #c63; font-weight: bold;">value</span> to <span style="color: #c63; font-weight: bold;">value</span> at address" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">-!</span>    <span style="color: #66f;">(  na-     )</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">push</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">-</span> <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( na- )</span> Subtract <span style="color: #c63; font-weight: bold;">value</span> from <span style="color: #c63; font-weight: bold;">value</span> at address" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">++</span>    <span style="color: #66f;">(   a-     )</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">+!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a- )</span> Increment <span style="color: #c63; font-weight: bold;">variable</span> by 1" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">--</span>    <span style="color: #66f;">(   a-     )</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">-!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a- )</span> Decrement <span style="color: #c63; font-weight: bold;">variable</span> by 1" :doc

<span style="color: #c63; font-weight: bold;">:</span> ?dup  <span style="color: #66f;">(   n-n || n-nn )</span>  <span style="color: #00ffff;">dup</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( -n )</span> Duplicate TOS <span style="color: #ffd700; font-weight: bold;">if</span> non-zero. If zero, leave <span style="color: #c63; font-weight: bold;">value</span> alone" :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> <span class="done DONE">DONE</span> Then the scope functions:</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Scope ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #c63; font-weight: bold;">create</span> <span style="color: #66f;">list</span>  <span style="color: #66f;">( -a )</span>  <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">{{</span> <span style="color: #66f;">( - )</span>  vector <span style="color: #00ffff;">off</span> last <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">dup</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Start a namespace (private portion)" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">---reveal---</span> <span style="color: #66f;">( - )</span> vector <span style="color: #00ffff;">on</span> last <span style="color: #00ffff;">@</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Switch to public portion of a namespace" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">}}</span> <span style="color: #66f;">( - )</span>
  vector <span style="color: #00ffff;">on</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">@+</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">@</span> ==
  <span style="color: #00ffff;">[</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">@</span> last <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span>
  <span style="color: #00ffff;">[</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">[</span> last <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">@</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">@</span> != <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">drop</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Close a namespace, sealing <span style="color: #00ffff;">off</span> private symbols" :doc
</pre>
</div>

<p>
These are hairy, but basically involve relinking the dictionary chain. The
simplest case:
</p>

<pre class="example">
:  foo 1 2 + ;
 {{
   : bar foo foo * ;
 }}
</pre>

<p>
Would leave "foo" visible, and hide "bar". This is pretty easy to do, but the
scope control goes a bit further:
</p>

<pre class="example">
:  foo 1 2 + ;
 {{
   : bar foo foo * ;
 ---reveal---
   : big bar putn ;
 }}
</pre>

<p>
Would leave <code>foo</code> and <code>big</code> visible, but hide <code>bar</code>. This is done by locating
the header of <code>big</code>, and pointing its link field to the header of <code>foo</code>.
</p>
</div>
</div>
<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> <span class="done DONE">DONE</span> vectored execution</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Retro allows for functions created via the colon compiler to be revectored. This provides support for altering existing functionality at a later time and is done by replacing the two nop's at the start of each colon definition with a jump to the new function.
</p>

<p>
Devectoring is done by replacing the jump with two nop's.
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Vectored Execution ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">devector</span>  <span style="color: #66f;">( "-  )</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #c63; font-weight: bold;">:devector</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( ``- )</span> Same as **:devector**, but parses <span style="color: #ffd700; font-weight: bold;">for</span> name of function" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">is</span>        <span style="color: #66f;">( a"- )</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #c63; font-weight: bold;">:is</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a``- )</span> Same as **:is**, but parses <span style="color: #ffd700; font-weight: bold;">for</span> name of function" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">default:</span>  <span style="color: #66f;">( "-  )</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #32cd32;">2</span> <span style="color: #00ffff;">+</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">.macro</span> last <span style="color: #00ffff;">@</span> d-&gt;class <span style="color: #00ffff;">!</span>
" <span style="color: #66f;">( ``- )</span> Compile call to default definition of a function, ignoring any revectoring" :doc
</pre>
</div>

<p>
This compiles a call to a default definition, skipping the possible revectoring. It's useful for extending an existing function.
</p>
</div>
</div>
<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> <span class="todo TODO">TODO</span> { refile these }</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> HEADERS   <span style="color: #66f;">(  -n )</span> <span style="color: #32cd32;">32</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( -n )</span> Returns number of private headers permitted" :doc

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> scratch  <span style="color: #66f;">( -a )</span>
    memory <span style="color: #00ffff;">@</span>       STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( tib     )</span>
                   STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( scratch )</span>
    STRING-BUFFERS STRING-LENGTH <span style="color: #00ffff;">*</span> <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( buffers )</span>
    HEADERS <span style="color: #00ffff;">dup</span> STRING-LENGTH <span style="color: #00ffff;">*</span> <span style="color: #00ffff;">swap</span> <span style="color: #32cd32;">3</span> <span style="color: #00ffff;">*</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( headers )</span> <span style="color: #c63; font-weight: bold;">;</span>

  <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #ffd700; font-weight: bold;">next</span>  <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>
  <span style="color: #c63; font-weight: bold;">create</span> split <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>

  <span style="color: #00ffff;">[</span> split <span style="color: #00ffff;">@</span>
    <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">heap</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">[</span> <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">heap</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">default:</span> header <span style="color: #00ffff;">heap</span> <span style="color: #00ffff;">@</span> <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">heap</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">here</span> last <span style="color: #00ffff;">@</span> d-&gt;xt <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span>
    <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">default:</span> header <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">is</span> header

  <span style="color: #c63; font-weight: bold;">create</span> z
     <span style="color: #32cd32;">999</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">999</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>

  <span style="color: #00ffff;">[</span> split  <span style="color: #00ffff;">on</span> scratch <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">default:</span> <span style="color: #c63; font-weight: bold;">{{</span>           z header <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">is</span> <span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #00ffff;">[</span> split <span style="color: #00ffff;">off</span>                <span style="color: #c63; font-weight: bold;">default:</span> <span style="color: #c63; font-weight: bold;">---reveal---</span>          <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">is</span> <span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #00ffff;">[</span> split <span style="color: #00ffff;">off</span>                <span style="color: #c63; font-weight: bold;">default:</span> <span style="color: #c63; font-weight: bold;">}}</span>                    <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">is</span> <span style="color: #c63; font-weight: bold;">}}</span>
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-6" class="outline-3">
<h3 id="sec-6-6"><span class="section-number-3">6.6</span> <span class="done DONE">DONE</span> dictionary words</h3>
<div class="outline-text-3" id="text-6-6">
<div class="org-src-container">

<pre class="src src-retro"> <span style="color: #66f;">( Dictionary ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">create</span> a <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">create</span> b <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">create</span> c <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">create</span> xt <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>
  <span style="color: #c63; font-weight: bold;">:</span> skim       <span style="color: #66f;">( a-a )</span>
    last <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">over</span> d-&gt;xt <span style="color: #00ffff;">@</span> == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">nip</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> getHeaders <span style="color: #66f;">( $-  )</span>
    xt <span style="color: #00ffff;">!</span> <span style="color: #32cd32;">0</span> a <span style="color: #00ffff;">!</span> <span style="color: #32cd32;">0</span> b <span style="color: #00ffff;">!</span> <span style="color: #32cd32;">0</span> c <span style="color: #00ffff;">!</span>
    last <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">@</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">dup</span> d-&gt;xt <span style="color: #00ffff;">@</span> xt <span style="color: #00ffff;">@</span> == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">dup</span> b <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">@</span> a <span style="color: #00ffff;">!</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ffff;">dup</span> c <span style="color: #00ffff;">!</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> &lt;hide&gt;     <span style="color: #66f;">( a-  )</span> getHeaders b <span style="color: #00ffff;">@</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">drop</span> a <span style="color: #00ffff;">@</span> c <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
</pre>
</div>

<p>
This set of functions is used to access and manipulate the dictionary.
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ff6347;">d'</span>         <span style="color: #66f;">( "-a )</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #00ffff;">drop</span> which <span style="color: #00ffff;">@</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( ``-a )</span> Parse <span style="color: #ffd700; font-weight: bold;">for</span> a name <span style="color: #00ffff;">and</span> return the dictionary header corresponding to it" :doc
</pre>
</div>


<p>
This acts like ' but returns a dictionary header rather than the contents of the xt field. If you look here, you'll see that it uses ' to do the search, discards the xt, and pulls the actual header address out of "which".
#+end<sub>src</sub>
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> xt-&gt;d      <span style="color: #66f;">( a-d || a-0 )</span> <span style="color: #00ffff;">dup</span> skim <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">over</span> == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">-</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">nip</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a-d )</span> Given an address, return the corresponding dictionary header <span style="color: #00ffff;">or</span> <span style="color: #32cd32;">0</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ffff;">not</span> found" :doc
</pre>
</div>

<p>
If you have an xt, this will try to find a dictionary header that corresponds
to it. If it fails, it'll return a zero.
</p>

<div class="org-src-container">

<pre class="src src-retro">  <span style="color: #c63; font-weight: bold;">:</span> :hide      <span style="color: #66f;">( a-  )</span>
    <span style="color: #00ffff;">dup</span> xt-&gt;d last <span style="color: #00ffff;">@</span> == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> last <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">@</span> last <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> &lt;hide&gt; <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( a- )</span> Remove a name from a dictionary. Specify the address of a function. Used by **hide**" :doc

  <span style="color: #c63; font-weight: bold;">:</span> hide       <span style="color: #66f;">( "-  )</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #ffd700; font-weight: bold;">0;</span> :hide <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( ``- )</span> Remove a name from the dictionary" :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>

<p>
These relink the dictionary to hide a single header. You can either provide
an xt or parse for a name.
</p>

<div class="org-src-container">

<pre class="src src-retro">hide <span style="color: #66f;">list</span>
hide vector
</pre>
</div>

<p>
Hide a factor used in the creation of scopes.
</p>
</div>
</div>
<div id="outline-container-sec-6-7" class="outline-3">
<h3 id="sec-6-7"><span class="section-number-3">6.7</span> <span class="done DONE">DONE</span> reclass</h3>
<div class="outline-text-3" id="text-6-7">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> reclass      <span style="color: #66f;">(  a- )</span> last <span style="color: #00ffff;">@</span> d-&gt;class <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a- )</span> Change class of most recent function to specified class" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">reclass:</span>     <span style="color: #66f;">( a"- )</span> <span style="color: #ff6347;">d'</span> d-&gt;class <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a``- )</span> Same as **reclass**, but parse <span style="color: #ffd700; font-weight: bold;">for</span> function to change class of" :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-8" class="outline-3">
<h3 id="sec-6-8"><span class="section-number-3">6.8</span> <span class="done DONE">DONE</span> initial prefixes</h3>
<div class="outline-text-3" id="text-6-8">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Initial Prefixes ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> xt:class <span style="color: #66f;">( a-aa )</span> <span style="color: #00ffff;">dup</span> xt-&gt;d <span style="color: #ffd700; font-weight: bold;">0;</span> d-&gt;class <span style="color: #00ffff;">@</span> withClass <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> __&amp;  <span style="color: #66f;">( a-a )</span> <span style="color: #c63; font-weight: bold;">.data</span>                  <span style="color: #c63; font-weight: bold;">;</span> &amp;.macro reclass
  " <span style="color: #66f;">( a-a )</span> Prefix; returns address of a <span style="color: #c63; font-weight: bold;">variable</span> <span style="color: #00ffff;">or</span> function" :doc

  <span style="color: #c63; font-weight: bold;">:</span> __@  <span style="color: #66f;">( a-n )</span> xt:class &amp;@  xt:class  <span style="color: #c63; font-weight: bold;">;</span> &amp;.macro reclass
  " <span style="color: #66f;">( a-n )</span> Prefix; execute function <span style="color: #00ffff;">or</span> data element <span style="color: #00ffff;">and</span> fetch from addres returned" :doc

  <span style="color: #c63; font-weight: bold;">:</span> __!  <span style="color: #66f;">( na- )</span> xt:class &amp;!  xt:class  <span style="color: #c63; font-weight: bold;">;</span> &amp;.macro reclass
  " <span style="color: #66f;">( na- )</span> Prefix; execute function <span style="color: #00ffff;">or</span> data element <span style="color: #00ffff;">and</span> store <span style="color: #c63; font-weight: bold;">value</span> to address returned" :doc

  <span style="color: #c63; font-weight: bold;">:</span> __+  <span style="color: #66f;">( na- )</span> xt:class &amp;+! <span style="color: #c63; font-weight: bold;">.word</span>     <span style="color: #c63; font-weight: bold;">;</span> &amp;.macro reclass
  " <span style="color: #66f;">( na- )</span> Prefix; execute function <span style="color: #00ffff;">or</span> data element <span style="color: #00ffff;">and</span> add <span style="color: #c63; font-weight: bold;">value</span> to <span style="color: #c63; font-weight: bold;">value</span> at address returned" :doc

  <span style="color: #c63; font-weight: bold;">:</span> __-  <span style="color: #66f;">( na- )</span> xt:class &amp;-! <span style="color: #c63; font-weight: bold;">.word</span>     <span style="color: #c63; font-weight: bold;">;</span> &amp;.macro reclass
  " <span style="color: #66f;">( na- )</span> Prefix; execute function <span style="color: #00ffff;">or</span> data element <span style="color: #00ffff;">and</span> subtract <span style="color: #c63; font-weight: bold;">value</span> from <span style="color: #c63; font-weight: bold;">value</span> at address returned" :doc

  <span style="color: #c63; font-weight: bold;">:</span> __2  <span style="color: #66f;">( a-  )</span> &amp;xt:class <span style="color: #00ffff;">sip</span> xt:class <span style="color: #c63; font-weight: bold;">;</span> &amp;.macro reclass
  " <span style="color: #66f;">( a- )</span> Prefix; execute function twice" :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>

<p>
The initial set of prefixes. Note that we redefine "xt:class" here. It's
slightly different than the non-exposed one in the kernel.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left"/>

<col class="left"/>
</colgroup>
<tbody>
<tr>
<td class="left">&amp;</td>
<td class="left">Return the address (xt) of a named item</td>
</tr>

<tr>
<td class="left">@</td>
<td class="left">Fetch a value from a variable</td>
</tr>

<tr>
<td class="left">!</td>
<td class="left">Store a value to a variable</td>
</tr>

<tr>
<td class="left">+</td>
<td class="left">Add a value to the value stored in a variable</td>
</tr>

<tr>
<td class="left">-</td>
<td class="left">Subtract a value from the value stored in a variable</td>
</tr>

<tr>
<td class="left">2</td>
<td class="left">Execute a function twice.</td>
</tr>
</tbody>
</table>

<p>
At this point we only have basic prefixes; support for parsing prefixes will
be created later.
</p>
</div>
</div>

<div id="outline-container-sec-6-9" class="outline-3">
<h3 id="sec-6-9"><span class="section-number-3">6.9</span> <span class="todo TODO">TODO</span> classes { .primitive was moved to the kernel  }</h3>
<div class="outline-text-3" id="text-6-9">
<p>
In the kernel, we have three classes: .word, .macro, and .data. Here we define
two additionals.
</p>

<p>
.primitive
</p>

<p>
This is used for the handful of functions that map to a single Ngaro
instruction. If the function is not revectored, and the compiler is active,
it will inline the instruction rather than laying down a call. Otherwise, it
acts the same as the ".word" class.
</p>

<p>
.compiler
</p>

<p>
This provides an alternative to ".macro" for things that are only intended
to be used inside a definition. At the interpreter, things with this class
are silently ignored.
</p>


<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Classes ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>

<span style="color: #c63; font-weight: bold;">:</span> .compiler    <span style="color: #66f;">(  a- )</span> @compiler &amp;do &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a- )</span> Class <span style="color: #ffd700; font-weight: bold;">for</span> functions that can only be used inside a definition" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">immediate</span>    <span style="color: #66f;">(   - )</span> &amp;.macro reclass <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Set the most recent function to **.macro** class" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">compile-only</span> <span style="color: #66f;">(  "- )</span> &amp;.compiler reclass <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( ``- )</span> Set the most recent function to **.compiler** class" :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-10" class="outline-3">
<h3 id="sec-6-10"><span class="section-number-3">6.10</span> <span class="todo TODO">TODO</span> remapping</h3>
<div class="outline-text-3" id="text-6-10">
</div><div id="outline-container-sec-6-10-1" class="outline-4">
<h4 id="sec-6-10-1"><span class="section-number-4">6.10.1</span> <span class="todo TODO">TODO</span> { .primitive again }</h4>
<div class="outline-text-4" id="text-6-10-1">
<p>
Now that we have some new classes, let's change the class of some existing
functions to ".primitive" to improve performance:
</p>
</div>
</div>

<div id="outline-container-sec-6-10-2" class="outline-4">
<h4 id="sec-6-10-2"><span class="section-number-4">6.10.2</span> :  p: ( "- ) &amp;.primitive reclass: ;</h4>
<div class="outline-text-4" id="text-6-10-2">
<p>
p: 1+     p: 1-     p: swap   p: drop  p: and    p: or     p: xor    p: @
p: !      p: +      p: -      p: *     p: /mod   p: <a id="p:" name="p:"></a>     p: dup
p  : in     p: out
hide p:
</p>
</div>
</div>

<div id="outline-container-sec-6-10-3" class="outline-4">
<h4 id="sec-6-10-3"><span class="section-number-4">6.10.3</span> And a couple of things to ".compiler" for safety.:</h4>
<div class="outline-text-4" id="text-6-10-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Remap some classes for efficiency and safety ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #00ffff;">here</span>
<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #66f;">( "- )</span> &amp;.compiler <span style="color: #c63; font-weight: bold;">reclass:</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #00ffff;">pop</span>    <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #00ffff;">push</span>   <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #ffd700; font-weight: bold;">0;</span>     <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #ffd700; font-weight: bold;">;;</span>    <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #c63; font-weight: bold;">;</span>      <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #c63; font-weight: bold;">c:</span> <span style="color: #ffd700; font-weight: bold;">again</span>
<span style="color: #c63; font-weight: bold;">}}</span>
!heap
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6-11" class="outline-3">
<h3 id="sec-6-11"><span class="section-number-3">6.11</span> <span class="done DONE">DONE</span> compiler macros</h3>
<div class="outline-text-3" id="text-6-11">
</div><div id="outline-container-sec-6-11-1" class="outline-4">
<h4 id="sec-6-11-1"><span class="section-number-4">6.11.1</span> <code>`</code> (backtick)</h4>
<div class="outline-text-4" id="text-6-11-1">
<p>
Ok, now on to backtick:
</p>

<div class="org-src-container">

<pre class="src src-retro"><span style="color: #66f;">( Compiler Macros ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">`</span>     <span style="color: #66f;">( "-  )</span>
  <span style="color: #c63; font-weight: bold;">'</span> ?dup <span style="color: #32cd32;">0</span> != <span style="color: #32cd32;">-1</span> ==
  <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">.data</span> @which @d-&gt;class <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">]</span>
  <span style="color: #00ffff;">[</span>  <span style="color: #00ffff;">tib</span> isNumber? <span style="color: #32cd32;">-1</span> ==
    <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">tib</span> toNumber <span style="color: #c63; font-weight: bold;">.data</span> &amp;.data <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">]</span> &amp;notFound <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
<span style="color: #00ff00;">"( ``- ) Either execute a function, or compile the xt  and a call to the corresponding class handler. This will also work with numbers"</span> :doc
</pre>
</div>

<p>
This is similar to "postpone", but with a subtle difference. We use it in cases where we wish to create state-aware macros. This is probably best seen with an example.
</p>

<pre class="example">
( A function to inline "1 2 +" into a definition )
:  foo  1 , 1 , 1 , 2 , 16 , ; compile-only
</pre>

<p>
Ouch. Too many magic numbers. We could clean this up with the classes:
</p>

<pre class="example">
( A function to inline "1 2 +" into a definition )
:  foo  1 .data 2 .data &amp;+ .primitive ; compile-only
</pre>

<p>
Longer, but more readable. With backtick we can do this instead:
</p>

<pre class="example">
( A function to inline "1 2 +" into a definition )
:  foo  ` 1 ` 2 ` + ; compile-only
</pre>

<p>
This is identical in functionality to the version using classes, but much more compact and readable.
</p>
</div>
</div>
<div id="outline-container-sec-6-11-2" class="outline-4">
<h4 id="sec-6-11-2"><span class="section-number-4">6.11.2</span> <code>jump:</code></h4>
<div class="outline-text-4" id="text-6-11-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">jump:</span> <span style="color: #66f;">( "- )</span> <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #32cd32;">8</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
<span style="color: #00ff00;">"( ``- ) Compile a jump to another function"</span> :doc
</pre>
</div>

<p>
Compile a jump to a named function.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-6-12" class="outline-3">
<h3 id="sec-6-12"><span class="section-number-3">6.12</span> <span class="todo TODO">TODO</span> ( Additional Combinators <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-12">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> []      <span style="color: #66f;">(    -    )</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">immediate</span>
" <span style="color: #66f;">( - )</span> Empty quote" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">while</span>   <span style="color: #66f;">(   q-    )</span> <span style="color: #00ffff;">[</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">swap</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">drop</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( q- )</span> Execute quote until quote returns a flag of" :doc

<span style="color: #c63; font-weight: bold;">:</span> until   <span style="color: #66f;">(   q-    )</span> <span style="color: #00ffff;">[</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">not</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">drop</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( q- )</span> Execute quote until quote returns a flag of -1" :doc

<span style="color: #c63; font-weight: bold;">:</span> curry   <span style="color: #66f;">(  nq-q   )</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">.data</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( nq-q )</span> <span style="color: #32cd32;">5</span> <span style="color: #00ffff;">[</span> . <span style="color: #00ffff;">]</span>   <span style="color: #00ffff;">=</span>  <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">5</span> <span style="color: #00ffff;">[</span> . <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">do</span> ]" :doc

<span style="color: #c63; font-weight: bold;">:</span> take    <span style="color: #66f;">(  qq-q   )</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">.data</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( qq-q )</span> <span style="color: #32cd32;">5</span> <span style="color: #00ffff;">[</span> . <span style="color: #00ffff;">]</span>   <span style="color: #00ffff;">=</span>  <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> . <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #32cd32;">5</span> ]" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">bi</span>      <span style="color: #66f;">(  xqq-   )</span> &amp;sip <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">(  xqq- )</span> Apply <span style="color: #00ffff;">each</span> quote to a <span style="color: #00ffff;">copy</span> of x" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">bi*</span>     <span style="color: #66f;">( xyqq-   )</span> &amp;dip <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xyqq- )</span> Apply q1 to x <span style="color: #00ffff;">and</span> q2 to y" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">bi@</span>     <span style="color: #66f;">(  xyq-   )</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">bi*</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">(  xyq- )</span> Apply q to x <span style="color: #00ffff;">and</span> y" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">tri</span>     <span style="color: #66f;">( xqqq-   )</span> <span style="color: #00ffff;">[</span> &amp;sip <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">sip</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xqqq- )</span> Apply <span style="color: #00ffff;">each</span> quote to a <span style="color: #00ffff;">copy</span> of x" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">tri*</span>    <span style="color: #66f;">( xyzqqq- )</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">swap</span> &amp;dip <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">]</span> 2dip <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xyzqqq- )</span> Apply q1 to x, q2 to y, <span style="color: #00ffff;">and</span> q3 to z" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">tri@</span>    <span style="color: #66f;">( xyzq-   )</span> <span style="color: #00ffff;">2dup</span> <span style="color: #00ffff;">tri*</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xyzq- )</span> Apply q to x, y, <span style="color: #00ffff;">and</span> z" :doc

<span style="color: #c63; font-weight: bold;">:</span> cons    <span style="color: #66f;">(  ab-q   )</span> 2push <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">[</span> 2pop &amp;.data <span style="color: #00ffff;">bi@</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( ab-q )</span> Create a quote returning two data elements" :doc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-13" class="outline-3">
<h3 id="sec-6-13"><span class="section-number-3">6.13</span> <span class="todo TODO">TODO</span> preserve stack comment looks wrong here.</h3>
<div class="outline-text-3" id="text-6-13">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> preserve <span style="color: #66f;">( aq-    )</span> <span style="color: #00ffff;">swap</span> &amp;@ <span style="color: #00ffff;">sip</span> <span style="color: #00ffff;">[</span> &amp;do <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( aq- )</span> Given a <span style="color: #c63; font-weight: bold;">variable</span> (a) <span style="color: #00ffff;">and</span> a quote (q), preserve the contents of (a) <span style="color: #ffd700; font-weight: bold;">while</span> executing  the quote, <span style="color: #00ffff;">and</span> restore the original contents  of (a) after execution completes. (a) <span style="color: #c63; font-weight: bold;">is</span> removed from the stack before (q) <span style="color: #c63; font-weight: bold;">is</span> executed." :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">when</span>    <span style="color: #66f;">(  nqq-n  )</span>
  <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">swap</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">swap</span>
  <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">2drop</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( nqq-n )</span> Execute q1, <span style="color: #c63; font-weight: bold;">with</span> a <span style="color: #00ffff;">copy</span> of n <span style="color: #00ffff;">on</span> the stack.\n\nIf q1 returns a true flag, run q2 <span style="color: #00ffff;">and</span> exit the caller.\n\nIf not, discard q2 <span style="color: #00ffff;">and</span> return to the  caller.\n\nq2 <span style="color: #c63; font-weight: bold;">is</span> permitted to discard n, which will alter the stack effect." :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">whend</span>   <span style="color: #66f;">( nqq-? )</span>
  <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">swap</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">swap</span>
  <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">nip</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">2drop</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( nqq-? )</span> Execute q1, <span style="color: #c63; font-weight: bold;">with</span> a <span style="color: #00ffff;">copy</span> of n <span style="color: #00ffff;">on</span> the stack.\n\nIf q1 returns a true flag, <span style="color: #00ffff;">drop</span> n, run q2 <span style="color: #00ffff;">and</span> exit the caller.\n\nIf not, discard q2 <span style="color: #00ffff;">and</span> return to the caller. " :doc

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">for</span>   <span style="color: #66f;">( R: n-  C: -a )</span> <span style="color: #00ffff;">here</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">push</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">next</span>  <span style="color: #66f;">( R: -   C: a- )</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">pop</span> <span style="color: #32cd32;">7</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
  <span style="color: #c63; font-weight: bold;">:</span> i 2pop <span style="color: #00ffff;">pop</span> 2over 2push <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">-</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">push</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> tors  <span style="color: #66f;">(    -n )</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">pop</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">dup</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">push</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #66f;">(  nq-  )</span>
    <span style="color: #00ffff;">over</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">swap</span> <span style="color: #ffd700; font-weight: bold;">for</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">dip</span> <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">2drop</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( nq- )</span> Run quote (n) times" :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">iterd</span> <span style="color: #66f;">(  nq-  )</span>
    <span style="color: #00ffff;">over</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">swap</span> <span style="color: #ffd700; font-weight: bold;">for</span> tors <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">dip</span> <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">2drop</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( nq- )</span> Run quote (n) <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">and</span> <span style="color: #00ffff;">push</span> counter to stack <span style="color: #00ffff;">each</span> time. Counts down." :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">iter</span>  <span style="color: #66f;">(  nq-  )</span>
    <span style="color: #00ffff;">over</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">push</span> <span style="color: #ffd700; font-weight: bold;">for</span> i <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">dip</span> <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">2drop</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">2drop</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( nq- )</span> Run quote (n) <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">and</span> <span style="color: #00ffff;">push</span> counter to stack <span style="color: #00ffff;">each</span> time. Counts up." :doc
<span style="color: #c63; font-weight: bold;">}}</span>

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">each</span>   <span style="color: #66f;">(  qa- )</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">dup</span> &amp;do <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">sip</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">2drop</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> array  <span style="color: #66f;">(  aq- )</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">@+</span> <span style="color: #00ffff;">dup</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">&gt;</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">each</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">2drop</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> buffer <span style="color: #66f;">( anq- )</span> 2rot <span style="color: #00ffff;">each</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #66f;">list</span>   <span style="color: #66f;">(  lq- )</span> <span style="color: #00ffff;">[</span> &amp;@ <span style="color: #00ffff;">dip</span> 2over <span style="color: #00ffff;">[</span> &amp;do <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">while</span> <span style="color: #00ffff;">2drop</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> &lt;each@&gt; <span style="color: #66f;">( ...t- )</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( ...t- )</span> Hook into **each@** <span style="color: #ffd700; font-weight: bold;">for</span> adding additional types" :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">each@</span>   <span style="color: #66f;">( ...t- )</span>
    <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span>  <span style="color: #66f;">( ARRAY  )</span> == <span style="color: #00ffff;">]</span> &amp;array                     <span style="color: #ffd700; font-weight: bold;">whend</span>
    <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">1</span>  <span style="color: #66f;">( BUFFER )</span> == <span style="color: #00ffff;">]</span> &amp;buffer                    <span style="color: #ffd700; font-weight: bold;">whend</span>
    <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">2</span>  <span style="color: #66f;">( STRING )</span> == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> &amp;withLength <span style="color: #00ffff;">dip</span> buffer <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
    <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">3</span>  <span style="color: #66f;">( LIST   )</span> == <span style="color: #00ffff;">]</span> &amp;list                      <span style="color: #ffd700; font-weight: bold;">whend</span>
    &lt;each@&gt; <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( ...t- )</span> Supercombinator <span style="color: #ffd700; font-weight: bold;">for</span> applying a quote to <span style="color: #00ffff;">each</span> item in various data structures.\nProvide one of the following stack forms:\n\n    ARRAY:  aq-\n    BUFFER: anq-\n    STRING: $q-\n    LIST: lq-\n\nFor LIST, *l* should be a <span style="color: #c63; font-weight: bold;">variable</span> pointing to the list.\n\nThe quote will be given the address of the current element <span style="color: #c63; font-weight: bold;">with</span> <span style="color: #00ffff;">each</span> time it <span style="color: #c63; font-weight: bold;">is</span> invoked by each@." :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
<div id="outline-container-sec-6-13-1" class="outline-4">
<h4 id="sec-6-13-1"><span class="section-number-4">6.13.1</span> <span class="todo TODO">TODO</span> | Now for more combinators.</h4>
<div class="outline-text-4" id="text-6-13-1">
</div><ol class="org-ol"><li>: []      (    -    ) ` [ ` ] ; immediate<br/><div class="outline-text-5" id="text-6-13-1-1">
<p>
Create an empty quote.
</p>
</div>
</li>
<li>: while   (   q-    ) [ repeat dup dip swap 0; drop again ] do drop ;<br/><div class="outline-text-5" id="text-6-13-1-2">
<p>
Execute quote until quote returns a flag of 0
</p>
</div>
</li>
<li>: curry   (  nq-q   ) [ [ ` [ ] dip .data ] dip , ` ] ;<br/><div class="outline-text-5" id="text-6-13-1-3">
<p>
Bind data and an action into a new quote. E.g., the following forms are
identical in functionality:
</p>

<p>
5 [ putn ] curry
[ 5 [ putn ] do ]
</p>
</div>
</li>
<li>: take    (  qq-q   ) swap [ [ ` [ ] dip , ] dip .data ` ] ;<br/><div class="outline-text-5" id="text-6-13-1-4">
<p>
Bind data and an action into a new quote. This is dlightly different
than "curry" in that these forms are identical:
</p>

<p>
5 [ putn ] curry
[ [ putn ] do 5 ]
</p>
</div>
</li>
<li>:  bi      (  xqq-   ) &amp;sip dip do ;<br/><div class="outline-text-5" id="text-6-13-1-5">
<p>
Apply each quote to a copy of x
</p>
</div>
</li>
<li>:  bi*     ( xyqq-   ) &amp;dip dip do ;<br/><div class="outline-text-5" id="text-6-13-1-6">
<p>
Apply q1 to x and q2 to y
</p>
</div>
</li>
<li>:  bi@     (  xyq-   ) dup bi* ;<br/><div class="outline-text-5" id="text-6-13-1-7">
<p>
Apply q to x and y
</p>
</div>
</li>
<li>:  tri     ( xqqq-   ) [ &amp;sip dip sip ] dip do ;<br/><div class="outline-text-5" id="text-6-13-1-8">
<p>
Apply each quote to a copy of x
</p>
</div>
</li>
<li>:  tri*    ( xyzqqq- ) [ [ swap &amp;dip dip ] dip dip ] dip do ;<br/><div class="outline-text-5" id="text-6-13-1-9">
<p>
Apply q1 to x, q2 to y, and q3 to z
</p>
</div>
</li>
<li>:  tri@    ( xyzq-   ) 2dup tri* ;<br/><div class="outline-text-5" id="text-6-13-1-10">
<p>
Apply q to x, y, and z
</p>
</div>
</li>
<li>: cons    (  ab-q   ) 2push ` [ 2pop &amp;.data bi@ ` ] ;<br/><div class="outline-text-5" id="text-6-13-1-11">
<p>
Create a quote returning two data elements. These forms are
identical:
</p>

<p>
1 2 cons
[ 1 2 ]
</p>
</div>
</li>
<li>:  preserve ( aq-    ) swap [ @ ] sip [ [ do ] dip ] dip ! ;<br/><div class="outline-text-5" id="text-6-13-1-12">
<p>
Given a variable (a) and a quote (q), preserve the contents of (a) while
executing the quote, and restore the original contents of (a) after
execution completes.
</p>

<p>
(a) is removed from the stack before (q) is executed.
</p>

<p>
We'll see this in use later.
</p>
</div>
</li>
<li>:  when    (  nqq-n  )<br/><div class="outline-text-5" id="text-6-13-1-13">
<p>
[ over swap do ] dip swap
[ do -1 ] [ drop 0 ] if 0; pop 2drop ;
</p>

<p>
Execute q1, with a copy of n on the stack. If q1 returns a true flag, run q2
and exit caller. If not, discard q2 and return to caller. q2 is permitted to
discard n, which will alter the stack effect.
</p>

<p>
{{
</p>
<pre class="example">
for   ( R: n-  C: -a ) here ` push ; compile-only
next  ( R: -   C: a- ) ` pop 7 , , ; compile-only
i 2pop pop 2over 2push swap - swap push ;
tors  (    -n ) ` pop ` dup ` push ; compile-only
</pre>

<p>
Internal factors used to build the next three combinators.
</p>

<p>
&#x2014;reveal&#x2014;
</p>

<pre class="example">
times (  nq-  )
</pre>
<p>
over 1 &gt;= [ swap for dup dip next drop ] [ 2drop ] if ;
</p>

<p>
The "times" combinator runs a quote (n) times
</p>

<pre class="example">
iterd (  nq-  )
</pre>
<p>
over 1 &gt;= [ swap for tors swap dup dip next drop ] [ 2drop ] if ;
</p>

<p>
The "iterd" combinartor runs a quote (n) times and push counter to stack each time. Counts down.
</p>

<pre class="example">
iter  (  nq-  )
</pre>
<p>
over 1 &gt;= [ swap dup push for i swap dup dip next pop 2drop ] [ 2drop ] if ;
</p>

<p>
The "iter" combinator runs a quote (n) times and push counter to stack each time. Counts up.
</p>

<p>
}}
</p>
</div>
</li>
<li>each@<br/><div class="outline-text-5" id="text-6-13-1-14">
<p>
And now onto "each@". This one is a complex combinator, in that it has
differing stack effects based on the data types being passed to it. First the
code:
</p>

<p>
{{
</p>
<pre class="example">
&lt;each&gt; (  qa- ) [ dup [ swap dup &amp;do dip ] dip 1+ ] times 2drop ;
array  (  aq- ) swap @+ dup 1 &gt; [ &lt;each&gt; ] [ 2drop ] if ;
buffer ( anq- ) 2rot &lt;each&gt; ;
list   (  lq- ) [ &amp;@ dip 2over [ [ do ] dip ] dip over @ ] while 2drop ;
</pre>
<p>
&#x2014;reveal&#x2014;
</p>
<pre class="example">
&lt;each@&gt; ( ...t- ) drop ;
each@   ( ...t- )
</pre>
<p>
    [ 0  ( ARRAY  ) = ] [ drop array                  ] when
    [ 1  ( BUFFER ) = ] [ drop buffer                 ] when
    [ 2  ( STRING ) = ] [ drop &amp;withLength dip buffer ] when
    [ 3  ( LIST   ) = ] [ drop list                   ] when
    &lt;each@&gt; ;
}}
</p>

<p>
And the notes from the documentation:
</p>

<p>
&lt;each@&gt;         ( &#x2026;t-     )  Hook into <span class="underline"><span class="underline">each@</span></span> for adding additional types
each@           ( &#x2026;t-     )  Supercombinator for applying quote to each item
                               in various data structures. Also provide on the
                               stack:
</p>

<p>
ARRAY:    aq-
BUFFER:  anq-
STRING:   $q-
 LIST:     lq-
</p>

<p>
The quote is given the address of the current
element each time it is invoked.
</p>

<p>
We'll see this in use later.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-14" class="outline-3">
<h3 id="sec-6-14"><span class="section-number-3">6.14</span> <span class="todo TODO">TODO</span> ( Memory Blocks <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-14">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">copy</span>   <span style="color: #66f;">( aan-  )</span> <span style="color: #00ffff;">[</span> &amp;@+ <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">2drop</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( aan- )</span> Copy n values from source (a1) to dest (a2)" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">fill</span>   <span style="color: #66f;">( ann-  )</span> <span style="color: #00ffff;">swap</span> !here <span style="color: #00ffff;">[</span> @here <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( ann- )</span> Fill (n2) memory locations starting at (a) <span style="color: #c63; font-weight: bold;">with</span> <span style="color: #c63; font-weight: bold;">value</span> (n1)" :doc
</pre>
</div>
</div>

<div id="outline-container-sec-6-14-1" class="outline-4">
<h4 id="sec-6-14-1"><span class="section-number-4">6.14.1</span> <span class="todo TODO">TODO</span> | memory blocks</h4>
<div class="outline-text-4" id="text-6-14-1">
</div><ol class="org-ol"><li>: copy   ( aan-  ) [ &amp;@+ dip !+ ] times 2drop ;<br/><div class="outline-text-5" id="text-6-14-1-1">
<p>
This is used to copy a block of memory from one location to another. It is
not intended for moving blocks backwards, and overlaps may be troublesome.
</p>
</div>
</li>
<li>: fill   ( ann-  ) swap !here [ @here swap !+ ] times drop ;<br/><div class="outline-text-5" id="text-6-14-1-2">
<p>
Fill a block of memory with a value. We use "here" to hold this value.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-15" class="outline-3">
<h3 id="sec-6-15"><span class="section-number-3">6.15</span> <span class="todo TODO">TODO</span> ( Conditionals <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-15">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">ahead</span>  <span style="color: #66f;">(   -a  )</span> <span style="color: #32cd32;">8</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">here</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( -a )</span> Used in conditionals; compiles a branch to be patched in later" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ffd700; font-weight: bold;">if;</span>    <span style="color: #66f;">(  f-   )</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">not</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
" <span style="color: #66f;">( f- )</span> Exit function <span style="color: #ffd700; font-weight: bold;">if</span> TOS <span style="color: #c63; font-weight: bold;">is</span> a non-zero flag" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">within</span> <span style="color: #66f;">( xlu-f )</span> &amp;over <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">&lt;=</span> &amp;&gt;= <span style="color: #00ffff;">dip</span> <span style="color: #00ffff;">and</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( xlu-f )</span> Is (x) <span style="color: #00ffff;">within</span> lower (l) <span style="color: #00ffff;">and</span> upper (u) bounds?" :doc
</pre>
</div>
</div>
<div id="outline-container-sec-6-15-1" class="outline-4">
<h4 id="sec-6-15-1"><span class="section-number-4">6.15.1</span> <span class="todo TODO">TODO</span> | conditionals</h4>
<div class="outline-text-4" id="text-6-15-1">
</div><ol class="org-ol"><li>: ahead  (   -a  ) 8 , here 0 , ;<br/><div class="outline-text-5" id="text-6-15-1-1">
<p>
Compile a branch to 0, leaving a pointer to the branch target that we can set
later.
</p>
</div>
</li>
<li>: if;    (  f-   ) ` not ` 0; ` drop ; compile-only<br/><div class="outline-text-5" id="text-6-15-1-2">
<p>
Exits a function if TOS is not zero. Useful in unconditional loops.
</p>
</div>
</li>
<li>: within ( xlu-f ) &amp;over dip &lt;= &amp;&gt;= dip and ;<br/><div class="outline-text-5" id="text-6-15-1-3">
<p>
Attempt to see if a value is within lower and upper bounds. This is inclusive.
E.g.,
</p>

<p>
1 1 3 within
</p>

<p>
Would return true, as the upper and lower bounds are included in the set
checked.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-16" class="outline-3">
<h3 id="sec-6-16"><span class="section-number-3">6.16</span> <span class="todo TODO">TODO</span> ( Data Structures <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-16">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">variable:</span>  <span style="color: #66f;">( n"-  )</span> <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( n``- )</span> Create a new <span style="color: #c63; font-weight: bold;">variable</span> <span style="color: #c63; font-weight: bold;">with</span> an initial <span style="color: #c63; font-weight: bold;">value</span> " :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">variable</span>   <span style="color: #66f;">(  "-  )</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">variable:</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( ``- )</span> Create a new <span style="color: #c63; font-weight: bold;">variable</span> <span style="color: #c63; font-weight: bold;">with</span> an initial <span style="color: #c63; font-weight: bold;">value</span> of 0" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">constant</span>   <span style="color: #66f;">( n"-  )</span> <span style="color: #c63; font-weight: bold;">create</span> @last !d-&gt;xt <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( n``- )</span> Create a numeric constant" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">string:</span>    <span style="color: #66f;">( $"-  )</span> <span style="color: #00ffff;">keepString</span> <span style="color: #c63; font-weight: bold;">constant</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( $``- )</span> Create a string constant" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">allot</span>      <span style="color: #66f;">(  n-  )</span> <span style="color: #00ffff;">dup</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">&lt;</span> <span style="color: #00ffff;">[</span> +heap <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( n- )</span> Allocate space in the heap" :doc

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #66f;">list</span>     <span style="color: #66f;">(  n-a )</span> <span style="color: #00ffff;">here</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">allot</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> element  <span style="color: #66f;">(  a-a )</span> <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #00ffff;">dup</span> @last !d-&gt;xt <span style="color: #00ffff;">1+</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">elements</span> <span style="color: #66f;">( n"-  )</span> <span style="color: #00ffff;">dup</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">swap</span> &amp;element <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( n``- )</span> Create a series of variables" :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
<div id="outline-container-sec-6-16-1" class="outline-4">
<h4 id="sec-6-16-1"><span class="section-number-4">6.16.1</span> data structures</h4>
<div class="outline-text-4" id="text-6-16-1">
</div><ol class="org-ol"><li>:  variable:  ( n"-  ) create , ;<br/></li>
<li>:  variable   (  "-  ) 0 variable: ;<br/><div class="outline-text-5" id="text-6-16-1-2">
<p>
Variables are created using these. The first form takes an initial value from
the stack; the second initializes the variable to zero.
</p>
</div>
</li>
<li>:  constant   ( n"-  ) create @last !d-&gt;xt ;<br/><div class="outline-text-5" id="text-6-16-1-3">
<p>
Here we abuse the classes to create constants. We alter the xt field to hold
the value of the constant, and let ".data" take care of the details. Trying to
execute a constant is not possible.
</p>
</div>
</li>
<li>: allot      (  n-  ) dup 0 &lt; [ +heap ] [ repeat 0; 1- 0 , again ] if ;<br/><div class="outline-text-5" id="text-6-16-1-4">
<p>
Allocate (or free) space in the heap. Pass a negative value to free, or a
positive one to allocate space. This will zero out memory when allocating, but
not when freeing.
</p>

<p>
TIP:
</p>

<p>
If you don't need the zeroing out, you can save space by doing:
</p>
<pre class="example">
allot ( n- ) +heap ;
</pre>
<p>
Instead.
</p>

<p>
Now for a beautiful thing from Like (docl in #retro):
</p>

<p>
{{
</p>
<pre class="example">
list     (  n-a ) here swap allot ;
element  (  a-a ) create dup @last !d-&gt;xt 1+ ;
</pre>
<p>
&#x2014;reveal&#x2014;
</p>
<pre class="example">
elements ( n"-  ) dup list swap &amp;element times drop ;
</pre>
<p>
}}
</p>

<p>
Elements are like a series of variables, but with an important twist:
the data is sequential in memory, not broken up by the headers. So the
following can be done to create a simple array with named items:
</p>

<p>
3 elements A B C
100 200 300 A !+ !+ !+ drop
A @+ putn @+ putn @+ putn drop
</p>

<p>
As can be seen, this can be useful if you need easy access to an array of
data.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-17" class="outline-3">
<h3 id="sec-6-17"><span class="section-number-3">6.17</span> <span class="todo TODO">TODO</span> ( Numbers and Math <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-17">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">decimal</span> <span style="color: #66f;">( - )</span> <span style="color: #32cd32;">10</span> !base <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Switch **base** to 10" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">hex</span>     <span style="color: #66f;">( - )</span> <span style="color: #32cd32;">16</span> !base <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Switch **base** to 16" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">octal</span>   <span style="color: #66f;">( - )</span>  <span style="color: #32cd32;">8</span> !base <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Switch **base** to  8" :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">binary</span>  <span style="color: #66f;">( - )</span>  <span style="color: #32cd32;">2</span> !base <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Switch **base** to  2" :doc
</pre>
</div>
</div>
<div id="outline-container-sec-6-17-1" class="outline-4">
<h4 id="sec-6-17-1"><span class="section-number-4">6.17.1</span> numeric bases</h4>
<div class="outline-text-4" id="text-6-17-1">
</div><ol class="org-ol"><li>:  decimal ( - ) 10 !base ;<br/></li>
<li>:  hex     ( - ) 16 !base ;<br/></li>
<li>:  octal   ( - )  8 !base ;<br/></li>
<li>:  binary  ( - )  2 !base ;<br/><div class="outline-text-5" id="text-6-17-1-4">
<p>
Change the current base. Nothing fancy here.
</p>
</div>
</li>
<li>toString<br/><div class="outline-text-5" id="text-6-17-1-5">
<p>
{{
  create buf   32 allot
  2 elements digits pos
</p>
<pre class="example">
split    (   n-... )
</pre>
<p>
repeat @base /mod swap numbers + @ swap digits ++ 0; again ;
</p>
<pre class="example">
build    ( ...-    )
</pre>
<p>
buf @pos [ @pos swap !+ ] ifTrue
@digits [ !+ ] times 0 swap ! ;
</p>
<pre class="example">
negate?  (   n-n   ) dup 0 &gt;= if; negate 45 !pos ;
</pre>
<p>
&#x2014;reveal&#x2014;
</p>
<pre class="example">
toString (   n-$   ) 0 [ !pos ] [ !digits ] bi negate? split build buf ;
</pre>
<p>
}}
</p>

<p>
Convert a number into a string. This uses "numbers" from the kernel.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-18" class="outline-3">
<h3 id="sec-6-18"><span class="section-number-3">6.18</span> <span class="todo TODO">TODO</span> ( Output <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-18">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">create</span> buf   <span style="color: #32cd32;">32</span> <span style="color: #00ffff;">allot</span>
  <span style="color: #32cd32;">2</span> <span style="color: #c63; font-weight: bold;">elements</span> digits pos
  <span style="color: #c63; font-weight: bold;">:</span> split    <span style="color: #66f;">(   n-... )</span>
    <span style="color: #ffd700; font-weight: bold;">repeat</span> @base <span style="color: #00ffff;">/mod</span> <span style="color: #00ffff;">swap</span> numbers <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">swap</span> digits <span style="color: #00ffff;">++</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> build    <span style="color: #66f;">( ...-    )</span>
    buf @pos <span style="color: #00ffff;">[</span> @pos <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span>
    @digits <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">!+</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> negate?  <span style="color: #66f;">(   n-n   )</span> <span style="color: #00ffff;">dup</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">&gt;=</span> <span style="color: #ffd700; font-weight: bold;">if;</span> negate <span style="color: #32cd32;">45</span> !pos <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> toString <span style="color: #66f;">(   n-$   )</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">[</span> !pos <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> !digits <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> negate? split build buf <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( n-$ )</span> Convert a number into a string" :doc
<span style="color: #c63; font-weight: bold;">}}</span>

<span style="color: #c63; font-weight: bold;">:</span> clear <span style="color: #66f;">(  - )</span> <span style="color: #32cd32;">-1</span> putc <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Clear the display" :doc

<span style="color: #c63; font-weight: bold;">:</span> space <span style="color: #66f;">(  - )</span> <span style="color: #32cd32;">32</span> putc <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Display a space character (ASCII 32)" :doc

<span style="color: #c63; font-weight: bold;">:</span> putn  <span style="color: #66f;">( n- )</span> toString puts <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( n- )</span> Display a number" :doc
</pre>
</div>
</div>
<div id="outline-container-sec-6-18-1" class="outline-4">
<h4 id="sec-6-18-1"><span class="section-number-4">6.18.1</span> <span class="todo TODO">TODO</span> | output</h4>
<div class="outline-text-4" id="text-6-18-1">
</div><ol class="org-ol"><li>: clear (  - ) -1 putc ;<br/><div class="outline-text-5" id="text-6-18-1-1">
<p>
Clear the display.
</p>
</div>
</li>
<li>: space (  - ) 32 putc ;<br/><div class="outline-text-5" id="text-6-18-1-2">
<p>
Display a space character.
</p>
</div>
</li>
<li>: putn  ( n- ) toString puts ;<br/><div class="outline-text-5" id="text-6-18-1-3">
<p>
Display a number. This does not add a trailing space.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-19" class="outline-3">
<h3 id="sec-6-19"><span class="section-number-3">6.19</span> <span class="todo TODO">TODO</span> ( Parsing prefixes <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-19">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> .parse  <span style="color: #66f;">(  a- )</span> <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a- )</span> Class <span style="color: #ffd700; font-weight: bold;">for</span> parsing prefixes" :doc

<span style="color: #c63; font-weight: bold;">:</span> parsing <span style="color: #66f;">(   - )</span> &amp;.parse reclass <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( - )</span> Set most recent function to **.parse** class" :doc

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> number <span style="color: #66f;">( a- )</span> base <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">do</span> toNumber <span style="color: #c63; font-weight: bold;">.data</span> <span style="color: #00ffff;">]</span> preserve <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> __$   <span style="color: #66f;">( $-n )</span> &amp;hex     number <span style="color: #c63; font-weight: bold;">;</span> parsing
  " <span style="color: #66f;">( $-n )</span> Prefix; treat number as hexadecimal (base" :doc

  <span style="color: #c63; font-weight: bold;">:</span> __#   <span style="color: #66f;">( $-n )</span> &amp;decimal number <span style="color: #c63; font-weight: bold;">;</span> parsing
  " <span style="color: #66f;">( $-n )</span> Prefix; treat number as <span style="color: #c63; font-weight: bold;">decimal</span> (base 10)" :doc

  <span style="color: #c63; font-weight: bold;">:</span> __%   <span style="color: #66f;">( $-n )</span> &amp;binary  number <span style="color: #c63; font-weight: bold;">;</span> parsing
  " <span style="color: #66f;">( $-n )</span> Prefix; treat number as <span style="color: #c63; font-weight: bold;">binary</span> (base 2)" :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #ff6347;">__'</span>   <span style="color: #66f;">( $-n )</span> <span style="color: #00ffff;">@</span> <span style="color: #c63; font-weight: bold;">.data</span>         <span style="color: #c63; font-weight: bold;">;</span> parsing
  " <span style="color: #66f;">( $-n )</span> Return character following '" :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
<div id="outline-container-sec-6-19-1" class="outline-4">
<h4 id="sec-6-19-1"><span class="section-number-4">6.19.1</span> <span class="todo TODO">TODO</span> | prefix parsing</h4>
<div class="outline-text-4" id="text-6-19-1">
<p>
With this covered, the code moves on to replace the simple prefix handler with
one aware of Luke's parsing prefixes:
</p>

<p>
{{
  4 elements xt class name flag
  create <span class="underline">_</span> 95 , 95 , 95 , 0 ,
</p>

<p>
( Split Token into Prefix and Name <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )
</p>
<pre class="example">
action   (  -   ) @xt @class withClass ;
(split   (  -a  ) @+ ___ tuck 1+ 1+ ! swap !name ;
prefix)  ( $-f  )
</pre>
<p>
find [ [ @d-&gt;class !class ] [ @d-&gt;xt !xt ] bi -1 ] [ 0 ] if ;
</p>

<p>
( Prefix Handling <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )
</p>
<pre class="example">
handle   (  -   )
</pre>
<p>
@class &amp;.parse =
[ flag off @name action ]
[ @name find [ @d-&gt;xt action flag off ] [ drop ] if ]
if ;
</p>

<p>
( Main Wrapper <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )
</p>
<pre class="example">
try      (  -   )
</pre>
<p>
    flag on tib (split prefix) [ handle ] [ drop ] if @flag ;
  &amp;try is &lt;notFound&gt;
}}
</p>

<p>
The main difference here is that we check to see if the class is ".parse", and
act differently if it is. So once this is done, we get to define string parsing.
</p>

<p>
{{
</p>
<pre class="example">
buffers ( -a ) 2048 here + ;
</pre>
<p>
  variable next
&#x2014;reveal&#x2014;
</p>
<pre class="example">
tempString ( $-$ )
</pre>
<p>
    withLength 1+
    @next 12 =if 0 !next then
    @next 512 * buffers + [ swap copy ] sip
    next ++ ;
}}
</p>

<p>
First up, a rotating string buffer for holding temporary strings. We place
these at 2k above here, so it's a floating buffer, and allocate 512 chars
per string. Up to 12 can be created, after which, this cycles back, with
newer strings replacing older ones.
</p>

<p>
{{
  variable end
</p>
<pre class="example">
pad     (  -a ) 1024 here + ;
keep    (  -  ) @compiler &amp;keepString &amp;tempString if .data ;
&gt;pad    ( $-$ ) pad over getLength 1+ copy pad keep ;
chop    ( $-$ ) end -- 0 @end ! ;
&gt;$      ( n-  ) dup 8 = [ chop drop ] [ @end !+ !end ] if ;
end?    ( $-$ ) @end @1- '" = [ chop &gt;pad -1 ] [ 0 ] if ;
noEat   ( q-  ) eatLeading? off do eatLeading? on ;
withPad ( q-  ) 32 pad 1- ! &amp;pad &amp;tib :is noEat &amp;tib :devector ;
get     (  -c ) getc dup putc ;
</pre>
<p>
&#x2014;reveal&#x2014;
</p>
<pre class="example">
__"  ( "-a )
</pre>
<p>
dup withLength + !end
end? [ 32 &gt;$ [ end? [ 0 ] [ get &gt;$ -1 ] if ] while ] ifFalse ; parsing
</p>
<pre class="example">
"    ( "-$ ) [ '" accept pad 1- keep ] withPad ; immediate
</pre>
<p>
}}
</p>

<p>
All of this to get two functions.
</p>

<p>
__"
</p>

<p>
Our new parsing prefix. This will let us create strings in a more natural
feeling manner:
</p>

<p>
"hello, world!"
</p>

<p>
For strings with leading spaces, we have:
</p>

<p>
"
</p>

<p>
Which is used like:
</p>

<p>
"   &lt;&#x2013; 3 spaces"
</p>

<p>
The actual mechanics are a bit tricky, but it works quite well in practice.
</p>

<p>
Next up: a more flexible output function.
</p>

<p>
-1 variable: formatted
</p>

<p>
This is a variable controlling whether to use the complex output or the
default, simpler output.
</p>
</div>
</div>
<div id="outline-container-sec-6-19-2" class="outline-4">
<h4 id="sec-6-19-2"><span class="section-number-4">6.19.2</span> <span class="todo TODO">TODO</span> | prefix parsing</h4>
<div class="outline-text-4" id="text-6-19-2">
</div><ol class="org-ol"><li>: .parse  (  a- ) do ;<br/></li>
<li>:  parsing (   - ) &amp;.parse reclass ;<br/><div class="outline-text-5" id="text-6-19-2-2">
<p>
{{
</p>
<pre class="example">
number ( a- ) base [ do toNumber .data ] preserve ;
</pre>
<p>
&#x2014;reveal&#x2014;
</p>
<pre class="example">
__$   ( $-n ) &amp;hex     number ; parsing
__#   ( $-n ) &amp;decimal number ; parsing
__%   ( $-n ) &amp;binary  number ; parsing
__'   ( $-n ) @ .data         ; parsing
</pre>
<p>
}}
</p>

<p>
Parsing prefixes from Luke. These aren't functional yet, but will a little
later in the source.
</p>

<!-- This HTML table template is generated by emacs 24.2.1 -->
<table border="1">
  <tr>
    <td align="left" valign="top">
      &nbsp;$&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Parse&nbsp;a&nbsp;number&nbsp;as&nbsp;hexadecimal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;#&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Parse&nbsp;a&nbsp;number&nbsp;as&nbsp;decimal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;%&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Parse&nbsp;a&nbsp;number&nbsp;as&nbsp;binary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;'&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Parse&nbsp;and&nbsp;return&nbsp;first&nbsp;character&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>

<p>
Notice that the "number" code uses "preserve" to save and restore the "base"
for us.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-20" class="outline-3">
<h3 id="sec-6-20"><span class="section-number-3">6.20</span> <span class="todo TODO">TODO</span> ( Chained Vocabularies <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-20">
</div><div id="outline-container-sec-6-20-1" class="outline-4">
<h4 id="sec-6-20-1"><span class="section-number-4">6.20.1</span> dicts</h4>
<div class="outline-text-4" id="text-6-20-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">create</span> dicts <span style="color: #32cd32;">64</span> <span style="color: #00ffff;">allot</span>
" <span style="color: #66f;">( -a )</span> Array; used by chained vocabularies <span style="color: #00ffff;">and</span> search order code" :doc
</pre>
</div>
<p>
<b>*</b>
</p>
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #32cd32;">2</span> <span style="color: #c63; font-weight: bold;">elements</span> active prior
  <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #00ff00;">"|"</span> <span style="color: #32cd32;">124</span> <span style="color: #c63; font-weight: bold;">,</span>  <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>
  <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #00ff00;">"%%"</span> <span style="color: #32cd32;">37</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">37</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>
  <span style="color: #c63; font-weight: bold;">:</span> seal   <span style="color: #66f;">(  - )</span> last <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">@</span> <span style="color: #ffd700; font-weight: bold;">0;</span> @active <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">@</span> == <span style="color: #00ffff;">]</span> until <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> revert <span style="color: #66f;">(  - )</span> @prior <span style="color: #ffd700; font-weight: bold;">0;</span> !last <span style="color: #32cd32;">0</span> !prior <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> safety <span style="color: #66f;">(  - )</span> <span style="color: #00ff00;">"%%"</span> header <span style="color: #c63; font-weight: bold;">immediate</span> &amp;revert @last !d-&gt;xt <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> %%     <span style="color: #66f;">(  - )</span> revert <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( - )</span> Close a vocabulary. Use <span style="color: #c63; font-weight: bold;">with</span> caution" :doc

  <span style="color: #c63; font-weight: bold;">:</span> &lt;%&gt;    <span style="color: #66f;">( a- )</span> @last !prior !last <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( a- )</span> Open a vocabulary. Use <span style="color: #c63; font-weight: bold;">with</span> caution" :doc

  <span style="color: #c63; font-weight: bold;">:</span> .chain <span style="color: #66f;">( a- )</span> @dicts &amp;drop &amp;&lt;%&gt; <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( a- )</span> Class <span style="color: #ffd700; font-weight: bold;">for</span> vocabularies" :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">chain:</span> <span style="color: #66f;">( "- )</span> <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> &amp;.chain reclass @last !active safety <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( ``- )</span> Create a new vocabulary" :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">;chain</span> <span style="color: #66f;">(  - )</span> seal @last @active <span style="color: #00ffff;">[</span> !last <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> !d-&gt;xt <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( - )</span> End a vocabulary" :doc

  <span style="color: #c63; font-weight: bold;">:</span> :with  <span style="color: #66f;">( a- )</span> <span style="color: #ffd700; font-weight: bold;">0;</span> @dicts <span style="color: #00ffff;">1+</span> dicts <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> dicts <span style="color: #00ffff;">++</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( a- )</span> Add a vocabulary to the search order (by pointer)" :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">with</span>   <span style="color: #66f;">( "- )</span> <span style="color: #c63; font-weight: bold;">'</span> :with <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( ``- )</span> Add a vocabulary to the search order (parses <span style="color: #ffd700; font-weight: bold;">for</span> name)" :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">without</span> <span style="color: #66f;">( - )</span> @dicts <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">1-</span> !dicts <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( - )</span> Remove a vocabulary from the search order " :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">global</span>  <span style="color: #66f;">( - )</span> <span style="color: #32cd32;">0</span> !dicts <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( - )</span> Remove all vocabularies from the search order, leaving just the <span style="color: #c63; font-weight: bold;">global</span> dictionary " :doc

  <span style="color: #c63; font-weight: bold;">:</span> findInChain <span style="color: #66f;">( $a-df )</span> :with <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #c63; font-weight: bold;">without</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( $a-df )</span> Open a chain (using **:with**) <span style="color: #00ffff;">and</span> search <span style="color: #ffd700; font-weight: bold;">for</span> a name. Closes the chain <span style="color: #ffd700; font-weight: bold;">when</span> done." :doc

  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">with|</span>  <span style="color: #66f;">( "- )</span>
    <span style="color: #c63; font-weight: bold;">global</span>
    <span style="color: #ffd700; font-weight: bold;">repeat</span>
      <span style="color: #32cd32;">32</span> <span style="color: #00ffff;">accept</span> <span style="color: #00ffff;">tib</span> <span style="color: #00ff00;">"|"</span> <span style="color: #00ffff;">compare</span> <span style="color: #ffd700; font-weight: bold;">if;</span>
      <span style="color: #00ffff;">tib</span> <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #00ffff;">[</span> @d-&gt;xt :with <span style="color: #00ffff;">]</span> &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span>
    <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( ``- )</span> Open a series of vocabularies, ending <span style="color: #ffd700; font-weight: bold;">when</span> ``  <span style="color: #c63; font-weight: bold;">is</span> encountered" :doc
<span style="color: #c63; font-weight: bold;">}}</span>

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">rename:</span> <span style="color: #66f;">( a"- )</span>
  <span style="color: #c63; font-weight: bold;">create</span> <span style="color: #00ffff;">dup</span> xt-&gt;d <span style="color: #00ffff;">swap</span> :hide
  <span style="color: #00ffff;">[</span> @d-&gt;xt @last !d-&gt;xt <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> @d-&gt;class @last !d-&gt;class <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #c63; font-weight: bold;">;</span>
" <span style="color: #66f;">( a``- )</span> Rename a function" :doc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-20-2" class="outline-4">
<h4 id="sec-6-20-2"><span class="section-number-4">6.20.2</span> <span class="todo TODO">TODO</span> | vocabularies</h4>
<div class="outline-text-4" id="text-6-20-2">
</div><ol class="org-ol"><li>And now for vocabularies. This is where things get trickier.<br/><div class="outline-text-5" id="text-6-20-2-1">
<p>
create dicts 64 allot
</p>

<p>
We allow up to 64 active vocabularies. This could be reduced to save space.
</p>

<p>
{{
  2 elements active prior
  create "|" 124 ,  0 ,
  create "%%" 37 , 37 , 0 ,
</p>

<p>
Some variables and string constants. We don't have a string parser yet, so
have to build the strings manually.
</p>
</div>
</li>
<li>:  seal   (  - ) last repeat @ 0; @active over @ =if 0 swap ! ;; then again ;<br/><div class="outline-text-5" id="text-6-20-2-2">
<p>
Close off a vocabulary.
</p>
</div>
</li>
<li>:  revert (  - ) @prior 0; !last 0 !prior ;<br/><div class="outline-text-5" id="text-6-20-2-3">
<p>
Revert to the prior vocabulary.
</p>
</div>
</li>
<li>:  safety (  - ) "%%" header immediate &amp;revert @last !d-&gt;xt ;<br/><div class="outline-text-5" id="text-6-20-2-4">
<p>
Create an initial word in every vocabulary named "%%" that will revert us to
the prior (hopefully global) vocabulary. This gives us a saftey net to help
recover from mistakes&#x2026;
</p>

<p>
&#x2014;reveal&#x2014;
</p>

<p>
The above stuff is hidden away from the global dictionary&#x2026;
</p>
</div>
</li>
<li>:  %%     (  - ) revert ;<br/><div class="outline-text-5" id="text-6-20-2-5">
<p>
Top-level version of "%%".
</p>
</div>
</li>
<li>:  &lt;%&gt;    ( a- ) @last !prior !last ;<br/><div class="outline-text-5" id="text-6-20-2-6">
<p>
Save the current vocabulary, and open a new one. This does not nest.
</p>
</div>
</li>
<li>: .chain ( a- ) @dicts &amp;drop &amp;&lt;%&gt; if ;<br/><div class="outline-text-5" id="text-6-20-2-7">
<p>
The class for handling vocabularies. You shouldn't need to use this directly.
</p>
</div>
</li>
<li>: chain: ( "- ) create 0 , &amp;.chain reclass @last !active safety ;<br/><div class="outline-text-5" id="text-6-20-2-8">
<p>
Create a new vocabulary. This is not nestable. The global dictionary is still
visible when a new vocabulary is created, so you can still access everything
defined prior to this.
</p>
</div>
</li>
<li>: ;chain (  - ) seal @last @active [ !last ] [ !d-&gt;xt ] bi ;<br/><div class="outline-text-5" id="text-6-20-2-9">
<p>
Close off a vocabulary, hiding its contents from the global dictionary.
</p>
</div>
</li>
<li>: :with  ( a- ) 0; @dicts 1+ dicts + ! dicts ++ ;<br/><div class="outline-text-5" id="text-6-20-2-10">
<p>
Given an xt of a vocabulary, add it to the search order.
</p>
</div>
</li>
<li>: with   ( "- ) ' :with ;<br/><div class="outline-text-5" id="text-6-20-2-11">
<p>
Parse for a vocabulary name and add it to the search order.
</p>
</div>
</li>
<li>:  without ( - ) @dicts 0; 1- !dicts ;<br/><div class="outline-text-5" id="text-6-20-2-12">
<p>
Remove the most recently added vocabulary from the search order.
</p>
</div>
</li>
<li>: global  ( - ) 0 !dicts ;<br/><div class="outline-text-5" id="text-6-20-2-13">
<p>
Remove all vocabularies from the search order.
</p>
</div>
</li>
<li>: findInChain ( $a-df ) :with find without ;<br/><div class="outline-text-5" id="text-6-20-2-14">
<p>
Search for a name in a specific vocabulary. Returns a dictionary header
and a flag.
</p>
</div>
</li>
<li>: with|  ( "- )<br/><div class="outline-text-5" id="text-6-20-2-15">
<p>
global
repeat
  32 accept tib "|" compare if;
  tib find [ @d-&gt;xt :with ] &amp;drop if
again ;
</p>

<p>
Add a series of vocabularies to the search order. This stops when a | is
encountered.
</p>

<p>
}}
</p>
</div>
</li>
<li>: rename: ( a"- )<br/><div class="outline-text-5" id="text-6-20-2-16">
<p>
create dup xt-&gt;d swap :hide
[ @d-&gt;xt @last !d-&gt;xt ] [ @d-&gt;class @last !d-&gt;class ] bi ;
</p>

<p>
Hide a header and create a new one.
</p>

<p>
With the above, we can create and search in dictionaries. Next we replace the
original "find" and "xt-&gt;d" functions with new ones that make use of the search
order.
</p>

<p>
{{
  5 elements flag dt name safety xt
</p>
<pre class="example">
search  (  -   ) @dicts repeat 0; dup dicts + &lt;%&gt; @xt do 1- again ;
(chains ( $-   ) !name 0 [ !dt ] [ !flag ] bi @last !safety ;
back)   (   -  ) @safety !last ;
seek    ( na-n ) @name default: find [ !dt flag on drop 1 ] [ drop ] if ;
lookup  ( $-af )
</pre>
<p>
  &amp;seek !xt (chains search back)
  @flag [ @dt @flag ] [ @name default: find ] if ;
&amp;lookup is find
</p>

<pre class="example">
seek    (   -  )
</pre>
<p>
@name default: xt-&gt;d dup [ !dt flag on drop 1 ] [ drop ] if ;
</p>
<pre class="example">
lookup  (  a-d )
</pre>
<p>
    &amp;seek !xt (chains search back)
    @flag [ @dt ] [ @name default: xt-&gt;d ] if ;
  &amp;lookup is xt-&gt;d
}}
</p>

<p>
These use "default:" to fall back into the original definitions as neccessary.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-21" class="outline-3">
<h3 id="sec-6-21"><span class="section-number-3">6.21</span> <span class="todo TODO">TODO</span> ( Extend 'find' and 'xt-&gt;d' to search chains before global <code>~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-21">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #32cd32;">5</span> <span style="color: #c63; font-weight: bold;">elements</span> flag dt name safety xt
  <span style="color: #c63; font-weight: bold;">:</span> search  <span style="color: #66f;">(  -   )</span> @dicts <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">dup</span> dicts <span style="color: #00ffff;">+</span> &lt;%&gt; @xt <span style="color: #c63; font-weight: bold;">do</span> <span style="color: #00ffff;">1-</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> (chains <span style="color: #66f;">( $-   )</span> !name <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">[</span> !dt <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> !flag <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> @last !safety <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> back)   <span style="color: #66f;">(   -  )</span> @safety !last <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> seek    <span style="color: #66f;">( na-n )</span> @name <span style="color: #c63; font-weight: bold;">default:</span> <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #00ffff;">[</span> !dt flag <span style="color: #00ffff;">on</span> <span style="color: #00ffff;">drop</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">]</span> &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> lookup  <span style="color: #66f;">( $-af )</span>
    &amp;seek !xt (chains search back)
    @flag <span style="color: #00ffff;">[</span> @dt @flag <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> @name <span style="color: #c63; font-weight: bold;">default:</span> <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  &amp;lookup <span style="color: #c63; font-weight: bold;">is</span> <span style="color: #c63; font-weight: bold;">find</span>

  <span style="color: #c63; font-weight: bold;">:</span> seek    <span style="color: #66f;">(   -  )</span>
    @name <span style="color: #c63; font-weight: bold;">default:</span> xt-&gt;d ?dup <span style="color: #00ffff;">[</span> !dt flag <span style="color: #00ffff;">on</span> <span style="color: #00ffff;">drop</span> <span style="color: #32cd32;">1</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> lookup  <span style="color: #66f;">(  a-d )</span>
    &amp;seek !xt (chains search back)
    @flag <span style="color: #00ffff;">[</span> @dt <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> @name <span style="color: #c63; font-weight: bold;">default:</span> xt-&gt;d <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  &amp;lookup <span style="color: #c63; font-weight: bold;">is</span> xt-&gt;d
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-22" class="outline-3">
<h3 id="sec-6-22"><span class="section-number-3">6.22</span> <span class="todo TODO">TODO</span> ( Extend Prefix Handler <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-22">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #32cd32;">4</span> <span style="color: #c63; font-weight: bold;">elements</span> xt class name flag
  <span style="color: #c63; font-weight: bold;">create</span> ___ <span style="color: #32cd32;">95</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">95</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">95</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span>

  <span style="color: #66f;">( Split Token into Prefix and Name ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
  <span style="color: #c63; font-weight: bold;">:</span> action   <span style="color: #66f;">(  -   )</span> @xt @class withClass <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> (split   <span style="color: #66f;">(  -a  )</span> <span style="color: #00ffff;">@+</span> ___ <span style="color: #00ffff;">tuck</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">swap</span> !name <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> prefix)  <span style="color: #66f;">( $-f  )</span>
    <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> @d-&gt;class !class <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> @d-&gt;xt !xt <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>

  <span style="color: #66f;">( Prefix Handling ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
  <span style="color: #c63; font-weight: bold;">:</span> handle   <span style="color: #66f;">(  -   )</span>
    @class &amp;.parse ==
    <span style="color: #00ffff;">[</span> flag <span style="color: #00ffff;">off</span> @name action <span style="color: #00ffff;">]</span>
    <span style="color: #00ffff;">[</span> @name <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #00ffff;">[</span> @d-&gt;xt action flag <span style="color: #00ffff;">off</span> <span style="color: #00ffff;">]</span> &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ffff;">]</span>
    <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>

  <span style="color: #66f;">( Main Wrapper ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ )</span>
  <span style="color: #c63; font-weight: bold;">:</span> try      <span style="color: #66f;">(  -   )</span>
    flag <span style="color: #00ffff;">on</span> <span style="color: #00ffff;">tib</span> (split prefix) &amp;handle &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span> @flag <span style="color: #c63; font-weight: bold;">;</span>
  &amp;try <span style="color: #c63; font-weight: bold;">is</span> &lt;notFound&gt;
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-23" class="outline-3">
<h3 id="sec-6-23"><span class="section-number-3">6.23</span> <span class="todo TODO">TODO</span> ( Core Strings <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-23">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> buffers  <span style="color: #66f;">( -a )</span>
    @memory        STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( tib     )</span>
                   STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( scratch )</span>
    STRING-BUFFERS STRING-LENGTH <span style="color: #00ffff;">*</span> <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( buffers )</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">variable</span> <span style="color: #ffd700; font-weight: bold;">next</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #00ffff;">tempString</span> <span style="color: #66f;">( $-$ )</span>
    <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">1+</span>
    @next STRING-BUFFERS == <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> !next <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span>
    @next STRING-LENGTH <span style="color: #00ffff;">*</span> buffers <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">copy</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">sip</span>
    <span style="color: #ffd700; font-weight: bold;">next</span> <span style="color: #00ffff;">++</span> <span style="color: #c63; font-weight: bold;">;</span>
  " <span style="color: #66f;">( a-a )</span> Move a string to a temporary buffer" :doc
<span style="color: #c63; font-weight: bold;">}}</span>

hide "   <span style="color: #66f;">( next we define __" and can use proper strings )</span>

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">variable</span> end
  <span style="color: #c63; font-weight: bold;">:</span> pad  <span style="color: #66f;">( -a )</span>
    @memory        STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( tib     )</span>
                   STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( scratch )</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> keep    <span style="color: #66f;">(  -  )</span> @compiler &amp;keepString &amp;tempString <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">.data</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> &gt;pad    <span style="color: #66f;">( $-$ )</span> pad <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">getLength</span> <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">copy</span> pad keep <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> chop    <span style="color: #66f;">( $-$ )</span> end <span style="color: #00ffff;">--</span> <span style="color: #32cd32;">0</span> @end <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> &gt;$      <span style="color: #66f;">( n-  )</span> <span style="color: #00ffff;">dup</span> <span style="color: #32cd32;">8</span> == <span style="color: #00ffff;">[</span> chop <span style="color: #00ffff;">drop</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> @end <span style="color: #00ffff;">!+</span> !end <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> end?    <span style="color: #66f;">( $-$ )</span> @end @1- '" == <span style="color: #00ffff;">[</span> chop &gt;pad <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> noEat   <span style="color: #66f;">( q-  )</span> eatLeading? <span style="color: #00ffff;">off</span> <span style="color: #c63; font-weight: bold;">do</span> eatLeading? <span style="color: #00ffff;">on</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> withPad <span style="color: #66f;">( q-  )</span> <span style="color: #32cd32;">32</span> pad <span style="color: #00ffff;">1-</span> <span style="color: #00ffff;">!</span> &amp;pad &amp;tib <span style="color: #c63; font-weight: bold;">:is</span> noEat &amp;tib <span style="color: #c63; font-weight: bold;">:devector</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> get     <span style="color: #66f;">(  -c )</span> getc <span style="color: #00ffff;">dup</span> putc <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> __"  <span style="color: #66f;">( "-a )</span>
    <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">+</span> !end
    end? <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">32</span> &gt;$ <span style="color: #00ffff;">[</span> end? <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> get &gt;$ <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">while</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifFalse</span> <span style="color: #c63; font-weight: bold;">;</span> parsing
  <span style="color: #00ff00;">"( ``-$ ) Prefix; parse and return a string"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> "    <span style="color: #66f;">( "-$ )</span> <span style="color: #00ffff;">[</span> '" <span style="color: #00ffff;">accept</span> pad <span style="color: #00ffff;">1-</span> keep <span style="color: #00ffff;">]</span> withPad <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">immediate</span>
  <span style="color: #00ff00;">"( ``-$ ) Parse and return a string"</span> :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-24" class="outline-3">
<h3 id="sec-6-24"><span class="section-number-3">6.24</span> <span class="todo TODO">TODO</span> ( Formatted String Display <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-24">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #32cd32;">-1</span> <span style="color: #c63; font-weight: bold;">variable:</span> formatted
<span style="color: #00ff00;">"( -a ) Variable; toggles whether **puts** uses escape sequences or not"</span> :doc

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> withBase <span style="color: #66f;">( n$q-$ )</span> &amp;swap <span style="color: #00ffff;">dip</span> base &amp;do preserve <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> char <span style="color: #66f;">( $-$ )</span>
    <span style="color: #00ffff;">@+</span> <span style="color: #00ffff;">[</span> 'n == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> cr      <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
       <span style="color: #00ffff;">[</span> <span style="color: #ff6347;">''</span> == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> '" putc <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
       <span style="color: #00ffff;">[</span> '[ == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">27</span> putc putc <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">when</span>
    putc <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> obj  <span style="color: #66f;">( $-$ )</span>
    <span style="color: #00ffff;">@+</span> <span style="color: #00ffff;">[</span> 'd == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">decimal</span> putn <span style="color: #00ffff;">]</span> withBase <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
       <span style="color: #00ffff;">[</span> 'o == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">octal</span>   putn <span style="color: #00ffff;">]</span> withBase <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
       <span style="color: #00ffff;">[</span> 'x == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #c63; font-weight: bold;">hex</span>     putn <span style="color: #00ffff;">]</span> withBase <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
       <span style="color: #00ffff;">[</span> 'c == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">swap</span> putc                 <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
       <span style="color: #00ffff;">[</span> 's == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> formatted <span style="color: #00ffff;">off</span> &amp;puts <span style="color: #00ffff;">dip</span> formatted <span style="color: #00ffff;">on</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">whend</span>
       putc <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> complex <span style="color: #66f;">( $-n )</span>
    <span style="color: #ffd700; font-weight: bold;">repeat</span>
      <span style="color: #00ffff;">@+</span> <span style="color: #ffd700; font-weight: bold;">0;</span>
      <span style="color: #00ffff;">dup</span> '\ == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> char <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span>
      <span style="color: #00ffff;">dup</span> '% == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> obj  <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span>
      putc
    <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> simple <span style="color: #66f;">( $- )</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">@</span> putc <span style="color: #00ffff;">]</span> <span style="color: #32cd32;">2</span> <span style="color: #66f;">( STRING )</span> <span style="color: #00ffff;">each@</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ffff;">[</span> update <span style="color: #00ffff;">off</span> @formatted <span style="color: #00ffff;">[</span> complex <span style="color: #00ffff;">drop</span> <span style="color: #00ffff;">]</span> &amp;simple <span style="color: #ffd700; font-weight: bold;">if</span> update <span style="color: #00ffff;">on</span> redraw <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">is</span> &lt;puts&gt;
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>

<div id="outline-container-sec-6-24-1" class="outline-4">
<h4 id="sec-6-24-1"><span class="section-number-4">6.24.1</span> <span class="todo TODO">TODO</span> | formatted strings</h4>
<div class="outline-text-4" id="text-6-24-1">
</div><ol class="org-ol"><li>number display<br/><div class="outline-text-5" id="text-6-24-1-1">
<p>
{{
</p>
<pre class="example">
withBase ( n$q-$ ) [ swap ] dip base [ do ] preserve ;
</pre>

<p>
A helper; this saves and restores the base when displaying numbers.
</p>

<pre class="example">
char ( $-$ )
</pre>
<p>
@+ [ 'n = ] [ drop cr      ] when
   [ '' = ] [ drop '" putc ] when
   [ '[ = ] [ 27 putc putc ] when
putc ;
</p>

<p>
This is the helper routine for displaying character escape sequences like
"\n" and "\'".
</p>

<pre class="example">
obj  ( $-$ )
</pre>
<p>
@+ [ 'd = ] [ drop [ decimal putn ] withBase ] when
   [ 'o = ] [ drop [ octal   putn ] withBase ] when
   [ 'x = ] [ drop [ hex     putn ] withBase ] when
   [ 'c = ] [ drop swap putc                 ] when
   [ 's = ] [ drop &amp;puts dip                 ] when
   putc ;
</p>

<p>
This is the helper routine for carrying out actions like displaying numbers,
characters, or other strings. It handles sequences like:
"%s", "%d", and so on.
</p>

<pre class="example">
complex ( $-n )
</pre>
<p>
repeat
  @+ 0;
  dup '\ = [ drop char 0 ] ifTrue
  dup '% = [ drop obj  0 ] ifTrue
  putc
again ;
</p>

<p>
Display a string, dispatching escape sequences to either "char" or "obj" as
needed.
</p>
</div>
</li>

<li>: simple ( $- ) [ @ putc ] 2 ( STRING ) each@ ;<br/><div class="outline-text-5" id="text-6-24-1-2">
<p>
And here we have an example of that "each@" combinator. This applies a quote
("[ @ putc ]") to each item in a string (data type 2). Really, it's a nice
clean way to do things like this.
</p>
</div>
</li>
<li>: defer  ( q- ) update off do update on redraw ;<br/><div class="outline-text-5" id="text-6-24-1-3">
<p>
For performance, disable screen updates until the text is written to the
output buffers. Won't hurt anything, and makes redraws much faster on some
VM implementations.
</p>

<p>
  [ [ @formatted [ complex drop ] &amp;simple if ] defer ] is &lt;puts&gt;
}}
</p>

<p>
And wrap that all up.
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-25" class="outline-3">
<h3 id="sec-6-25"><span class="section-number-3">6.25</span> <span class="todo TODO">TODO</span> ( Debugging <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-25">
</div><div id="outline-container-sec-6-25-1" class="outline-4">
<h4 id="sec-6-25-1"><span class="section-number-4">6.25.1</span> depth</h4>
<div class="outline-text-4" id="text-6-25-1">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> depth   <span style="color: #66f;">(    -n )</span> <span style="color: #32cd32;">-5</span> <span style="color: #32cd32;">5</span> out wait <span style="color: #32cd32;">5</span> in <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -n ) Return number of items on stack"</span> :doc
</pre>
</div>

<p>
Gets the stack depth.
</p>
</div>
</div>
<div id="outline-container-sec-6-25-2" class="outline-4">
<h4 id="sec-6-25-2"><span class="section-number-4">6.25.2</span> def reset</h4>
<div class="outline-text-4" id="text-6-25-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> reset   <span style="color: #66f;">( ...-  )</span> depth <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">1-</span> <span style="color: #00ffff;">nip</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ...- ) Remove all items from stack"</span> :doc
</pre>
</div>

<p>
Remove all items on the data stack. This is useful after experimenting to get back to clean stack quickly.
</p>
</div>
</div>
<div id="outline-container-sec-6-25-3" class="outline-4">
<h4 id="sec-6-25-3"><span class="section-number-4">6.25.3</span> def .s</h4>
<div class="outline-text-4" id="text-6-25-3">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> (.s)  <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">1-</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">push</span> (.s) <span style="color: #00ffff;">pop</span> <span style="color: #00ffff;">dup</span> putn space <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> .s    depth <span style="color: #00ffff;">[</span> <span style="color: #00ff00;">"\n&lt;%d&gt; "</span> puts <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">sip</span> (.s) <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( - ) Display all items on stack"</span> :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-25-4" class="outline-4">
<h4 id="sec-6-25-4"><span class="section-number-4">6.25.4</span> def words</h4>
<div class="outline-text-4" id="text-6-25-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> <span style="color: #66f;">list</span>    <span style="color: #66f;">( a-  )</span> <span style="color: #00ffff;">[</span> d-&gt;name puts space <span style="color: #00ffff;">]</span> <span style="color: #32cd32;">3</span> <span style="color: #66f;">( ^types'LIST )</span> <span style="color: #00ffff;">each@</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> others  <span style="color: #66f;">(  -  )</span> @dicts <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #ffd700; font-weight: bold;">0;</span> cr <span style="color: #00ffff;">dup</span> dicts <span style="color: #00ffff;">+</span> <span style="color: #66f;">list</span> <span style="color: #00ffff;">1-</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> words   <span style="color: #66f;">(  -  )</span> cr formatted <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">off</span> others cr last <span style="color: #66f;">list</span> <span style="color: #00ffff;">]</span> preserve <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( - ) List all names in dictionary"</span> :doc
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>

<p>
Display all names in the dictionary, and any active vocabuaries.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-6-26" class="outline-3">
<h3 id="sec-6-26"><span class="section-number-3">6.26</span> <span class="todo TODO">TODO</span> ( Keymap <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-26">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> dictionary.find/xt <span style="color: #66f;">( string:name - xt )</span>  <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #00ffff;">[</span> @d-&gt;xt <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> #0 <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>

  <span style="color: #c63; font-weight: bold;">:</span> prefix?
    <span style="color: #00ffff;">dup</span> <span style="color: #00ff00;">"keymap:PREFIX"</span> dictionary.find/xt <span style="color: #00ffff;">@</span> == <span style="color: #c63; font-weight: bold;">;</span>

  <span style="color: #c63; font-weight: bold;">:</span> seekHandler
    <span style="color: #00ffff;">dup</span> <span style="color: #00ff00;">"keymap:TABLE"</span>  dictionary.find/xt <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">@</span> <span style="color: #c63; font-weight: bold;">;</span>

  <span style="color: #00ffff;">[</span> prefix? <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> getc:unfiltered seekHandler <span style="color: #00ffff;">dup</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">&lt;&gt;</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">nip</span> <span style="color: #00ffff;">dip</span> cr <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">2drop</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #00ffff;">]</span> <span style="color: #c63; font-weight: bold;">is</span> keymap:handler
<span style="color: #c63; font-weight: bold;">}}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-27" class="outline-3">
<h3 id="sec-6-27"><span class="section-number-3">6.27</span> <span class="todo TODO">TODO</span> ( Misc. Words <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-27">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">save</span>     <span style="color: #66f;">(  -  )</span> <span style="color: #32cd32;">1</span> <span style="color: #32cd32;">4</span> out wait <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Save the image"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">bye</span>      <span style="color: #66f;">(  -  )</span> cr <span style="color: #32cd32;">-9</span> <span style="color: #32cd32;">5</span> out wait <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Exit Retro"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> getToken <span style="color: #66f;">( "-$ )</span> <span style="color: #32cd32;">32</span> <span style="color: #00ffff;">accept</span> <span style="color: #00ffff;">tib</span> <span style="color: #00ffff;">tempString</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``-$ ) Read a string, stopping at first whitespace"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> getNumber <span style="color: #66f;">( "-n )</span>  getToken toNumber <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``-n ) Read a number from the input stream"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> :include <span style="color: #66f;">( $-  )</span> <span style="color: #32cd32;">2</span> <span style="color: #32cd32;">4</span> out wait <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $- ) Include a file"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> include  <span style="color: #66f;">( "-  )</span> getToken :include <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) Same as **:include**, but parse for file name"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> time     <span style="color: #66f;">(  -n )</span> <span style="color: #32cd32;">-8</span> <span style="color: #32cd32;">5</span> out wait <span style="color: #32cd32;">5</span> in <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( -n ) Return the current unix time"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> delay    <span style="color: #66f;">( n-  )</span> time <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">dup</span> time <span style="color: #00ffff;">&gt;</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">while</span> <span style="color: #00ffff;">drop</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( n- ) Delay for (approximately) n seconds"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> getEnv   <span style="color: #66f;">( a$- )</span> <span style="color: #32cd32;">-10</span> <span style="color: #32cd32;">5</span> out wait <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( a$- ) Get a copy of environment variable $ in buffer"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> later    <span style="color: #66f;">(  -  )</span> 2pop <span style="color: #00ffff;">swap</span> 2push <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( - ) Defer execution of caller until a later time"</span> :doc

<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">:</span> xt,   <span style="color: #66f;">( - )</span> <span style="color: #32cd32;">1</span> <span style="color: #c63; font-weight: bold;">,</span> @last @d-&gt;xt <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> yield <span style="color: #66f;">( - )</span> <span style="color: #32cd32;">1</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #00ffff;">here</span> <span style="color: #32cd32;">5</span> <span style="color: #00ffff;">+</span> <span style="color: #c63; font-weight: bold;">,</span> xt, <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #c63; font-weight: bold;">:is</span> <span style="color: #32cd32;">9</span> <span style="color: #c63; font-weight: bold;">,</span> xt,  <span style="color: #c63; font-weight: bold;">`</span> <span style="color: #c63; font-weight: bold;">:devector</span> <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">compile-only</span>
  <span style="color: #00ff00;">"( - ) Return from a function, with execution resuming from point after **yield** when the  function is next called"</span> :doc
<span style="color: #c63; font-weight: bold;">}}</span>

<span style="color: #c63; font-weight: bold;">:</span> doc{     <span style="color: #66f;">( "-  )</span> <span style="color: #ffd700; font-weight: bold;">repeat</span> getToken "}doc" <span style="color: #00ffff;">compare</span> <span style="color: #ffd700; font-weight: bold;">if;</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) Parse tokens up to *}doc* and ignore.\n\nThis is intended as a means of embedding docs into libraries."</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">variables|</span>  <span style="color: #66f;">( "- )</span>
  <span style="color: #ffd700; font-weight: bold;">repeat</span> getToken <span style="color: #00ff00;">"|"</span> <span style="color: #00ffff;">compare</span> <span style="color: #ffd700; font-weight: bold;">if;</span> <span style="color: #00ffff;">tib</span> header <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">,</span> <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) Create a series of variables"</span> :doc
</pre>
</div>
</div>

<div id="outline-container-sec-6-27-1" class="outline-4">
<h4 id="sec-6-27-1"><span class="section-number-4">6.27.1</span> <span class="todo TODO">TODO</span> | Just about done&#x2026;</h4>
<div class="outline-text-4" id="text-6-27-1">
</div><ol class="org-ol"><li>: reset   ( &#x2026;-  ) depth repeat 0; 1- nip again ;<br/></li>

<li>: .s      (    -  )<br/><div class="outline-text-5" id="text-6-27-1-2">
<p>
depth [ "\n&lt;%d&gt; " puts ] sip 0;
heap  [ dup [ swap , ] times
            [ here 1- @ dup putn space -1 allot ] times ] preserve ;
</p>

<p>
Display the stack. I'd love a better way of doing this, but so far this seems to work ok.
</p>
</div>
</li>
<li>: save     (  -  ) 1 4 out wait ;<br/><div class="outline-text-5" id="text-6-27-1-3">
<p>
Save the image (if the VM supports it)
</p>
</div>
</li>
<li>: bye      (  -  ) cr -9 5 out wait ;<br/><div class="outline-text-5" id="text-6-27-1-4">
<p>
Shut down the VM
</p>
</div>
</li>
<li>getToken<br/></li>
<li>:  getToken ( "-$ ) 32 accept tib tempString ;<br/><div class="outline-text-5" id="text-6-27-1-6">
<p>
Read a whitespace delimited token, and add it to the temporary string buffer.
</p>
</div>
</li>
<li>include<br/></li>
<li>:  :include ( $-  ) 2 4 out wait ;<br/></li>
<li>:  include  ( "-  ) getToken :include ;<br/><div class="outline-text-5" id="text-6-27-1-9">
<p>
If you VM supports reading input from files, these will let you include files directly.
</p>
</div>
</li>
<li>: time     (  -n ) -8 5 out wait 5 in ;<br/><div class="outline-text-5" id="text-6-27-1-10">
<p>
Returns the current time (or a bogus value) as Unix epoch time.
</p>
</div>
</li>
<li>: delay    ( n-  ) time + [ dup time &gt; ] while drop ;<br/><div class="outline-text-5" id="text-6-27-1-11">
<p>
If your VM supports the time query, this will allow you to delay execution for approximately the number of seconds specified.
</p>
</div>
</li>
<li>: getEnv   ( a$- ) -10 5 out wait ;<br/><div class="outline-text-5" id="text-6-27-1-12">
<p>
If your VM supports access to the host environment, this will let you query it.
</p>
</div>
</li>
<li>later<br/></li>
<li>:  later    (  -  ) 2pop swap 2push ;<br/><div class="outline-text-5" id="text-6-27-1-14">
<p>
A fun thing. Defer execution until the caller returns. For instance,
</p>
</div>
</li>
<li>:  a 1 putn later 2 putn ;<br/></li>
<li>:  b 3 putn a 4 putn ;<br/><div class="outline-text-5" id="text-6-27-1-16">
<p>
b
</p>

<p>
With this, the core language is done. If you don't want/need the extra vocabularies, you can save and exit here, or continue on to define what you want.
</p>
</div>
</li>
<li>doc{<br/></li>

<li>:  doc{     ( "-  ) repeat getToken "}doc" compare if; again ;<br/><div class="outline-text-5" id="text-6-27-1-18">
<p>
This is used to allow embedding of documentation into the source files. An example of its usage:
</p>

<pre class="example">
doc{
| **foo**
| This function adds 471 to any variable passed to it.
}doc
:  foo 471 swap +! ;
</pre>

<p>
These bits of documenation can be extracted into a separate file later with little effort.
</p>
</div>
</li></ol>
</div>
</div>
<div id="outline-container-sec-6-28" class="outline-3">
<h3 id="sec-6-28"><span class="section-number-3">6.28</span> <span class="todo TODO">TODO</span> ( Internal Functions <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-6-28">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">global</span>
<span style="color: #c63; font-weight: bold;">chain:</span> <span style="color: #ff6347;">internals'</span>
  &amp;quote  <span style="color: #c63; font-weight: bold;">create</span> quote  @last !d-&gt;xt &amp;.word reclass
  <span style="color: #00ff00;">"( -a ) Helper function for quotations"</span> :doc

  &amp;string <span style="color: #c63; font-weight: bold;">create</span> string @last !d-&gt;xt &amp;.word reclass
  <span style="color: #00ff00;">"( -a ) Helper function for strings"</span> :doc
<span style="color: #c63; font-weight: bold;">;chain</span>
<span style="color: #00ff00;">"( - ) vocabulary containing functions used internally by Retro"</span> :doc

hide string
hide quote
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> <code>[0/10]</code> Appendix: Core Libraries</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> <span class="todo TODO">TODO</span> | Math Operations&#xa0;&#xa0;&#xa0;<span class="tag"><span class="math">math</span></span></h3>
<div class="outline-text-3" id="text-7-1">
<pre class="example">
pow  ( bp-n ) 1 swap [ over * ] times nip ;
abs  (  n-n ) dup 0 &lt; &amp;negate ifTrue ;
min  ( ab-c ) 2over &lt; &amp;drop &amp;nip  if ;
max  ( ab-c ) 2over &lt; &amp;nip  &amp;drop if ;
</pre>
<p>
{{
  2 elements w z
</p>
</div>
<div id="outline-container-sec-7-1-1" class="outline-4">
<h4 id="sec-7-1-1"><span class="section-number-4">7.1.1</span> :  seeds?   ( -  ) @w @z and ;</h4>
</div>
<div id="outline-container-sec-7-1-2" class="outline-4">
<h4 id="sec-7-1-2"><span class="section-number-4">7.1.2</span> :  seed     ( -  ) time [ 62903 and !w ] [ 78578 and !z ] bi ;</h4>
</div>
<div id="outline-container-sec-7-1-3" class="outline-4">
<h4 id="sec-7-1-3"><span class="section-number-4">7.1.3</span> :  ?seed    ( -  ) repeat seeds? 0 &lt;&gt; if; seed again ;</h4>
</div>
<div id="outline-container-sec-7-1-4" class="outline-4">
<h4 id="sec-7-1-4"><span class="section-number-4">7.1.4</span> :  (random) ( -x )</h4>
<div class="outline-text-4" id="text-7-1-4">
<p>
    36969 z @ 65535 and * @z 16 &gt;&gt; + !z
    18000 w @ 65535 and * @w 16 &gt;&gt; + !w
    @z 16 &lt;&lt; @w + ;
&#x2014;reveal&#x2014;
</p>
</div>
</div>

<div id="outline-container-sec-7-1-5" class="outline-4">
<h4 id="sec-7-1-5"><span class="section-number-4">7.1.5</span> :  random     (  -x ) ?seed (random) abs ;</h4>
<div class="outline-text-4" id="text-7-1-5">
<p>
}}
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> <span class="todo TODO">TODO</span> ( Generic Buffer <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">global</span>
<span style="color: #c63; font-weight: bold;">chain:</span> <span style="color: #ff6347;">buffer'</span>
<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">variables|</span> buffer ptr <span style="color: #c63; font-weight: bold;">|</span>
  <span style="color: #c63; font-weight: bold;">:</span> terminate <span style="color: #66f;">(  -  )</span> <span style="color: #32cd32;">0</span> @ptr <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> start     <span style="color: #66f;">(  -a )</span> @buffer  <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( -a ) Get starting address of buffer"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> end       <span style="color: #66f;">(  -a )</span> @ptr     <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( -a ) Address at end of buffer"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> add       <span style="color: #66f;">( c-  )</span> end <span style="color: #00ffff;">!</span> ptr <span style="color: #00ffff;">++</span> terminate <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( c- ) Add value to end of buffer"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> get       <span style="color: #66f;">(  -c )</span> ptr <span style="color: #00ffff;">--</span> end <span style="color: #00ffff;">@</span> terminate <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( -c ) Read and remove value from buffer"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> empty     <span style="color: #66f;">(  -  )</span> start !ptr   terminate <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( - ) Remove everything from the buffer"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> size      <span style="color: #66f;">(  -n )</span> end start <span style="color: #00ffff;">-</span>   <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( -n ) Number of values in buffer"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> set       <span style="color: #66f;">( a-  )</span> !buffer empty <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( a- ) Set buffer to memory address and empty it"</span> :doc
<span style="color: #c63; font-weight: bold;">}}</span>
<span style="color: #c63; font-weight: bold;">;chain</span>
<span style="color: #00ff00;">"( - ) vocabulary for dealing with LIFO buffers"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> <span class="todo TODO">TODO</span> | Generic Buffer</h3>
<div class="outline-text-3" id="text-7-3">
<p>
global
chain: buffer'
{{
  variable buffer
  variable ptr
</p>
</div>
<div id="outline-container-sec-7-3-1" class="outline-4">
<h4 id="sec-7-3-1"><span class="section-number-4">7.3.1</span> :  terminate (  -  ) 0 @ptr ! ;</h4>
<div class="outline-text-4" id="text-7-3-1">
<p>
&#x2014;reveal&#x2014;
</p>
</div>
</div>

<div id="outline-container-sec-7-3-2" class="outline-4">
<h4 id="sec-7-3-2"><span class="section-number-4">7.3.2</span> :  start     (  -a ) @buffer  ;</h4>
</div>
<div id="outline-container-sec-7-3-3" class="outline-4">
<h4 id="sec-7-3-3"><span class="section-number-4">7.3.3</span> :  end       (  -a ) @ptr     ;</h4>
</div>
<div id="outline-container-sec-7-3-4" class="outline-4">
<h4 id="sec-7-3-4"><span class="section-number-4">7.3.4</span> :  add       ( c-  ) end ! ptr ++ terminate ;</h4>
</div>
<div id="outline-container-sec-7-3-5" class="outline-4">
<h4 id="sec-7-3-5"><span class="section-number-4">7.3.5</span> :  get       (  -c ) ptr &#x2013; end @ terminate ;</h4>
</div>
<div id="outline-container-sec-7-3-6" class="outline-4">
<h4 id="sec-7-3-6"><span class="section-number-4">7.3.6</span> :  empty     (  -  ) start !ptr   terminate ;</h4>
</div>
<div id="outline-container-sec-7-3-7" class="outline-4">
<h4 id="sec-7-3-7"><span class="section-number-4">7.3.7</span> :  size      (  -n ) end start -   ;</h4>
</div>
<div id="outline-container-sec-7-3-8" class="outline-4">
<h4 id="sec-7-3-8"><span class="section-number-4">7.3.8</span> :  set       ( a-  ) !buffer empty ;</h4>
<div class="outline-text-4" id="text-7-3-8">
<p>
}}
;chain
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> <span class="todo TODO">TODO</span> ( Text Strings <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">with</span> <span style="color: #ff6347;">buffer'</span>
<span style="color: #c63; font-weight: bold;">chain:</span> <span style="color: #ff6347;">strings'</span>
<span style="color: #c63; font-weight: bold;">{{</span>
  <span style="color: #c63; font-weight: bold;">variables|</span> len needle haystack flag right left src <span style="color: #c63; font-weight: bold;">|</span>
  <span style="color: #c63; font-weight: bold;">:</span> buffer  <span style="color: #66f;">( -a )</span>
    @memory        STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( tib     )</span>
                   STRING-LENGTH   <span style="color: #00ffff;">-</span>  <span style="color: #66f;">( scratch )</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> trim   <span style="color: #66f;">( $-$ )</span>
    <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">1-</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">@</span> <span style="color: #32cd32;">32</span> == <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">1-</span> <span style="color: #00ffff;">--</span> trim <span style="color: #00ffff;">]</span> &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> place  <span style="color: #66f;">( $$n- )</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">copy</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">sip</span> <span style="color: #00ffff;">here</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> prep   <span style="color: #66f;">(  $$- )</span> <span style="color: #00ffff;">swap</span> !haystack <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">getLength</span> !len <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> !needle <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #32cd32;">0</span> !flag <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> move   <span style="color: #66f;">(    - )</span> @haystack <span style="color: #00ffff;">here</span> @len place haystack <span style="color: #00ffff;">++</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #c63; font-weight: bold;">:</span> cmp    <span style="color: #66f;">(    - )</span>
    @flag <span style="color: #32cd32;">0</span> != <span style="color: #ffd700; font-weight: bold;">if;</span> @needle <span style="color: #00ffff;">here</span> <span style="color: #00ffff;">compare</span> <span style="color: #00ffff;">[</span> @haystack <span style="color: #00ffff;">1-</span> !flag <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #c63; font-weight: bold;">---reveal---</span>
  <span style="color: #c63; font-weight: bold;">:</span> search   <span style="color: #66f;">( $$-f )</span>
    flag <span style="color: #00ffff;">off</span> prep @haystack <span style="color: #00ffff;">getLength</span> <span style="color: #00ffff;">[</span> move cmp <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> @flag <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $$-f ) Search for a string (2) within a string (1); return string starting with substring"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> findChar <span style="color: #66f;">( $c-a )</span>
    !needle
    <span style="color: #ffd700; font-weight: bold;">repeat</span> <span style="color: #00ffff;">@+</span>
      <span style="color: #00ffff;">dup</span> <span style="color: #32cd32;">0</span>   == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">2drop</span> <span style="color: #32cd32;">0</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">drop</span>
      @needle == <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">1-</span>      <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">-1</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #ffd700; font-weight: bold;">0;</span> <span style="color: #00ffff;">drop</span>
    <span style="color: #ffd700; font-weight: bold;">again</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $c-a ) Search for a character within a string; return string starting at the character"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> chop      <span style="color: #66f;">( $-$ )</span> <span style="color: #00ffff;">tempString</span> <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">1-</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $-$ ) Return a new string, with the last byte removed"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> getSubset <span style="color: #66f;">( $nn-$ )</span>
    buffer <span style="color: #32cd32;">0</span> STRING-LENGTH <span style="color: #00ffff;">fill</span>
    !right !left !src
    @src @left <span style="color: #00ffff;">+</span> @right buffer <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">copy</span> buffer <span style="color: #00ffff;">tempString</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $nn-$ ) Return a subset of ($) starting at (n1) with length of (n2)"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> trimLeft  <span style="color: #66f;">( $-$ )</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">@+</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">32</span> == <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> != <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #00ffff;">and</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">while</span> <span style="color: #00ffff;">1-</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $-$ ) Trim whitespace from left side of string"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> trimRight <span style="color: #66f;">( $-$ )</span>
    buffer <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">0</span> STRING-LENGTH <span style="color: #00ffff;">fill</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">getLength</span> <span style="color: #00ffff;">copy</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> trim <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">tri</span> <span style="color: #00ffff;">tempString</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $-$ ) Trim whitespace from right side of string"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> prepend <span style="color: #66f;">( $$-$ )</span>
    buffer <span style="color: #32cd32;">0</span> STRING-LENGTH <span style="color: #00ffff;">fill</span>
    <span style="color: #00ffff;">withLength</span> buffer <span style="color: #00ffff;">swap</span> &amp;copy <span style="color: #00ffff;">sip</span>
    &amp;withLength <span style="color: #00ffff;">dip</span> buffer <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">copy</span> buffer <span style="color: #00ffff;">tempString</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $$-$ ) Append first string to second"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> append <span style="color: #66f;">( $$-$ )</span> <span style="color: #00ffff;">swap</span> prepend <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $$-$ ) Append second string to first"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> appendChar <span style="color: #66f;">( $c-$ )</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">tempString</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">!+</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">sip</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $c-$ ) Append character to a string"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> toLower  <span style="color: #66f;">( $-$ )</span>
    <span style="color: #00ffff;">tempString</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">dup</span> 'A 'Z <span style="color: #00ffff;">within</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">32</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #32cd32;">2</span> <span style="color: #00ffff;">each@</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">sip</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $-$ ) Convert a string to all upper case"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> toUpper  <span style="color: #66f;">( $-$ )</span>
    <span style="color: #00ffff;">tempString</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">dup</span> 'a 'z <span style="color: #00ffff;">within</span> <span style="color: #00ffff;">[</span> <span style="color: #32cd32;">32</span> <span style="color: #00ffff;">-</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">ifTrue</span> <span style="color: #00ffff;">swap</span> <span style="color: #00ffff;">!</span> <span style="color: #00ffff;">]</span> <span style="color: #32cd32;">2</span> <span style="color: #00ffff;">each@</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">sip</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $-$ ) Convert a string to all upper case"</span> :doc
<span style="color: #c63; font-weight: bold;">}}</span>
  <span style="color: #c63; font-weight: bold;">:</span> reverse <span style="color: #66f;">( $-$ )</span>
    <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">tempString</span> set
    &amp;getLength <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">withLength</span> <span style="color: #00ffff;">+</span> <span style="color: #00ffff;">1-</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> <span style="color: #00ffff;">swap</span>
    <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">@</span> add <span style="color: #00ffff;">1-</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">times</span> <span style="color: #00ffff;">drop</span>
    start <span style="color: #00ffff;">tempString</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $-$ ) Reverse the characters in a string; returns a new string"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> split <span style="color: #66f;">( $n-$$ )</span>
    2over <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">swap</span> getSubset &amp;+ <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $n-$$ ) Split a string into two parts"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> splitAtChar <span style="color: #66f;">( $c-$$ )</span>
    2over <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">swap</span> findChar <span style="color: #00ffff;">over</span> <span style="color: #00ffff;">-</span> <span style="color: #00ffff;">1+</span> <span style="color: #32cd32;">0</span> <span style="color: #00ffff;">swap</span> getSubset <span style="color: #00ffff;">[</span> findChar <span style="color: #00ffff;">1+</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">dip</span> <span style="color: #c63; font-weight: bold;">;</span>
  <span style="color: #00ff00;">"( $c-$$ ) Search for a character and return two strings (up to and including (c), and after ($2))"</span> :doc

  <span style="color: #c63; font-weight: bold;">:</span> splitAtChar: <span style="color: #66f;">( $"-$$ )</span>
    @getToken <span style="color: #c63; font-weight: bold;">.data</span> <span style="color: #c63; font-weight: bold;">`</span> splitAtChar <span style="color: #c63; font-weight: bold;">;</span> <span style="color: #c63; font-weight: bold;">immediate</span>
  <span style="color: #00ff00;">"( $``-$$ ) Parse for a character and call **splitAtChar**"</span> :doc
<span style="color: #c63; font-weight: bold;">;chain</span>
<span style="color: #c63; font-weight: bold;">without</span>
<span style="color: #00ff00;">"( - ) vocabulary with functions for dealing with strings"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> <span class="todo TODO">TODO</span> | Text Strings</h3>
<div class="outline-text-3" id="text-7-5">
<p>
with| buffer' |
chain: strings'
{{
  7 elements len needle haystack flag right left src
</p>
</div>
<div id="outline-container-sec-7-5-1" class="outline-4">
<h4 id="sec-7-5-1"><span class="section-number-4">7.5.1</span> :  buffer (  -a ) here 8192 + ;</h4>
</div>
<div id="outline-container-sec-7-5-2" class="outline-4">
<h4 id="sec-7-5-2"><span class="section-number-4">7.5.2</span> :  trim   ( \(-\) )</h4>
<div class="outline-text-4" id="text-7-5-2">
<p>
dup withLength + 1- dup @ 32 =if 0 swap ! dup 1- &#x2013; trim ;; then drop ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-3" class="outline-4">
<h4 id="sec-7-5-3"><span class="section-number-4">7.5.3</span> :  place  ( $$n- ) [ copy 0 ] sip here + ! ;</h4>
</div>
<div id="outline-container-sec-7-5-4" class="outline-4">
<h4 id="sec-7-5-4"><span class="section-number-4">7.5.4</span> :  prep   (  $$- ) swap !haystack [ getLength !len ] [ !needle ] bi 0 !flag ;</h4>
</div>
<div id="outline-container-sec-7-5-5" class="outline-4">
<h4 id="sec-7-5-5"><span class="section-number-4">7.5.5</span> :  move   (    - ) @haystack here @len place haystack ++ ;</h4>
</div>
<div id="outline-container-sec-7-5-6" class="outline-4">
<h4 id="sec-7-5-6"><span class="section-number-4">7.5.6</span> :  cmp    (    - )</h4>
<div class="outline-text-4" id="text-7-5-6">
<p>
    @flag 0 &lt;&gt; if; @needle here compare [ @haystack 1- !flag ] ifTrue ;
&#x2014;reveal&#x2014;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-7" class="outline-4">
<h4 id="sec-7-5-7"><span class="section-number-4">7.5.7</span> :  search   ( $$-f )</h4>
<div class="outline-text-4" id="text-7-5-7">
<p>
flag off prep @haystack getLength [ move cmp ] times @flag ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-8" class="outline-4">
<h4 id="sec-7-5-8"><span class="section-number-4">7.5.8</span> :  findChar ( $c-a )</h4>
<div class="outline-text-4" id="text-7-5-8">
<p>
!needle
repeat @+
  dup 0   =if 2drop 0 ;; then
  @needle =if 1-      ;; then
again ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-9" class="outline-4">
<h4 id="sec-7-5-9"><span class="section-number-4">7.5.9</span> :  getSubset ( \(nn-\) )</h4>
<div class="outline-text-4" id="text-7-5-9">
<p>
buffer 0 1024 fill
!right !left !src
@src @left + @right buffer swap copy buffer ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-10" class="outline-4">
<h4 id="sec-7-5-10"><span class="section-number-4">7.5.10</span> :  trimLeft  ( \(-\) ) [ @+ [ 32 = ] [ 0 &lt;&gt; ] bi = ] while 1- ;</h4>
</div>
<div id="outline-container-sec-7-5-11" class="outline-4">
<h4 id="sec-7-5-11"><span class="section-number-4">7.5.11</span> :  trimRight ( \(-\) )</h4>
<div class="outline-text-4" id="text-7-5-11">
<p>
buffer [ 0 1024 fill ] [ over getLength copy ] [ trim ] tri ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-12" class="outline-4">
<h4 id="sec-7-5-12"><span class="section-number-4">7.5.12</span> :  prepend ( $$-$ )</h4>
<div class="outline-text-4" id="text-7-5-12">
<p>
buffer 0 1024 fill
withLength buffer swap dup &amp;copy dip
&amp;withLength dip buffer + swap copy buffer tempString ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-13" class="outline-4">
<h4 id="sec-7-5-13"><span class="section-number-4">7.5.13</span> :  append ( $$-$ ) swap prepend ;</h4>
</div>
<div id="outline-container-sec-7-5-14" class="outline-4">
<h4 id="sec-7-5-14"><span class="section-number-4">7.5.14</span> :  toLower ( \(-\) )</h4>
<div class="outline-text-4" id="text-7-5-14">
<p>
withLength 1+
[ buffer + [ @+ dup 'A 'Z within [ 'a + 'A - ] ifTrue ] dip ! ] iter
drop buffer tempString ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-15" class="outline-4">
<h4 id="sec-7-5-15"><span class="section-number-4">7.5.15</span> :  toUpper ( \(-\) )</h4>
<div class="outline-text-4" id="text-7-5-15">
<p>
    withLength 1+
    [ buffer + [ @+ dup 'a 'z within [ 'A + 'a - ] ifTrue ] dip ! ] iter
    drop buffer tempString ;
}}
</p>
</div>
</div>

<div id="outline-container-sec-7-5-16" class="outline-4">
<h4 id="sec-7-5-16"><span class="section-number-4">7.5.16</span> :  reverse ( \(-\) )</h4>
<div class="outline-text-4" id="text-7-5-16">
<p>
dup tempString set
[ getLength ] [ withLength + 1- ] bi swap
[ dup @ add 1- ] times drop
start ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-17" class="outline-4">
<h4 id="sec-7-5-17"><span class="section-number-4">7.5.17</span> :  split ( $n-$$ )</h4>
<div class="outline-text-4" id="text-7-5-17">
<p>
over over 0 swap getSubset [ + ] dip ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-18" class="outline-4">
<h4 id="sec-7-5-18"><span class="section-number-4">7.5.18</span> :  splitAtChar ( $c-$$ )</h4>
<div class="outline-text-4" id="text-7-5-18">
<p>
2over over swap findChar over - 1+ 0 swap getSubset [ findChar 1+ ] dip ;
</p>
</div>
</div>

<div id="outline-container-sec-7-5-19" class="outline-4">
<h4 id="sec-7-5-19"><span class="section-number-4">7.5.19</span> :  splitAtChar: ( $"-$$ )</h4>
<div class="outline-text-4" id="text-7-5-19">
<p>
    32 accept tib @ .data ` splitAtChar ; immediate
;chain
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6"><span class="section-number-3">7.6</span> <span class="todo TODO">TODO</span> ( Access Words Within Chains Directly <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-7-6">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">with</span> <span style="color: #ff6347;">strings'</span>
<span style="color: #c63; font-weight: bold;">:</span> __^  <span style="color: #66f;">( "- )</span>
  splitAtChar: <span style="color: #c63; font-weight: bold;">'</span> <span style="color: #c63; font-weight: bold;">find</span>
  <span style="color: #00ffff;">[</span> @d-&gt;xt findInChain <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">[</span> @d-&gt;xt <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> @d-&gt;class <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">bi</span> withClass <span style="color: #00ffff;">]</span> &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ffff;">]</span>
  &amp;drop <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span> parsing
<span style="color: #00ff00;">"( ``- ) Allow direct access to functions in a chain"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> :needs  <span style="color: #66f;">( $- )</span>
  <span style="color: #00ffff;">dup</span> <span style="color: #c63; font-weight: bold;">find</span> <span style="color: #00ffff;">nip</span>
  &amp;drop <span style="color: #00ffff;">[</span> <span style="color: #00ff00;">"library/"</span> prepend chop <span style="color: #00ff00;">".rx"</span> append :include <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( $- ) Load a vocabulary from the library if not already loaded"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> <span style="color: #c63; font-weight: bold;">needs</span>  <span style="color: #66f;">( "- )</span>
  getToken :needs <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) Load a vocabulary from the *library* if it is not already loaded (parsing)"</span> :doc

 <span style="color: #c63; font-weight: bold;">without</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-7" class="outline-3">
<h3 id="sec-7-7"><span class="section-number-3">7.7</span> <span class="todo TODO">TODO</span> | Access Words Within Chains Directly</h3>
<div class="outline-text-3" id="text-7-7">
<p>
with strings'
</p>
<pre class="example">
__^  ( "- )
</pre>
<p>
splitAtChar: ' find
[ @d-&gt;xt findInChain [ [ @d-&gt;xt ] [ @d-&gt;class ] bi do ] &amp;drop if ]
&amp;drop if ; parsing
</p>

<p>
{{
  variable old
</p>
</div>
<div id="outline-container-sec-7-7-1" class="outline-4">
<h4 id="sec-7-7-1"><span class="section-number-4">7.7.1</span> :  cut withLength over + 1- 0 swap ! ;</h4>
<div class="outline-text-4" id="text-7-7-1">
<p>
&#x2014;reveal&#x2014;
</p>
</div>
</div>

<div id="outline-container-sec-7-7-2" class="outline-4">
<h4 id="sec-7-7-2"><span class="section-number-4">7.7.2</span> :  needs ( "- )</h4>
<div class="outline-text-4" id="text-7-7-2">
<p>
    @last !old
    getToken dup find nip
    &amp;drop [ "library/" prepend cut ".rx" append :include ] if ;
}}
global
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7-8" class="outline-3">
<h3 id="sec-7-8"><span class="section-number-3">7.8</span> <span class="todo TODO">TODO</span> | Files&#xa0;&#xa0;&#xa0;<span class="tag"><span class="files">files</span></span></h3>
<div class="outline-text-3" id="text-7-8">
<p>
chain: files'
{{
  3 elements fid fsize active
</p>
</div>
<div id="outline-container-sec-7-8-1" class="outline-4">
<h4 id="sec-7-8-1"><span class="section-number-4">7.8.1</span> :  io     (  n-f )  4 out wait 4 in ;</h4>
</div>
<div id="outline-container-sec-7-8-2" class="outline-4">
<h4 id="sec-7-8-2"><span class="section-number-4">7.8.2</span> :  done   ( nn-  )  2drop active off ;</h4>
<div class="outline-text-4" id="text-7-8-2">
<p>
&#x2014;reveal&#x2014;
  0 constant :R
  1 constant :W
  2 constant :A
  3 constant :M
</p>
</div>
</div>

<div id="outline-container-sec-7-8-3" class="outline-4">
<h4 id="sec-7-8-3"><span class="section-number-4">7.8.3</span> :  open   (  $m-h ) -1 io ;</h4>
</div>
<div id="outline-container-sec-7-8-4" class="outline-4">
<h4 id="sec-7-8-4"><span class="section-number-4">7.8.4</span> :  read   (   h-f ) -2 io ;</h4>
</div>
<div id="outline-container-sec-7-8-5" class="outline-4">
<h4 id="sec-7-8-5"><span class="section-number-4">7.8.5</span> :  write  (  ch-f ) -3 io ;</h4>
</div>
<div id="outline-container-sec-7-8-6" class="outline-4">
<h4 id="sec-7-8-6"><span class="section-number-4">7.8.6</span> :  close  (   h-f ) -4 io ;</h4>
</div>
<div id="outline-container-sec-7-8-7" class="outline-4">
<h4 id="sec-7-8-7"><span class="section-number-4">7.8.7</span> :  pos    (   h-n ) -5 io ;</h4>
</div>
<div id="outline-container-sec-7-8-8" class="outline-4">
<h4 id="sec-7-8-8"><span class="section-number-4">7.8.8</span> :  seek   (  nh-f ) -6 io ;</h4>
</div>
<div id="outline-container-sec-7-8-9" class="outline-4">
<h4 id="sec-7-8-9"><span class="section-number-4">7.8.9</span> :  size   (   h-n ) -7 io ;</h4>
</div>
<div id="outline-container-sec-7-8-10" class="outline-4">
<h4 id="sec-7-8-10"><span class="section-number-4">7.8.10</span> :  delete (   $-n ) -8 io ;</h4>
</div>
<div id="outline-container-sec-7-8-11" class="outline-4">
<h4 id="sec-7-8-11"><span class="section-number-4">7.8.11</span> :  slurp  (  a$-n )</h4>
<div class="outline-text-4" id="text-7-8-11">
<p>
:R open !fid
@fid size !fsize
@fsize [ @fid read swap !+ ] times 0 swap !
@fid close drop @fsize ;
</p>
</div>
</div>

<div id="outline-container-sec-7-8-12" class="outline-4">
<h4 id="sec-7-8-12"><span class="section-number-4">7.8.12</span> :  spew   (  an$-n )</h4>
<div class="outline-text-4" id="text-7-8-12">
<p>
:W open !fid
@fid !fsize [ @+ @fid write drop fsize ++ ] times drop
@fid close drop @fsize ;
</p>
</div>
</div>

<div id="outline-container-sec-7-8-13" class="outline-4">
<h4 id="sec-7-8-13"><span class="section-number-4">7.8.13</span> :  readLine ( h-a )</h4>
<div class="outline-text-4" id="text-7-8-13">
<p>
tib repeat
  over read dup
  10 13 within 0 !if drop 0 !swap drop tib tempString ;; then !over 1+
again ;
</p>
</div>
</div>

<div id="outline-container-sec-7-8-14" class="outline-4">
<h4 id="sec-7-8-14"><span class="section-number-4">7.8.14</span> :  writeLine ( $h- )</h4>
<div class="outline-text-4" id="text-7-8-14">
<p>
    !fid active on
    [ @+ dup 0 = &amp;done [ @fid write drop ] if @active ] while ;
}}
;chain
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7-9" class="outline-3">
<h3 id="sec-7-9"><span class="section-number-3">7.9</span> <span class="todo TODO">TODO</span> ( types' <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-7-9">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">chain:</span> <span style="color: #ff6347;">types'</span>
  <span style="color: #32cd32;">0</span> <span style="color: #c63; font-weight: bold;">constant</span> ARRAY  <span style="color: #66f;">( -n )</span>
  <span style="color: #00ff00;">"( -n ) Type constant for arrays"</span> :doc

  <span style="color: #32cd32;">1</span> <span style="color: #c63; font-weight: bold;">constant</span> BUFFER <span style="color: #66f;">( -n )</span>
  <span style="color: #00ff00;">"( -n ) Type constant for buffers"</span> :doc

  <span style="color: #32cd32;">2</span> <span style="color: #c63; font-weight: bold;">constant</span> STRING <span style="color: #66f;">( -n )</span>
  <span style="color: #00ff00;">"( -n ) Type constant for strings"</span> :doc

  <span style="color: #32cd32;">3</span> <span style="color: #c63; font-weight: bold;">constant</span> LIST  <span style="color: #66f;">( -n )</span>
  <span style="color: #00ff00;">"( -n ) Type constant for linked lists"</span> :doc
<span style="color: #c63; font-weight: bold;">;chain</span>
<span style="color: #00ff00;">"( - ) vocabulary with constants for data types. Used with **each@**"</span> :doc

<span style="color: #c63; font-weight: bold;">:</span> describe
  <span style="color: #ff6347;">d'</span> <span style="color: #ffd700; font-weight: bold;">0;</span> cr
  <span style="color: #00ffff;">dup</span> d-&gt;class <span style="color: #00ffff;">@</span> xt-&gt;d <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">[</span> d-&gt;name <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ff00;">"unknown"</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> <span style="color: #00ff00;">"class: %s\n"</span> puts
      d-&gt;doc <span style="color: #00ffff;">@</span> <span style="color: #00ffff;">dup</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">]</span> <span style="color: #00ffff;">[</span> <span style="color: #00ffff;">drop</span> <span style="color: #00ff00;">"no documentation provided"</span> <span style="color: #00ffff;">]</span> <span style="color: #ffd700; font-weight: bold;">if</span> puts cr <span style="color: #c63; font-weight: bold;">;</span>
<span style="color: #00ff00;">"( ``- ) provide information about a function"</span> :doc
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-10" class="outline-3">
<h3 id="sec-7-10"><span class="section-number-3">7.10</span> <span class="todo TODO">TODO</span> | types'</h3>
<div class="outline-text-3" id="text-7-10">
<p>
chain: types'
  0 constant ARRAY  ( -n )
  1 constant BUFFER ( -n )
  2 constant STRING ( -n )
  3 constant LIST   ( -n )
;chain
</p>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Appendix: Cleanup, save, and power off</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> -</h3>
<div class="outline-text-3" id="text-8-1">
<p>
hide =if
hide !if
hide &gt;if
hide &lt;if
hide then
</p>

<p>
global .s save bye
</p>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> ( cleanup and save <code>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</code> )</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-retro"><span style="color: #c63; font-weight: bold;">global</span> .s <span style="color: #c63; font-weight: bold;">save</span> <span style="color: #c63; font-weight: bold;">bye</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> END</h2>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> tasklist</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> <span class="todo TODO">TODO</span> make <code>okmsg</code> assignable, in case you just want to change the string.</h3>
<div class="outline-text-3" id="text-10-1">
</div><div id="outline-container-sec-10-1-1" class="outline-4">
<h4 id="sec-10-1-1"><span class="section-number-4">10.1.1</span> perhaps this means using strings with known lengths</h4>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><a id="ydld85c0f0g0" name="ydld85c0f0g0"></a><span class="section-number-2">11</span> NOTE . the new w: scheme for building the dictionaries</h2>
<div class="outline-text-2" id="text-11">
<p>
<a href="http://forthworks.com/dev/corpse/article/204">http://forthworks.com/dev/corpse/article/204</a>
</p>
</div>
</div>
</div>
</body>
</html>
