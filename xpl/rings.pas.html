<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>rings</title>
<!-- 2013-10-19 Sat 04:33 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="michal wallace" />
<link rel="stylesheet" type="text/css" href="/etc/style.css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">rings</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. About the implementation</a></li>
<li><a href="#sec-3">3. Types of Node</a>
<ul>
<li><a href="#sec-3-1">3.1. <code>GNode&lt;T&gt;</code> is just an abstract ring member.</a></li>
<li><a href="#sec-3-2">3.2. <code>GCellNode&lt;T&gt;</code> contains a value.</a></li>
<li><a href="#sec-3-3">3.3. <code>GClaspNode&lt;T&gt;</code> serves as a sentinel value in the ring.</a></li>
</ul>
</li>
<li><a href="#sec-4">4. <code>IRingCursor&lt;T&gt;</code> interface for ring cursors</a></li>
<li><a href="#sec-5">5. <code>GRing&lt;T&gt;.TCursor</code> walks the structure</a></li>
<li><a href="#sec-6">6. <code>GRing&lt;T&gt;</code> the main ring type</a></li>
<li><a href="#sec-7">7. <code>GElement&lt;T&gt;</code> a ring with a tag and attributes (like an Element in xml)</a></li>
<li><a href="#sec-8">8. implementation</a>
<ul>
<li><a href="#sec-8-1">8.1. <code>GNode&lt;T&gt;</code></a></li>
<li><a href="#sec-8-2">8.2. <code>GCellNode&lt;T&gt;</code></a></li>
<li><a href="#sec-8-3">8.3. <code>GClaspNode&lt;T&gt;</code></a></li>
<li><a href="#sec-8-4">8.4. <code>GRing&lt;T&gt;.TCursor</code></a>
<ul>
<li><a href="#sec-8-4-1">8.4.1. NextCell and PrevCell navigate the tree.</a></li>
<li><a href="#sec-8-4-2">8.4.2. jump to top (hub)</a></li>
<li><a href="#sec-8-4-3">8.4.3. values</a></li>
<li><a href="#sec-8-4-4">8.4.4. Injecting new nodes into the tree.</a></li>
<li><a href="#sec-8-4-5">8.4.5. Deleting old nodes</a></li>
</ul>
</li>
<li><a href="#sec-8-5">8.5. <code>GRing&lt;T&gt;</code></a>
<ul>
<li><a href="#sec-8-5-1">8.5.1. Constructor, accessors</a></li>
<li><a href="#sec-8-5-2">8.5.2. Length, Find, ForEach</a></li>
<li><a href="#sec-8-5-3">8.5.3. Insert / Append (nodes)</a></li>
<li><a href="#sec-8-5-4">8.5.4. Insert / Append (values)</a></li>
</ul>
</li>
<li><a href="#sec-8-6">8.6. <code>GElement&lt;T&gt;</code></a>
<ul>
<li><a href="#sec-8-6-1">8.6.1. constructor</a></li>
<li><a href="#sec-8-6-2">8.6.2. tag accesors</a></li>
<li><a href="#sec-8-6-3">8.6.3. attribute accessors</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-9">9. OUTPUT <code>rings.pas</code></a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> <span class="todo TODO">TODO</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
The <code>rings</code> module implements an unusual nested ring structure. As far as I know, it isn't well known in computer science, and may not even have a name, although it is a specific instance of a <i>strange loop</i>. I tend to call it a <i>chandelier</i> or <i>ring tree</i> when describing its shape, or a <i>jumptree</i> when describing its function.
</p>

<p>
Strictly speaking, a jumptree is a cyclic graph and therefore is not actually a tree, but it is a well-behaved graph that can be used like a tree.
</p>

<p>
Its topology is described by the following rules:
</p>

<ul class="org-ul">
<li>the root of the tree is replaced with a <b>hub</b>, which is like the root of a tree in every way <i>except</i> that it has a special parent node called a <b>mirror node</b>, (which we will get to in  moment).
</li>
<li>each node forms a circular doubly-linked list (or <b>ring</b>) with its siblings
</li>
<li>each ring has exactly one <b>clasp node</b>, which serves as a sentinel value when looping.
</li>
<li>it follows from the above four rules that the hub forms a ring with itself and therefore must be a clasp.
</li>
<li>every leaf in the tree has a unique mirror node for its child
</li>
<li>every mirror node has a unique leaf node for a parent
</li>
<li>leaf nodes and mirror nodes share a one-to-one relationship.
</li>
<li>mirror nodes are arranged in a special ring called the <b>rim</b>.
</li>
<li>all siblings share the same parent, <i>except</i> for mirror nodes.
</li>
<li>the child of each mirror nodes is the hub.
</li>
<li>the child node of a clasp may be any non-mirror node.
</li>
<li>by default, the child of a clasp is the clasp itself
</li>
</ul>

<p>
There are some interesting implications to these rules:
</p>

<ul class="org-ul">
<li>It is possible to reach a parent node by moving <i>downward</i> through the tree until you reach the rim, then passing "through the mirror" to the hub, and walking back down to the parent node.
</li>
<li>Each node is connected to exactly four edges
</li>
<li>There are no null pointers involved.
</li>
</ul>

<p>
The jumptree is well suited for situations where you need to need to traverse a tree in arbitrary directions.
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> About the implementation</h2>
<div class="outline-text-2" id="text-2">
<p>
Since all siblings share a parent, only clasp nodes actually need a parent pointer. You can find the parent of any node simply by walking the ring of siblings until you reach the clasp.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Types of Node</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> <code>GNode&lt;T&gt;</code> is just an abstract ring member.</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">

<pre class="src src-pascal" id="GNode"><span style="color: #66f;">{ </span><span style="color: #66f;">GNode : link class with .nextLink, .prevLink </span><span style="color: #66f;">}</span>
<span style="color: #ff00ff;">type</span> GNode&lt;T&gt; = <span style="color: #ff00ff;">class</span>
  <span style="color: #00ffff;">public</span>
    nextLink, prevLink : GNode&lt;T&gt;;
    <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Length</span> : cardinal; <span style="color: #00ffff;">virtual</span>;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> <code>GCellNode&lt;T&gt;</code> contains a value.</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-pascal" id="GCellNode"><span style="color: #ff00ff;">type</span> GCellNode&lt;T&gt; = <span style="color: #ff00ff;">class</span>( GNode&lt;T&gt; )
  <span style="color: #00ffff;">protected</span>
    _val : t;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">_set</span>( v : T );
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">_get</span> : T;
  <span style="color: #00ffff;">public</span>
    <span style="color: #00ffff;">property</span> value : T <span style="color: #00ffff;">read</span> _get <span style="color: #00ffff;">write</span> _set;
    <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>( v : T );
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Length</span> : cardinal; <span style="color: #00ffff;">override</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">IsClasp</span> : <span style="color: #ff00ff;">boolean</span>; <span style="color: #00ffff;">virtual</span>;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> <code>GClaspNode&lt;T&gt;</code> serves as a sentinel value in the ring.</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">

<pre class="src src-pascal" id="GClaspNode"><span style="color: #66f;">{ </span><span style="color: #66f;">list.TClaspNode : a special node that joins the ends of the list </span><span style="color: #66f;">}</span>
<span style="color: #66f;">{ </span><span style="color: #66f;">It's only a cell node because that made the implementation of</span>
<span style="color: #66f;">  the cursor simpler. Probably there's a better design involving</span>
<span style="color: #66f;">  nterfaces, though. </span><span style="color: #66f;">}</span>
<span style="color: #66f;">// </span><span style="color: #66f;">&#7; TODO : refactor the node class hierarchy</span>
<span style="color: #ff00ff;">type</span> GClaspNode&lt;T&gt; = <span style="color: #ff00ff;">class</span>( GCellNode&lt;T&gt; )
  <span style="color: #00ffff;">public</span>
    parent : GNode&lt;T&gt;;
    <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Length</span> : cardinal; <span style="color: #00ffff;">override</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">IsClasp</span> : <span style="color: #ff00ff;">boolean</span>; <span style="color: #00ffff;">override</span>;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> <code>IRingCursor&lt;T&gt;</code> interface for ring cursors</h2>
<div class="outline-text-2" id="text-4">
<p>
This is partially to break circular dependencies, and also partially because cursors are fairly disposable and using the interface allows them to be refcounted and automatically garbage collected.
</p>

<div class="org-src-container">

<pre class="src src-pascal" id="IRingCursor"><span style="color: #ff00ff;">type</span> IRingCursor&lt;T&gt; = <span style="color: #00ffff;">interface</span>
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Reset</span>;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">ToTop</span>;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">ToEnd</span>;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">AtTop</span> : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">AtEnd</span> : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">AtClasp</span> : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">MoveTo</span>( other : IRingCursor&lt;T&gt; ); overload;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">MoveTo</span>( position : cardinal ); overload;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Next</span>( out t : T ) : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Prev</span>( out t : T ) : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">InjectPrev</span>( <span style="color: #ff00ff;">const</span> val : T );
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">InjectNext</span>( <span style="color: #ff00ff;">const</span> val : T );
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">DeleteNext</span>;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetValue</span> : T;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">SetValue</span>( v : T );
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetIndex</span> : cardinal;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">MoveNext</span> : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">MovePrev</span> : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">property</span> value : T <span style="color: #00ffff;">read</span> GetValue <span style="color: #00ffff;">write</span> SetValue;
  <span style="color: #00ffff;">property</span> <span style="color: #00ffff;">index</span> : cardinal <span style="color: #00ffff;">read</span> GetIndex;
  <span style="color: #00ffff;">property</span> current  : T <span style="color: #00ffff;">read</span> GetValue;
<span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> <code>GRing&lt;T&gt;.TCursor</code> walks the structure</h2>
<div class="outline-text-2" id="text-5">
<p>
As an alternative to looking up the parent nodes, if you started at the hub and are walking downward, you can simply maintain a stack of parent nodes. This module provides a <code>GRing&lt;T&gt;.TCursor</code> for maintaining such a stack.
</p>

<div class="org-src-container">

<pre class="src src-pascal" id="GCursor"><span style="color: #66f;">{ </span><span style="color: #66f;">tracks a position in the list, even through Inserts/deletes </span><span style="color: #66f;">}</span>
<span style="color: #ff00ff;">type</span> TCursor = <span style="color: #ff00ff;">class</span> (TInterfacedObject, IRingCursor&lt;T&gt;)
  <span style="color: #00ffff;">private</span> <span style="color: #ff00ff;">type</span>
    GNodeT     = GNode&lt;T&gt;;
    GNodeStack = GStack&lt;GNodeT&gt;;
  <span style="color: #00ffff;">protected</span>
    _ring  : GRing&lt;T&gt;; <span style="color: #66f;">// </span><span style="color: #66f;">the main list</span>
    _cell  : GCellNode&lt;T&gt;;
    _idx  : cardinal;
    _path : GNodeStack;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">NextCell</span> : GCellNode&lt;T&gt;; <span style="color: #00ffff;">virtual</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">PrevCell</span> : GCellNode&lt;T&gt;; <span style="color: #00ffff;">virtual</span>;
  <span style="color: #00ffff;">public</span>
    <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>( lis : GRing&lt;T&gt; );
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Reset</span>;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">ToTop</span>;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">ToEnd</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">AtTop</span> : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">AtEnd</span> : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">AtClasp</span> : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">MoveTo</span>( other : IRingCursor&lt;T&gt; ); overload;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">MoveTo</span>( position : cardinal ); overload;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Next</span>( out t : T ) : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Prev</span>( out t : T ) : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">InjectPrev</span>( <span style="color: #ff00ff;">const</span> val : T );
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">InjectNext</span>( <span style="color: #ff00ff;">const</span> val : T );
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">DeleteNext</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetValue</span> : T;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">SetValue</span>( v : T );
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetIndex</span> : cardinal;
    <span style="color: #00ffff;">property</span> value : T <span style="color: #00ffff;">read</span> GetValue <span style="color: #00ffff;">write</span> SetValue;
    <span style="color: #00ffff;">property</span> <span style="color: #00ffff;">index</span> : cardinal <span style="color: #00ffff;">read</span> GetIndex;
  <span style="color: #00ffff;">public</span>  <span style="color: #66f;">{ </span><span style="color: #66f;">for..in loop interface </span><span style="color: #66f;">}</span>
    <span style="color: #00ffff;">property</span> current  : T <span style="color: #00ffff;">read</span> GetValue;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">MoveNext</span> : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">MovePrev</span> : <span style="color: #ff00ff;">boolean</span>; <span style="color: #66f;">// </span><span style="color: #66f;">not part of for..in</span>
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> <code>GRing&lt;T&gt;</code> the main ring type</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-pascal" id="GRing"><span style="color: #ff00ff;">type</span> GRing&lt;T&gt; = <span style="color: #ff00ff;">class</span>(GNode&lt;T&gt;)
  <span style="color: #00ffff;">private</span> <span style="color: #ff00ff;">type</span>
    GNodeT         = GNode&lt;T&gt;;
    GNodeStack     = GStack&lt;GNodeT&gt;;
  <span style="color: #00ffff;">public</span> <span style="color: #ff00ff;">type</span> <span style="color: #66f;">{ </span><span style="color: #66f;">procedure types used by foreach, find </span><span style="color: #66f;">}</span>
    GNodeAction = procedure( <span style="color: #ff00ff;">var</span> n : T ) <span style="color: #00ffff;">is</span> nested;
    GNodePredicate = function( n : T ) : <span style="color: #ff00ff;">Boolean</span> <span style="color: #00ffff;">is</span> nested;
    <span style="color: #66f;">//</span><span style="color: #66f;">///////////////////////////////////////////////////////////</span>
    <span style="color: #66f;">// </span><span style="color: #66f;">!! i don't see any way to move gcursor out of GRing yet :/</span>
    &lt;&lt;GCursor&gt;&gt;
    <span style="color: #66f;">//</span><span style="color: #66f;">///////////////////////////////////////////////////////////</span>
  <span style="color: #00ffff;">protected</span>
    _clasp : GClaspNode&lt;T&gt;; <span style="color: #66f;">// </span><span style="color: #66f;">holds the two ends together</span>
    _count : cardinal;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FindNext</span>( <span style="color: #ff00ff;">const</span> start : GCellNode&lt;T&gt;;
                       <span style="color: #ff00ff;">var</span> p : GNodeStack;
                       out v : GCellNode&lt;T&gt; ) : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FindPrev</span>( <span style="color: #ff00ff;">const</span> start : GCellNode&lt;T&gt;;
                       <span style="color: #ff00ff;">var</span> p : GNodeStack;
                       out v : GCellNode&lt;T&gt; ) : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FirstCell</span>: GCellNode&lt;T&gt;;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">LastCell</span>: GCellNode&lt;T&gt;;
  <span style="color: #00ffff;">public</span>
    <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>;
  <span style="color: #00ffff;">public</span> <span style="color: #66f;">{ </span><span style="color: #66f;">interface for adding nodes </span><span style="color: #66f;">}</span>
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Append</span>( n : GNode&lt;T&gt; ); overload;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Insert</span>( n : GNode&lt;T&gt; ); overload;
    <span style="color: #66f;">// </span><span style="color: #66f;">&#7;TODO: procedure InsertAt( i : cardinal; val : GNode&lt;T&gt; ); overload;</span>
  <span style="color: #00ffff;">public</span> <span style="color: #66f;">{ </span><span style="color: #66f;">interface for adding / removing values </span><span style="color: #66f;">}</span>
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Append</span>( val : T ); overload;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Insert</span>( val : T ); overload;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">InsertAt</span>( i : cardinal; val : T );
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">DeleteAt</span>( i : cardinal );
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Remove</span>( val : T );
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">Drop</span>;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">ForEach</span>( action : GNodeAction );
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Find</span>( pred : GNodePredicate ) : T;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">IsEmpty</span>: <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">First</span> : T;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Last</span> : T;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Length</span> : cardinal; <span style="color: #00ffff;">override</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">MakeCursor</span> : IRingCursor&lt;T&gt;;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetItem</span>(position: cardinal) : T;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">SetItem</span>(position: cardinal; val : T);
    <span style="color: #00ffff;">property</span> items[at:cardinal] : T
      <span style="color: #00ffff;">read</span> GetItem <span style="color: #00ffff;">write</span> SetItem; <span style="color: #00ffff;">default</span>;

  <span style="color: #66f;">{ </span><span style="color: #66f;">-- interface for for..in loops -- </span><span style="color: #66f;">}</span>
  <span style="color: #00ffff;">public</span>
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetEnumerator</span> : IRingCursor&lt;T&gt;;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> <code>GElement&lt;T&gt;</code> a ring with a tag and attributes (like an Element in xml)</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-pascal" id="GElement"><span style="color: #66f;">// </span><span style="color: #66f;">!! The meta-data might not be the same type as the</span>
<span style="color: #66f;">// </span><span style="color: #66f;">actual data. (For example, you may want to represent</span>
<span style="color: #66f;">// </span><span style="color: #66f;">a mapping of keys of one type to data of another).</span>
<span style="color: #66f;">//</span>
<span style="color: #66f;">// </span><span style="color: #66f;">It may make sense to use a second type parameter here,</span>
<span style="color: #66f;">// </span><span style="color: #66f;">but for now, I'm just going to use variants.</span>
<span style="color: #ff00ff;">type</span>
   GElement&lt;T&gt; = <span style="color: #ff00ff;">class</span>( GRing&lt;T&gt; )
     <span style="color: #00ffff;">protected</span>
       _tag  : variant;
       _attr : TVarDict;
     <span style="color: #00ffff;">public</span>
       <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>; overload;
       <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>( aTag : variant ); overload;
       <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">SetTag</span>( val: variant );
       <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetTag</span> : variant;
       <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">SetAttr</span>( key : <span style="color: #ff00ff;">string</span>; val: variant );
       <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetAttr</span>( key : <span style="color: #ff00ff;">string</span> ) : variant;
       <span style="color: #00ffff;">property</span> Attrs[ key : <span style="color: #ff00ff;">string</span> ] : variant
         <span style="color: #00ffff;">read</span> GetAttr <span style="color: #00ffff;">write</span> SetAttr; <span style="color: #00ffff;">default</span>; <span style="color: #66f;">// </span><span style="color: #66f;">use .items for values</span>
       <span style="color: #00ffff;">property</span> tag : variant
         <span style="color: #00ffff;">read</span> GetTag <span style="color: #00ffff;">write</span> SetTag;
   <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> implementation</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> <code>GNode&lt;T&gt;</code></h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">

<pre class="src src-pascal" id="GNode.methods"><span style="color: #66f;">{ </span><span style="color: #66f;">-- link ( internal type ) -- </span><span style="color: #66f;">}</span>

<span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">GNode</span>&lt;T&gt;.Create;
<span style="color: #00ffff;">begin</span>
  self.NextLink := nil;
  self.PrevLink := nil;
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GNode</span>&lt;T&gt;.Length : cardinal;
<span style="color: #00ffff;">begin</span>
  result := 0;
<span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> <code>GCellNode&lt;T&gt;</code></h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-pascal" id="GCellNode.methods"><span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">GCellNode</span>&lt;T&gt;.Create( v : T );
  <span style="color: #00ffff;">begin</span>
  <span style="color: #00ffff;">inherited</span> Create;
  self.value := v;
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GCellNode</span>&lt;T&gt;._set( v : T );
<span style="color: #00ffff;">begin</span> self._val := v;
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GCellNode</span>&lt;T&gt;._get : T;
<span style="color: #00ffff;">begin</span> result := self._val;
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GCellNode</span>&lt;T&gt;.IsClasp : <span style="color: #ff00ff;">boolean</span>;
<span style="color: #00ffff;">begin</span>
  result := false;
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GCellNode</span>&lt;T&gt;.Length : cardinal;
<span style="color: #00ffff;">begin</span>
  result := 1;
<span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> <code>GClaspNode&lt;T&gt;</code></h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">

<pre class="src src-pascal" id="GClaspNode.methods"><span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">GClaspNode</span>&lt;T&gt;.Create;
  <span style="color: #00ffff;">begin</span>
    self.NextLink := self;
    self.PrevLink := self;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GClaspNode</span>&lt;T&gt;.IsClasp : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    result := true;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GClaspNode</span>&lt;T&gt;.Length : cardinal;
  <span style="color: #00ffff;">begin</span>
    result := 0;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><span class="section-number-3">8.4</span> <code>GRing&lt;T&gt;.TCursor</code></h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">

<pre class="src src-pascal" id="GCursor.methods"><span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.Create( lis : GRing&lt;T&gt; );
  <span style="color: #00ffff;">begin</span>
    _ring := lis;
    <span style="color: #66f;">// </span><span style="color: #66f;">&#7; todo: use a dynamically resizable stack</span>
    _path := GNodeStack.Create( kMaxDepth );
    self.Reset;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.Reset;
  <span style="color: #00ffff;">begin</span>
    _cell := _ring._clasp;
    _idx := 0;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>

<div id="outline-container-sec-8-4-1" class="outline-4">
<h4 id="sec-8-4-1"><span class="section-number-4">8.4.1</span> NextCell and PrevCell navigate the tree.</h4>
<div class="outline-text-4" id="text-8-4-1">
<p>
The default implementation does a depth-first walk.
</p>
<div class="org-src-container">

<pre class="src src-pascal" id="GCursor.methods"><span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.NextCell : GCellNode&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    _ring.FindNext( _cell, _path, result )
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.PrevCell : GCellNode&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    _ring.FindPrev( _cell, _path, result )
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.MoveNext : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> _ring.IsEmpty <span style="color: #00ffff;">then</span> result := false
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">begin</span>
      _cell := self.NextCell;
      inc( _idx );
      result := ( _cell &lt;&gt; _ring._clasp );
    <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.Next( out t : T ) : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    result := self.MoveNext;
    <span style="color: #00ffff;">if</span> result <span style="color: #00ffff;">then</span> t := _cell.value;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.MovePrev : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> _ring.IsEmpty <span style="color: #00ffff;">then</span> result := false
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">begin</span>
      _cell := self.PrevCell;
      <span style="color: #00ffff;">if</span> _idx = 0 <span style="color: #00ffff;">then</span> _idx := _ring.Length <span style="color: #00ffff;">else</span> dec( _idx );
      result := ( _cell &lt;&gt; _ring._clasp );
    <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.Prev( out t : T ) : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    result := self.MovePrev;
    <span style="color: #00ffff;">if</span> result <span style="color: #00ffff;">then</span> t := _cell.value;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-4-2" class="outline-4">
<h4 id="sec-8-4-2"><span class="section-number-4">8.4.2</span> jump to top (hub)</h4>
<div class="outline-text-4" id="text-8-4-2">
<div class="org-src-container">

<pre class="src src-pascal" id="GCursor.methods"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.ToTop;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> _ring.IsEmpty <span style="color: #00ffff;">then</span> <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'no top item to go to'</span>)
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">begin</span>
      self.Reset;
      self.MoveNext
    <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>;

  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.ToEnd;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> _ring.IsEmpty <span style="color: #00ffff;">then</span> <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'no end item to go to'</span>)
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">begin</span>
      self.Reset;
      self.MovePrev
    <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>;

  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.AtTop : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    result := (self.PrevCell = _ring._clasp) <span style="color: #00ffff;">and</span> <span style="color: #00ffff;">not</span> _ring.IsEmpty;
  <span style="color: #00ffff;">end</span>;

  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.AtEnd : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    result := (self.NextCell = _ring._clasp) <span style="color: #00ffff;">and</span> <span style="color: #00ffff;">not</span> _ring.IsEmpty;
  <span style="color: #00ffff;">end</span>;

  <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.AtClasp : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span>
    result := (self._cell = _ring._clasp);
  <span style="color: #00ffff;">end</span>;

  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.MoveTo( other : IRingCursor&lt;T&gt; );
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">with</span> other <span style="color: #00ffff;">as</span> GRing&lt;T&gt;.TCursor <span style="color: #00ffff;">do</span>
      <span style="color: #00ffff;">begin</span>
        self._cell := _cell;
        self._idx  := _idx;
        self._ring := _ring;
      <span style="color: #00ffff;">end</span>;
  <span style="color: #00ffff;">end</span>;

  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.MoveTo( position : cardinal );
  <span style="color: #ff00ff;">var</span> i : cardinal;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> position &lt; _ring.length <span style="color: #00ffff;">then</span>
      <span style="color: #00ffff;">begin</span>
        self.ToTop;
        <span style="color: #00ffff;">if</span> position &gt; 0 <span style="color: #00ffff;">then</span>
          <span style="color: #00ffff;">for</span> i := 1 <span style="color: #00ffff;">to</span> position <span style="color: #00ffff;">do</span> self.MoveNext
      <span style="color: #00ffff;">end</span>
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'out of bounds: '</span>
                                + IntToStr(position))
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-4-3" class="outline-4">
<h4 id="sec-8-4-3"><span class="section-number-4">8.4.3</span> values</h4>
<div class="outline-text-4" id="text-8-4-3">
<p>
Values are stored in cell nodes.
</p>

<div class="org-src-container">

<pre class="src src-pascal" id="GCursor.methods"><span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.GetValue : t;
<span style="color: #00ffff;">begin</span>
  <span style="color: #00ffff;">if</span> _cell = _ring._clasp <span style="color: #00ffff;">then</span>
    <span style="color: #00ffff;">raise</span> Exception.Create(
            <span style="color: #00ff00;">'can''t get value at the clasp. move the cursor.'</span> )
  <span style="color: #00ffff;">else</span> result := _cell.value
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.SetValue( v : T );
<span style="color: #00ffff;">begin</span>
  <span style="color: #00ffff;">if</span> _cell = _ring._clasp <span style="color: #00ffff;">then</span>
    <span style="color: #00ffff;">raise</span> Exception.Create(
            <span style="color: #00ff00;">'can''t set value at the clasp. move the cursor.'</span> )
  <span style="color: #00ffff;">else</span> _cell.value := v
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.GetIndex : cardinal;
<span style="color: #00ffff;">begin</span>
  result := _idx;
<span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-4-4" class="outline-4">
<h4 id="sec-8-4-4"><span class="section-number-4">8.4.4</span> Injecting new nodes into the tree.</h4>
<div class="outline-text-4" id="text-8-4-4">
<div class="org-src-container">

<pre class="src src-pascal" id="GCursor.methods"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.InjectPrev( <span style="color: #ff00ff;">const</span> val : T );
  <span style="color: #ff00ff;">var</span> ln : GNode&lt;T&gt;;
<span style="color: #00ffff;">begin</span>
  inc( self._ring._count );
  inc( self._idx );
  ln := GCellNode&lt;T&gt;.Create( val );
  ln.NextLink := self._cell;
  ln.PrevLink := self._cell.PrevLink;
  self._cell.PrevLink.NextLink := ln;
  self._cell.PrevLink := ln;
<span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.InjectNext( <span style="color: #ff00ff;">const</span> val : T );
  <span style="color: #ff00ff;">var</span> ln : GNode&lt;T&gt;;
<span style="color: #00ffff;">begin</span>
  <span style="color: #66f;">// </span><span style="color: #66f;">we don't increase the index here because we're injecting *after*</span>
  inc( self._ring._count );
  ln := GCellNode&lt;T&gt;.Create( val );
  ln.PrevLink := self._cell;
  ln.NextLink := self._cell.NextLink;
  self._cell.NextLink.PrevLink := ln;
  self._cell.NextLink := ln;
<span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-4-5" class="outline-4">
<h4 id="sec-8-4-5"><span class="section-number-4">8.4.5</span> Deleting old nodes</h4>
<div class="outline-text-4" id="text-8-4-5">
<div class="org-src-container">

<pre class="src src-pascal" id="GCursor.methods"><span style="color: #66f;">// </span><span style="color: #66f;">&#7; this is probably leaking memory. how to deal with pointers?</span>
<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.TCursor.DeleteNext;
  <span style="color: #ff00ff;">var</span> temp : GNode&lt;T&gt;;
<span style="color: #00ffff;">begin</span>
  temp := self._cell.NextLink;
  <span style="color: #00ffff;">if</span> temp &lt;&gt; self._ring._clasp <span style="color: #00ffff;">then</span>
  <span style="color: #00ffff;">begin</span>
    self._cell.NextLink := temp.NextLink;
    self._cell.NextLink.PrevLink := self._cell;
    temp.NextLink := nil;
    temp.PrevLink := nil;
    <span style="color: #66f;">// </span><span style="color: #66f;">todo: temp.free</span>
  <span style="color: #00ffff;">end</span>
<span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5"><span class="section-number-3">8.5</span> <code>GRing&lt;T&gt;</code></h3>
<div class="outline-text-3" id="text-8-5">
</div><div id="outline-container-sec-8-5-1" class="outline-4">
<h4 id="sec-8-5-1"><span class="section-number-4">8.5.1</span> Constructor, accessors</h4>
<div class="outline-text-4" id="text-8-5-1">
<div class="org-src-container">

<pre class="src src-pascal" id="GRing.methods"><span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Create;
  <span style="color: #00ffff;">begin</span>
    _clasp := GClaspNode&lt;T&gt;.Create;
    _count := 0;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.MakeCursor : IRingCursor&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    result := TCursor.Create( self );
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.GetItem(position: cardinal) : T;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">with</span> MakeCursor <span style="color: #00ffff;">do</span>
      <span style="color: #00ffff;">begin</span>
        MoveTo(position);
        result := value;
      <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.SetItem(position: cardinal; val : T);
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">with</span> MakeCursor <span style="color: #00ffff;">do</span>
      <span style="color: #00ffff;">begin</span>
        MoveTo(position);
        value := val;
      <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>;

<span style="color: #66f;">{ </span><span style="color: #66f;">this allows 'for .. in' in the fpc / delphi compilers </span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.GetEnumerator: IRingCursor&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    result := self.MakeCursor
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-5-2" class="outline-4">
<h4 id="sec-8-5-2"><span class="section-number-4">8.5.2</span> Length, Find, ForEach</h4>
<div class="outline-text-4" id="text-8-5-2">
<div class="org-src-container">

<pre class="src src-pascal" id="GRing.methods"><span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Length : cardinal;
  <span style="color: #ff00ff;">var</span> ln : GNode&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    result := 0;
    ln := _clasp;
    <span style="color: #00ffff;">repeat</span>
      inc( result, ln.Length );
      ln := ln.NextLink;
    <span style="color: #00ffff;">until</span> ln = _clasp;
  <span style="color: #00ffff;">end</span>;


<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Find( pred : GNodePredicate ) : T;
  <span style="color: #ff00ff;">var</span> cur : IRingCursor&lt;T&gt;; found : <span style="color: #ff00ff;">boolean</span> = false;
  <span style="color: #00ffff;">begin</span>
    cur := self.MakeCursor;
    cur.ToTop;
    <span style="color: #00ffff;">repeat</span>
      found := pred( cur.value )
    <span style="color: #00ffff;">until</span> found <span style="color: #00ffff;">or</span> <span style="color: #00ffff;">not</span> cur.MoveNext;
    <span style="color: #00ffff;">if</span> found <span style="color: #00ffff;">then</span> result := cur.value
  <span style="color: #00ffff;">end</span>; <span style="color: #66f;">{ </span><span style="color: #66f;">Find </span><span style="color: #66f;">}</span>

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.ForEach( action : GNodeAction );
  <span style="color: #ff00ff;">var</span> item : T;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">for</span> item <span style="color: #00ffff;">in</span> self <span style="color: #00ffff;">do</span> action( item );
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-5-3" class="outline-4">
<h4 id="sec-8-5-3"><span class="section-number-4">8.5.3</span> Insert / Append (nodes)</h4>
<div class="outline-text-4" id="text-8-5-3">
<div class="org-src-container">

<pre class="src src-pascal" id="GRing.methods"><span style="color: #66f;">{ </span><span style="color: #66f;">Insert : add to the start of the list, right after the clasp </span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Insert( n : GNode&lt;T&gt; );
  <span style="color: #00ffff;">begin</span>
    inc(_count);
    n.PrevLink := _clasp;
    n.NextLink := _clasp.NextLink;
    _clasp.NextLink.PrevLink := n;
    _clasp.NextLink := n;
  <span style="color: #00ffff;">end</span>;

<span style="color: #66f;">{ </span><span style="color: #66f;">Append : add to the end of the list, right before the clasp </span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Append( n : GNode&lt;T&gt; );
  <span style="color: #00ffff;">begin</span>
    inc(_count);
    n.NextLink := _clasp;
    n.PrevLink := _clasp.PrevLink;
    _clasp.PrevLink.NextLink := n;
    _clasp.PrevLink := n;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-5-4" class="outline-4">
<h4 id="sec-8-5-4"><span class="section-number-4">8.5.4</span> Insert / Append (values)</h4>
<div class="outline-text-4" id="text-8-5-4">
<div class="org-src-container">

<pre class="src src-pascal" id="GRing.methods"><span style="color: #66f;">{ </span><span style="color: #66f;">Insert : add to the start of the list, right after the clasp </span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Insert( val : T );
  <span style="color: #00ffff;">begin</span>
    self.Insert(GCellNode&lt;T&gt;.Create( val ));
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.InsertAt( i : cardinal; val : T );
  <span style="color: #ff00ff;">var</span> cur : IRingCursor&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    cur := self.MakeCursor;
    <span style="color: #00ffff;">if</span> i &gt;= Length <span style="color: #00ffff;">then</span> cur.ToEnd
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">while</span> cur.<span style="color: #00ffff;">index</span> &lt; i <span style="color: #00ffff;">do</span> cur.MoveNext;
    cur.InjectNext( val );
  <span style="color: #00ffff;">end</span>; <span style="color: #66f;">{ </span><span style="color: #66f;">InsertAt </span><span style="color: #66f;">}</span>

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.DeleteAt( i : cardinal );
  <span style="color: #ff00ff;">var</span> c : IRingCursor&lt;T&gt;; n : cardinal;
  <span style="color: #00ffff;">begin</span>
    c := self.MakeCursor;
    <span style="color: #00ffff;">if</span> i = 0 <span style="color: #00ffff;">then</span>
      c.DeleteNext
    <span style="color: #00ffff;">else</span>
      <span style="color: #00ffff;">begin</span>
        c.MoveTo(i);
        c.ToTop;
        <span style="color: #00ffff;">for</span> n := 1 <span style="color: #00ffff;">to</span> i <span style="color: #00ffff;">do</span> c.MoveNext;
        c.MovePrev;
        c.DeleteNext;
      <span style="color: #00ffff;">end</span>;
  <span style="color: #00ffff;">end</span>; <span style="color: #66f;">{ </span><span style="color: #66f;">DeleteAt </span><span style="color: #66f;">}</span>

<span style="color: #66f;">{ </span><span style="color: #66f;">Append : add to the end of the list, right before the clasp </span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Append( val : T );
  <span style="color: #00ffff;">begin</span>
    self.Append(GCellNode&lt;T&gt;.Create( val ));
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>


<ol class="org-ol"><li>removing nodes<br  /><div class="outline-text-5" id="text-8-5-4-1">
<div class="org-src-container">

<pre class="src src-pascal" id="GRing.methods"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Remove( val : T );
  <span style="color: #ff00ff;">var</span> c : IRingCursor&lt;T&gt;; found : <span style="color: #ff00ff;">boolean</span> = false;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> <span style="color: #00ffff;">not</span> self.IsEmpty <span style="color: #00ffff;">then</span> pass
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">begin</span>
      c := self.MakeCursor;
      <span style="color: #00ffff;">repeat</span>
        c.MoveNext;
        found := c.value = val;
      <span style="color: #00ffff;">until</span> found <span style="color: #00ffff;">or</span> c.AtEnd;
      <span style="color: #00ffff;">if</span> found <span style="color: #00ffff;">then</span> <span style="color: #00ffff;">begin</span>
        c.MovePrev;
        c.DeleteNext
      <span style="color: #00ffff;">end</span>
    <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>; <span style="color: #66f;">{ </span><span style="color: #66f;">Remove </span><span style="color: #66f;">}</span>

<span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Drop;
    <span style="color: #ff00ff;">var</span> temp : GNode&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> IsEmpty <span style="color: #00ffff;">then</span> <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'attempted to drop from empty list'</span>)
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">begin</span>
      temp := _clasp.PrevLink;
      _clasp.PrevLink := _clasp.PrevLink.PrevLink;
      temp.PrevLink := nil;
      temp.NextLink := nil;
      temp.free;
    <span style="color: #00ffff;">end</span>
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.IsEmpty : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #00ffff;">begin</span> result := _count = 0
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.FindNext(<span style="color: #ff00ff;">const</span> start : GCellNode&lt;T&gt;;
                             <span style="color: #ff00ff;">var</span> p     : GNodeStack;
                             out v     : GCellNode&lt;T&gt;) : <span style="color: #ff00ff;">boolean</span>;
  <span style="color: #ff00ff;">var</span> ln : GNode&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    result := false;
    ln := start;
    <span style="color: #00ffff;">repeat</span>
      <span style="color: #00ffff;">if</span> ( ln <span style="color: #00ffff;">is</span> GCellNode&lt;T&gt; ) <span style="color: #00ffff;">then</span>
        <span style="color: #00ffff;">with</span> ln <span style="color: #00ffff;">as</span> GCellNode&lt;T&gt; <span style="color: #00ffff;">do</span> ln := ln.NextLink;
      <span style="color: #00ffff;">if</span> ( ln <span style="color: #00ffff;">is</span> GRing&lt;T&gt; ) <span style="color: #00ffff;">then</span>
        <span style="color: #00ffff;">with</span> ln <span style="color: #00ffff;">as</span> GRing&lt;T&gt; <span style="color: #00ffff;">do</span> <span style="color: #00ffff;">begin</span>
          p.push( ln );
          <span style="color: #00ffff;">if</span> Length = 0 <span style="color: #00ffff;">then</span> ln := ln.NextLink
          <span style="color: #00ffff;">else</span> ln := _clasp
        <span style="color: #00ffff;">end</span>
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> ln <span style="color: #00ffff;">is</span> GClaspNode&lt;T&gt; <span style="color: #00ffff;">then</span>
        <span style="color: #00ffff;">if</span> p.count &gt; 0 <span style="color: #00ffff;">then</span> ln := p.pop
        <span style="color: #00ffff;">else</span> ln := _clasp
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> ln <span style="color: #00ffff;">is</span> GCellNode&lt;T&gt; <span style="color: #00ffff;">then</span>
        <span style="color: #00ffff;">begin</span>
          result := true;
          v := ln <span style="color: #00ffff;">as</span> GCellNode&lt;T&gt;;
        <span style="color: #00ffff;">end</span>
    <span style="color: #00ffff;">until</span> result <span style="color: #00ffff;">or</span> ( ln = _clasp );
    v := ln <span style="color: #00ffff;">as</span> GCellNode&lt;T&gt;;
  <span style="color: #00ffff;">end</span>;

<span style="color: #66f;">{ </span><span style="color: #66f;">should be exactly the same as above but s/Next/Prev/g </span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.FindPrev(
                   <span style="color: #ff00ff;">const</span> start : GCellNode&lt;T&gt;;
                     <span style="color: #ff00ff;">var</span> p     : GNodeStack;
                     out v     : GCellNode&lt;T&gt; ) : <span style="color: #ff00ff;">boolean</span>;
    <span style="color: #ff00ff;">var</span> ln : GNode&lt;T&gt;;
  <span style="color: #00ffff;">begin</span>
    result := false;
    ln := start;
    <span style="color: #00ffff;">repeat</span>
      ln := ln.PrevLink;
      <span style="color: #00ffff;">if</span> ( ln <span style="color: #00ffff;">is</span> GRing&lt;T&gt; ) <span style="color: #00ffff;">then</span>
        <span style="color: #00ffff;">with</span> (ln <span style="color: #00ffff;">as</span> GRing&lt;T&gt;) <span style="color: #00ffff;">do</span> <span style="color: #00ffff;">begin</span>
          p.push( ln <span style="color: #00ffff;">as</span> GRing&lt;T&gt; );
          <span style="color: #00ffff;">if</span> ( Length = 0 ) <span style="color: #00ffff;">then</span> ln := ln.PrevLink
          <span style="color: #00ffff;">else</span> result := FindPrev(_clasp, p, v )
        <span style="color: #00ffff;">end</span>
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> ln <span style="color: #00ffff;">is</span> GClaspNode&lt;T&gt; <span style="color: #00ffff;">then</span> <span style="color: #00ffff;">begin</span>
        <span style="color: #00ffff;">if</span> p.count &gt; 0 <span style="color: #00ffff;">then</span> ln := p.pop
        <span style="color: #00ffff;">else</span> ln := _clasp
      <span style="color: #00ffff;">end</span>
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> ln <span style="color: #00ffff;">is</span> GCellNode&lt;T&gt; <span style="color: #00ffff;">then</span> <span style="color: #00ffff;">begin</span>
        result := true;
        v := ln <span style="color: #00ffff;">as</span> GCellNode&lt;T&gt;;
      <span style="color: #00ffff;">end</span>
    <span style="color: #00ffff;">until</span> result <span style="color: #00ffff;">or</span> ( ln = _clasp );
    v := ln <span style="color: #00ffff;">as</span> GCellNode&lt;T&gt;;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.FirstCell : GCellNode&lt;T&gt;;
  <span style="color: #ff00ff;">var</span> p : GNodeStack;
  <span style="color: #00ffff;">begin</span>
    p := GNodeStack.Create( kMaxDepth );
    <span style="color: #00ffff;">if</span> self.IsEmpty <span style="color: #00ffff;">then</span>
      <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'empty list has no first member.'</span>)
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #00ffff;">not</span> FindNext( _clasp, p, result ) <span style="color: #00ffff;">then</span>
      <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'nested empty list has no first member.'</span>)
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.First : T;
  <span style="color: #00ffff;">begin</span>
    result := self.FirstCell.value;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.LastCell : GCellNode&lt;T&gt;;
  <span style="color: #ff00ff;">var</span> p : GNodeStack;
  <span style="color: #00ffff;">begin</span>
    p := GNodeStack.Create( kMaxDepth );
    <span style="color: #00ffff;">if</span> IsEmpty <span style="color: #00ffff;">then</span>
      <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'empty list has no last member.'</span>)
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> <span style="color: #00ffff;">not</span> FindPrev( _clasp, p, result ) <span style="color: #00ffff;">then</span>
      <span style="color: #00ffff;">raise</span> Exception.Create(<span style="color: #00ff00;">'nested empty list has no last member.'</span>)
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GRing</span>&lt;T&gt;.Last: T;
  <span style="color: #00ffff;">begin</span>
    result := self.LastCell.value;
  <span style="color: #00ffff;">end</span>; <span style="color: #66f;">{ </span><span style="color: #66f;">Last </span><span style="color: #66f;">}</span>
</pre>
</div>
</div>
</li></ol>
</div>
</div>
<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6"><span class="section-number-3">8.6</span> <code>GElement&lt;T&gt;</code></h3>
<div class="outline-text-3" id="text-8-6">
</div><div id="outline-container-sec-8-6-1" class="outline-4">
<h4 id="sec-8-6-1"><span class="section-number-4">8.6.1</span> constructor</h4>
<div class="outline-text-4" id="text-8-6-1">
<div class="org-src-container">

<pre class="src src-pascal" id="GElement.methods"><span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">GElement</span>&lt;T&gt;.Create;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">inherited</span> Create;
    _attr := TVarDict.Create;
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">GElement</span>&lt;T&gt;.Create( aTag : variant );
  <span style="color: #00ffff;">begin</span>
    self.Create;
    self.tag := aTag;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-6-2" class="outline-4">
<h4 id="sec-8-6-2"><span class="section-number-4">8.6.2</span> tag accesors</h4>
<div class="outline-text-4" id="text-8-6-2">
<div class="org-src-container">

<pre class="src src-pascal" id="GElement.methods"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GElement</span>&lt;T&gt;.SetTag( val: variant );
  <span style="color: #00ffff;">begin</span>
    _tag := val
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GElement</span>&lt;T&gt;.GetTag : variant;
  <span style="color: #00ffff;">begin</span>
    result := _tag
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-6-3" class="outline-4">
<h4 id="sec-8-6-3"><span class="section-number-4">8.6.3</span> attribute accessors</h4>
<div class="outline-text-4" id="text-8-6-3">
<div class="org-src-container">

<pre class="src src-pascal" id="GElement.methods"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">GElement</span>&lt;T&gt;.SetAttr( key : <span style="color: #ff00ff;">string</span>; val: variant );
  <span style="color: #00ffff;">begin</span>
    _attr[ key ] := val
  <span style="color: #00ffff;">end</span>;

<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GElement</span>&lt;T&gt;.GetAttr( key : <span style="color: #ff00ff;">string</span> ) : variant;
  <span style="color: #00ffff;">begin</span>
    result := _attr[ key ]
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
</div>
</div>



<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> OUTPUT <code>rings.pas</code></h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #66f;">{</span><span style="color: #66f;">-- code generated from rings.pas.org --</span><span style="color: #66f;">}</span>

<span style="color: #66f;">{</span><span style="color: #66f;">$mode delphi</span><span style="color: #66f;">}{</span><span style="color: #66f;">$i xpc.inc</span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">unit</span> <span style="color: #ffffff; font-weight: bold;">rings</span>;
<span style="color: #00ffff;">interface</span> <span style="color: #00ffff;">uses</span> xpc, sysutils, stacks, dicts;

  <span style="color: #ff00ff;">const</span> kMaxDepth = 16;
  &lt;&lt;GNode&gt;&gt;
  &lt;&lt;GCellNode&gt;&gt;
  &lt;&lt;GClaspNode&gt;&gt;
  &lt;&lt;IRingCursor&gt;&gt;
  &lt;&lt;GRing&gt;&gt;
  &lt;&lt;GElement&gt;&gt;

<span style="color: #00ffff;">implementation</span>
  &lt;&lt;GNode.methods&gt;&gt;
  &lt;&lt;GCellNode.methods&gt;&gt;
  &lt;&lt;GClaspNode.methods&gt;&gt;
  &lt;&lt;IRingCursor.methods&gt;&gt;
  &lt;&lt;GRing.methods&gt;&gt;
  &lt;&lt;GCursor.methods&gt;&gt;
  &lt;&lt;GElement.methods&gt;&gt;
<span style="color: #00ffff;">initialization</span>
<span style="color: #00ffff;">end</span>.
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
