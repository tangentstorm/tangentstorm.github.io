<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title></title>
<!-- 2013-05-07 Tue 11:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<meta name="author" content="michal"/>
<link rel="stylesheet" type="text/css" href="etc/style.css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title"></h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. block storage</a></li>
<li><a href="#sec-2">2. types and constants</a></li>
<li><a href="#sec-3">3. <code>[1/4]</code> TYPE TRamChain to fetch and store blocks</a>
<ul>
<li><a href="#sec-3-1">3.1. About</a></li>
<li><a href="#sec-3-2">3.2. interface and component types</a></li>
<li><a href="#sec-3-3">3.3. constructor</a></li>
<li><a href="#sec-3-4">3.4. GetItem</a></li>
<li><a href="#sec-3-5">3.5. mark changed blocks as dirty</a></li>
</ul>
</li>
<li><a href="#sec-4">4. <code>[4/5]</code> TYPE TArrayList for storing data inside a TRamChain</a>
<ul>
<li><a href="#sec-4-1">4.1. About</a></li>
<li><a href="#sec-4-2">4.2. TArrayList interface</a></li>
<li><a href="#sec-4-3">4.3. TArrayList.Create</a></li>
<li><a href="#sec-4-4">4.4. TArrayList.locate</a></li>
<li><a href="#sec-4-5">4.5. TArrayList.GetItem</a></li>
<li><a href="#sec-4-6">4.6. TArrayList.SetItem</a></li>
</ul>
</li>
<li><a href="#sec-5">5. The database interface(s)</a></li>
<li><a href="#sec-6">6. block allocation : <code>NextInChain</code> / <code>NextFreeBlock</code></a></li>
<li><a href="#sec-7">7. auto-increments : <code>TNextID</code></a></li>
<li><a href="#sec-8">8. text storage</a></li>
<li><a href="#sec-9">9. text lookup</a></li>
<li><a href="#sec-10">10. triple store : extract a module from <code>bp.pas</code></a></li>
<li><a href="#sec-11">11. tuple lookup</a></li>
<li><a href="#sec-12">12. grab the hash method from di.pas</a></li>
<li><a href="#sec-13">13. format of the first block (metadata)</a></li>
<li><a href="#sec-14">14. store/fetch strings</a></li>
<li><a href="#sec-15">15. store/fetch arrays</a></li>
<li><a href="#sec-16">16. store/fetch tuples</a></li>
<li><a href="#sec-17">17. store/fetch edges</a></li>
<li><a href="#sec-18">18. store/fetch nodes</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> block storage</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>tdrive/tblock: <code>sd.pas</code> / <code>sd_fpc.inc</code> / <code>test_sd.pas</code>
</li>
<li><a href="file:///home/michal/go/bed.pas">file:///home/michal/go/bed.pas</a> shows the usage
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> types and constants</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #ff00ff;">const</span>
  kBlockSize = 1024; <span style="color: #66f;">// </span><span style="color: #66f;">bytes</span>
<span style="color: #ff00ff;">type</span>
  TArray = <span style="color: #ff00ff;">array</span> <span style="color: #00ffff;">of</span> int32;
  tuple = <span style="color: #ff00ff;">array</span> <span style="color: #00ffff;">of</span> variant;
  TBlockID = cardinal;
  TStringID = cardinal;
  TTupleID = cardinal;
  TNodeID = cardinal;
  TEdgeID = TTupleID;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> <code>[1/4]</code> TYPE TRamChain to fetch and store blocks</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> About</h3>
<div class="outline-text-3" id="text-3-1">
<p>
In storing our database, we have a couple of goals that at first glance might seem to be in conflict:
</p>

<ul class="org-ul">
<li>We want to keep the database small and tightly packed.
</li>
<li>We want tables to have room to grow.
</li>
</ul>

<p>
Chains resolve the conflict by allowing is to break tables into chunks.
</p>

<p>
<code>TRamChain</code> is essentially a linked list of block handles. The individual blocks are only loaded into ram when they are actually used.
</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> <span class="done DONE">DONE</span> interface and component types</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #ff00ff;">type</span>
  TRamChain  = <span style="color: #ff00ff;">class</span>
    <span style="color: #00ffff;">private</span> <span style="color: #ff00ff;">type</span>
      TRamState  = ( rsStub, rsLoaded, rsChanged );
      TRamBlock  = <span style="color: #ff00ff;">record</span>
        ID    : sd.TBlockID;
        block : sd.TBlock;
        state : TRamState;
      <span style="color: #00ffff;">end</span>;
      TRamBlocks = specialize li.list&lt;TRamBlock&gt;;
    <span style="color: #00ffff;">public</span>
      <span style="color: #00ffff;">constructor</span> <span style="color: #ffffff; font-weight: bold;">Create</span>( );
      <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetItem</span>( ix : cardinal ) : TBlock;
      <span style="color: #00ffff;">property</span> item[ ix : cardinal ] : TBlock <span style="color: #00ffff;">read</span> GetItem <span style="color: #00ffff;">default</span>;
    <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> <span class="todo TODO">TODO</span> constructor</h3>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> <span class="todo TODO">TODO</span> GetItem</h3>
</div>
<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> <span class="todo TODO">TODO</span> mark changed blocks as dirty</h3>
<div class="outline-text-3" id="text-3-5">
<pre class="example">
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> <code>[4/5]</code> TYPE TArrayList for storing data inside a TRamChain</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> About</h3>
<div class="outline-text-3" id="text-4-1">
<p>
It seems like we ought to have a type that would represent strings in-block.
Perhaps even something that would represent arbitrary data structures as they were spread out over a linked list. Something like an ArrayList in java.
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> <span class="done DONE">DONE</span> TArrayList interface</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #ff00ff;">type</span>
  TAddress : <span style="color: #ff00ff;">record</span>
               blockID : TBlockID;
               offset  : cardinal;
             <span style="color: #00ffff;">end</span>;
  TBlocks : <span style="color: #ff00ff;">array</span> <span style="color: #00ffff;">of</span> <span style="color: #ff00ff;">integer</span>;
  generic TArrayList&lt;T&gt; = <span style="color: #ff00ff;">class</span>
   <span style="color: #00ffff;">private</span>
    _chain     : TRamChain;
    _count     : cardinal;  <span style="color: #66f;">{ </span><span style="color: #66f;">total number of &lt;T&gt; items </span><span style="color: #66f;">}</span>
    _headCount : cardinal;  <span style="color: #66f;">{ </span><span style="color: #66f;">number of &lt;T&gt; in the first block (may start partway in) </span><span style="color: #66f;">}</span>
    _address   : TAddress;  <span style="color: #66f;">{ </span><span style="color: #66f;">start address of the list </span><span style="color: #66f;">}</span>
    _perBlock  : cardinal;  <span style="color: #66f;">{ </span><span style="color: #66f;">sizeof(T)/sizeof(block) </span><span style="color: #66f;">}</span>
    _blocks    : TBlocks;   <span style="color: #66f;">{ </span><span style="color: #66f;">_blocks[0] = _address.blockID </span><span style="color: #66f;">}</span>
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">locate</span>( ix : cardinal ) : TAddress;
   <span style="color: #00ffff;">public</span>
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">Create</span>( chain : TRamChain );
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetItem</span>( ix : cardinal ) : T;
    <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">SetItem</span>( ix : cardinal; val : T );
    <span style="color: #00ffff;">property</span> item[ ix : cardinal ] : T <span style="color: #00ffff;">read</span> GetItem <span style="color: #00ffff;">write</span> SetItem; <span style="color: #00ffff;">default</span>;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> <span class="todo TODO">TODO</span> TArrayList.Create</h3>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> <span class="done DONE">DONE</span> TArrayList.locate</h3>
<div class="outline-text-3" id="text-4-4">
<p>
This calculates the location of a particular entry within the list and returns a reference.
</p>
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">TArrayList.locate</span>( ix : cardinal ) : TAddress;
  <span style="color: #00ffff;">begin</span>
    <span style="color: #00ffff;">if</span> ix &gt;= _count <span style="color: #00ffff;">then</span> <span style="color: #00ffff;">raise</span> ERangeCheckError.Create(<span style="color: #00ff00;">'out of bounds'</span>);
    <span style="color: #00ffff;">if</span> ix &lt; _headCount <span style="color: #00ffff;">then</span>
      <span style="color: #00ffff;">begin</span>
        result.blockID := _address.blockID;
        result.offset  := _address.offset + ix * sizeOf(T);
      <span style="color: #00ffff;">end</span>
    <span style="color: #00ffff;">else</span>
      DivMod( ix - _headCount, _perBlock, result.blockID, result.offset );
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> <span class="done DONE">DONE</span> TArrayList.GetItem</h3>
<div class="outline-text-3" id="text-4-5">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">GetItem</span>( ix : cardinal ) : T;
  <span style="color: #00ffff;">begin</span>
    move(_chain[self.locate(ix)]^, result, sizeof(T));
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> <span class="done DONE">DONE</span> TArrayList.SetItem</h3>
<div class="outline-text-3" id="text-4-6">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">SetItem</span>( ix : cardinal; val : T );
  <span style="color: #00ffff;">begin</span>
    move(val, _chain[self.locate(ix)]^, sizeof(T));
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> The database interface(s)</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #ff00ff;">type</span>
  IDataStore = <span style="color: #00ffff;">interface</span>
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">StoreString</span>( <span style="color: #ff00ff;">const</span> s : <span style="color: #ff00ff;">string</span> ) : TTupleID;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FetchString</span>( <span style="color: #ff00ff;">const</span> i : TStringID ) : <span style="color: #ff00ff;">string</span>;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">StoreArray</span>( <span style="color: #ff00ff;">const</span> s : <span style="color: #ff00ff;">string</span> ) : TTArrayID;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FetchArray</span>( <span style="color: #ff00ff;">const</span> i : TTArrayID ) : TArray;
  <span style="color: #00ffff;">end</span>;
  IRelStore = <span style="color: #00ffff;">interface</span>
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">StoreTuple</span>( <span style="color: #ff00ff;">const</span> r : TRelation; <span style="color: #ff00ff;">const</span> t : TTuple ) : TTupleID;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FetchTuple</span>( <span style="color: #ff00ff;">const</span> r : TRelation; <span style="color: #ff00ff;">const</span> i : TTupleID ) : TTuple;
  <span style="color: #00ffff;">end</span>;
  IGraphStore = <span style="color: #00ffff;">interface</span>
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">StoreEdge</span>( <span style="color: #ff00ff;">const</span> e : TEdge ) : TEID;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FetchEdge</span>( <span style="color: #ff00ff;">const</span> i : TEID ) : TEdge;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">StoreNode</span>( <span style="color: #ff00ff;">const</span> n : TNode ) : TNID;
    <span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">FetchNode</span>( <span style="color: #ff00ff;">const</span> i : TNID ) : TNode;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> <span class="todo TODO">TODO</span> block allocation : <code>NextInChain</code> / <code>NextFreeBlock</code></h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">NextInChain</span>( block : TBlockID ) : TBlockID;
  <span style="color: #00ffff;">begin</span>
    todo;
    result := 0
  <span style="color: #00ffff;">end</span>;
<span style="color: #00ffff;">function</span> <span style="color: #ffffff; font-weight: bold;">NextFreeBLock</span> : TBlockID;
  <span style="color: #00ffff;">begin</span>
    todo;
    result := 0
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> <span class="todo TODO">TODO</span> auto-increments : <code>TNextID</code></h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-delphi"><span style="color: #00ffff;">function</span> TNextID( tableID  );
  begin
    todo
  end;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> text storage</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-delphi">type
  TTextMeta = record
    ID     : TNID;
    prefix : array[ 0 .. 3 ] of char;
    start  : Int32;
    hash   : Int32;
  end;
procedure StoreText( txt : string );
  var meta : TTextMeta;
  begin
    MakeTextMeta( txt, meta )
  end;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> text lookup</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">FindText</span>( key : TNid );
  <span style="color: #ff00ff;">var</span> start, blocks, offs : int32;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">findTheStartBlock</span>;
    <span style="color: #00ffff;">begin</span>
      startAddr := bptree.lookup( key );
      DivMod( startAddr, pageSize, startPage, offset );
    <span style="color: #00ffff;">end</span>;
  <span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">calcNumberOfBlocks</span>;
    <span style="color: #00ffff;">begin</span>
      firstChunk := pageSize - offset;
      DivMod( strLen - firstChunk, pageSize, numBlocks, lastChunk );
    <span style="color: #00ffff;">end</span>;
  <span style="color: #00ffff;">begin</span>
    findTheStartBlock( key );
    calcNumberOfBlocks;
  <span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> triple store : extract a module from <code>bp.pas</code></h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li><a href="bplus.html">bplus.html</a> already has the basics
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> tuple lookup</h2>
<div class="outline-text-2" id="text-11">
<p>
Hopefully, rows are pretty small so there isn't really much wasted space. A block size with a lot of different prime factors would probably help things fit.
</p>

<div class="org-src-container">

<pre class="src src-pascal"><span style="color: #00ffff;">procedure</span> <span style="color: #ffffff; font-weight: bold;">FindBlockForTuple</span>;
<span style="color: #00ffff;">begin</span>
  DivMod(rowSize, blockSize, rowsPerBlock, extraSpace);
  DivMod(rowsPerBlock, rowToFind, result, plusRows);
  <span style="color: #00ffff;">if</span> plusRows &gt; 0 <span style="color: #00ffff;">then</span> inc(result);
  <span style="color: #66f;">{ </span><span style="color: #66f;">then just follow the chain for that many blocks </span><span style="color: #66f;">}</span>
<span style="color: #00ffff;">end</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> <span class="todo TODO">TODO</span> grab the hash method from di.pas</h2>
</div>
<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> <span class="todo TODO">TODO</span> format of the first block (metadata)</h2>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> <span class="todo TODO">TODO</span> store/fetch strings</h2>
</div>
<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> <span class="todo TODO">TODO</span> store/fetch arrays</h2>
</div>
<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> <span class="todo TODO">TODO</span> store/fetch tuples</h2>
</div>
<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> <span class="todo TODO">TODO</span> store/fetch edges</h2>
</div>
<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18"><span class="section-number-2">18</span> <span class="todo TODO">TODO</span> store/fetch nodes</h2>
</div>
</div>
</body>
</html>
