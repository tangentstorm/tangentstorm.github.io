<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>wejal bootstrap</title>
<!-- 2015-01-18 Sun 10:47 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="michal wallace" />
<link rel="stylesheet" type="text/css" href="/etc/style.css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">wejal bootstrap</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Strategy</a></li>
<li><a href="#sec-2">2. Some data types for modeling grammar definitions.</a></li>
<li><a href="#sec-3">3. Manually build a base grammar to provide generic tokenization.</a></li>
<li><a href="#sec-4">4. Now define the bootstrap grammar to parse EBNF grammar definitions.</a></li>
</ul>
</div>
</div>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a id="nrogjy71jqg0" name="nrogjy71jqg0"></a><span class="section-number-2">1</span> Strategy</h2>
<div class="outline-text-2" id="text-1">

<p>
The idea here is to manually construct an a data structure (an abstract syntax tree) that describes a meta-grammar.
</p>

<p>
The meta-grammar describes whatever nice clean syntax we'd <i>like</i> to use for creating grammars in the future.
</p>

<p>
Building these trees by hand can get messy, though, so we'll stick with a simple syntax for this first round, and then use <i>that</i> to implement something better later.
</p>

<p>
Our first step is to define some types that we can use to tag the different parts of the tree. Each type represents the some feature of our pattern matching system.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a id="9906u111jqg0" name="9906u111jqg0"></a><span class="section-number-2">2</span> Some data types for modeling grammar definitions.</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #00ffff;">from</span> collections <span style="color: #00ffff;">import</span> namedtuple

<span style="color: #00ffff;">def</span> <span style="color: #ffffff; font-weight: bold;">T</span>(tag, doc=<span style="color: #00ff00;">''</span>, args=[<span style="color: #00ff00;">'data'</span>]):
    <span style="color: #00ff00;">"""Creates a new tuple type."""</span>
    <span style="color: #eedd82;">res</span> = namedtuple(tag, args)
    <span style="color: #00ffff;">if</span> doc: res.<span style="color: #ff00ff; font-weight: bold;">__doc__</span>+=<span style="color: #00ff00;">' : '</span>+doc
    <span style="color: #00ffff;">return</span> res

<span style="color: #eedd82;">Gram</span> = T(<span style="color: #00ff00;">'Gram'</span>, <span style="color: #00ff00;">'contains grammar rules (may inherit from `base`).'</span>,
         [<span style="color: #00ff00;">'name'</span>, <span style="color: #00ff00;">'base'</span>, <span style="color: #00ff00;">'doc'</span>, <span style="color: #00ff00;">'defs'</span>])
<span style="color: #eedd82;">Def</span> = T(<span style="color: #00ff00;">'Def'</span>, <span style="color: #00ff00;">'define a named rule.'</span>, [<span style="color: #00ff00;">'name'</span>,<span style="color: #00ff00;">'data'</span>])
<span style="color: #eedd82;">Ref</span> = T(<span style="color: #00ff00;">'Ref'</span>, <span style="color: #00ff00;">'refer to (invoke) a named rule'</span>)

<span style="color: #eedd82;">Any</span> = T(<span style="color: #00ff00;">'Any'</span>, <span style="color: #00ff00;">'match anything'</span>, [])
<span style="color: #eedd82;">Not</span> = T(<span style="color: #00ff00;">'Not'</span>, <span style="color: #00ff00;">'fail if the pattern would match, but do not consume'</span>)
<span style="color: #eedd82;">Skip</span> = T(<span style="color: #00ff00;">'Skip'</span>, <span style="color: #00ff00;">'match the pattern, but hide it from other rules'</span>)

<span style="color: #eedd82;">Lit</span> = T(<span style="color: #00ff00;">'Lit'</span>, <span style="color: #00ff00;">'match literal item (using ==)'</span>)
<span style="color: #eedd82;">Seq</span> = T(<span style="color: #00ff00;">'Seq'</span>, <span style="color: #00ff00;">'match a sequence of patterns'</span>)
<span style="color: #eedd82;">Grp</span> = T(<span style="color: #00ff00;">'Grp'</span>, <span style="color: #00ff00;">'same as Seq, but renders in parentheses'</span>)
<span style="color: #eedd82;">Alt</span> = T(<span style="color: #00ff00;">'Alt'</span>, <span style="color: #00ff00;">'match any of the alternatives'</span>)
<span style="color: #eedd82;">Rep</span> = T(<span style="color: #00ff00;">'Rep'</span>, <span style="color: #00ff00;">'match 1 or more repetitions.'</span>)
<span style="color: #eedd82;">Opt</span> = T(<span style="color: #00ff00;">'Opt'</span>, <span style="color: #00ff00;">'match 0 or 1 repetitions.'</span>)
<span style="color: #eedd82;">Orp</span> = T(<span style="color: #00ff00;">'Orp'</span>, <span style="color: #00ff00;">'match 0 or more repetitions.'</span>)

<span style="color: #eedd82;">Var</span> = T(<span style="color: #00ff00;">'Var'</span>, <span style="color: #00ff00;">'save matched string in a variable.'</span>, [<span style="color: #00ff00;">'name'</span>,<span style="color: #00ff00;">'data'</span>])
<span style="color: #eedd82;">Val</span> = T(<span style="color: #00ff00;">'Val'</span>, <span style="color: #00ff00;">'match against the saved value.'</span>, [<span style="color: #00ff00;">'name'</span>])
<span style="color: #eedd82;">New</span> = T(<span style="color: #00ff00;">'New'</span>, <span style="color: #00ff00;">'build a new class/tuple instance'</span>, [<span style="color: #00ff00;">'Class'</span>, <span style="color: #00ff00;">'data'</span>])
<span style="color: #eedd82;">Arg</span> = T(<span style="color: #00ff00;">'Arg'</span>, <span style="color: #00ff00;">'pass matched data as arg to containing "New"'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><a id="9d0f2971jqg0" name="9d0f2971jqg0"></a><span class="section-number-2">3</span> Manually build a base grammar to provide generic tokenization.</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #00ffff;">import</span> string
</pre>
</div>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #eedd82;">ECHR</span>, <span style="color: #eedd82;">SQ</span>, <span style="color: #eedd82;">DQ</span> = [<span style="color: #00ff00;">'\\'</span>, <span style="color: #00ff00;">"'"</span>, <span style="color: #00ff00;">'"'</span>]
<span style="color: #eedd82;">base</span> = Gram(<span style="color: #00ff00;">'ebnf'</span>, [], <span style="color: #00ff00;">"rules common to all grammars"</span>, [
    Def(<span style="color: #00ff00;">'main'</span>, Orp(<span style="color: #00ff00;">'token'</span>)),
    Def(<span style="color: #00ff00;">'token'</span>, [Skip(Orp(Ref(<span style="color: #00ff00;">'space'</span>))),
                  Alt([Ref(<span style="color: #00ff00;">'STRING'</span>), Ref(<span style="color: #00ff00;">'NUMBER'</span>),
                       Ref(<span style="color: #00ff00;">'IDENT'</span>), Ref(<span style="color: #00ff00;">'DELIM'</span>),
                       Rep(Not(Ref(<span style="color: #00ff00;">'space'</span>)))])]),
    Def(<span style="color: #00ff00;">'space'</span>, Orp(<span style="color: #00ff00;">'White'</span>)),
    <span style="color: #66f;"># </span><span style="color: #66f;">character classes:</span>
    Def(<span style="color: #00ff00;">'White'</span>, Alt([<span style="color: #ff00ff; font-weight: bold;">chr</span>(c) <span style="color: #00ffff;">for</span> c <span style="color: #00ffff;">in</span> <span style="color: #ff00ff; font-weight: bold;">range</span>(33)])),
    Def(<span style="color: #00ff00;">'Upper'</span>, Alt(<span style="color: #ff00ff; font-weight: bold;">list</span>(string.ascii_uppercase))),
    Def(<span style="color: #00ff00;">'Lower'</span>, Alt(<span style="color: #ff00ff; font-weight: bold;">list</span>(string.ascii_lowercase))),
    Def(<span style="color: #00ff00;">'Alpha'</span>, Alt([Ref(<span style="color: #00ff00;">'Lower'</span>), Ref(<span style="color: #00ff00;">'Upper'</span>)])),
    Def(<span style="color: #00ff00;">'Under'</span>, Lit(<span style="color: #00ff00;">'_'</span>)),
    Def(<span style="color: #00ff00;">'Neg'</span>, Lit(<span style="color: #00ff00;">'-'</span>)),
    Def(<span style="color: #00ff00;">'Digit'</span>, Alt([Lit(c) <span style="color: #00ffff;">for</span> c <span style="color: #00ffff;">in</span> string.digits])),
    Def(<span style="color: #00ff00;">'Hexit'</span>, Alt([Ref(<span style="color: #00ff00;">'Digit'</span>)]+[Lit(c) <span style="color: #00ffff;">for</span> c <span style="color: #00ffff;">in</span> <span style="color: #00ff00;">'abcdefABCDEF'</span>])),
    Def(<span style="color: #00ff00;">'Alnum'</span>, Alt([Ref(<span style="color: #00ff00;">'Under'</span>), Ref(<span style="color: #00ff00;">'Alpha'</span>), Ref(<span style="color: #00ff00;">'Digit'</span>)])),
    <span style="color: #66f;"># </span><span style="color: #66f;">simple patterns:</span>
    Def(<span style="color: #00ff00;">'IDENT'</span>, [Alt([Ref(<span style="color: #00ff00;">'Under'</span>),Ref(<span style="color: #00ff00;">'Alpha'</span>)]), Orp(Ref(<span style="color: #00ff00;">'Alnum'</span>))]),
    Def(<span style="color: #00ff00;">'NUMBER'</span>, [Opt(Ref(<span style="color: #00ff00;">'Neg'</span>)), Rep(Ref(<span style="color: #00ff00;">'Digit'</span>)),
                   Orp([Ref(<span style="color: #00ff00;">'Under'</span>),
                        Ref(<span style="color: #00ff00;">'Digit'</span>),Ref(<span style="color: #00ff00;">'Digit'</span>),Ref(<span style="color: #00ff00;">'Digit'</span>)])]),
    Def(<span style="color: #00ff00;">'STRING'</span>, Alt([ [Lit(DQ), Rep(Ref(<span style="color: #00ff00;">'STRCHR'</span>)), Lit(DQ)]])),
    Def(<span style="color: #00ff00;">'STRCHR'</span>, Alt([ [Lit(ECHR), Alt([ Lit(ECHR), Lit(DQ) ])],
                        Not(DQ) ])),
    Def(<span style="color: #00ff00;">'DELIM'</span>, Alt(<span style="color: #ff00ff; font-weight: bold;">list</span>(<span style="color: #00ff00;">'(){}[]'</span>))),
])
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><a id="7o9j7i21jqg0" name="7o9j7i21jqg0"></a><span class="section-number-2">4</span> Now define the bootstrap grammar to parse EBNF grammar definitions.</h2>
<div class="outline-text-2" id="text-4">

<div class="org-src-container">

<pre class="src src-python"><span style="color: #eedd82;">ebnf</span> = Gram(<span style="color: #00ff00;">'ebnf'</span>, [base], <span style="color: #00ff00;">"ebnf meta-grammar (for parsing grammars)"</span>, [
    Def(<span style="color: #00ff00;">'main'</span>, Orp(Ref(<span style="color: #00ff00;">'rule'</span>))),
    Def(<span style="color: #00ff00;">'rule'</span>, Seq([Var(<span style="color: #00ff00;">'name'</span>, Ref(<span style="color: #00ff00;">'IDENT'</span>)),
                     Lit(<span style="color: #00ff00;">'='</span>), Ref(<span style="color: #00ff00;">'expr'</span>), Lit(<span style="color: #00ff00;">'.'</span>) ])),
    Def(<span style="color: #00ff00;">'expr'</span>, [ Ref(<span style="color: #00ff00;">'term'</span>), Orp([Lit(<span style="color: #00ff00;">'|'</span>), Ref(<span style="color: #00ff00;">'term'</span>) ]) ]),
    Def(<span style="color: #00ff00;">'term'</span>, Rep(Ref(<span style="color: #00ff00;">'factor'</span>))),
    Def(<span style="color: #00ff00;">'factor'</span>, Alt([Ref(<span style="color: #00ff00;">'IDENT'</span>), Ref(<span style="color: #00ff00;">'STRING'</span>),
                       Ref(<span style="color: #00ff00;">'rep'</span>), Ref(<span style="color: #00ff00;">'opt'</span>), Ref(<span style="color: #00ff00;">'grp'</span>)])),
    Def(<span style="color: #00ff00;">'rep'</span>, [<span style="color: #00ff00;">'{'</span>, New(Rep, Ref(<span style="color: #00ff00;">'expr'</span>)), <span style="color: #00ff00;">'}'</span>]),  <span style="color: #66f;"># </span><span style="color: #66f;">'x*'</span>
    Def(<span style="color: #00ff00;">'opt'</span>, [<span style="color: #00ff00;">'['</span>, New(Opt, Ref(<span style="color: #00ff00;">'expr'</span>)), <span style="color: #00ff00;">']'</span>]),  <span style="color: #66f;"># </span><span style="color: #66f;">'x?'</span>
    Def(<span style="color: #00ff00;">'grp'</span>, [<span style="color: #00ff00;">'('</span>, New(Grp, Ref(<span style="color: #00ff00;">'expr'</span>)), <span style="color: #00ff00;">')'</span>]),  <span style="color: #66f;"># </span><span style="color: #66f;">'(x)'</span>
])
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
